<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Teamz Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics on modals */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Slate-400 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2">

    <!-- Team Details Modal -->
    <div id="team-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300"
        onclick="if(event.target.id === 'team-modal') closeTeamModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm relative transform transition-all duration-300 scale-100 opacity-100">
            <!-- Close Button -->
            <button onclick="closeTeamModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 transition focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Modal Content -->
            <div id="modal-content" class="text-center space-y-4 pt-4 custom-scrollbar max-h-[80vh] overflow-y-auto">
                <!-- Content will be populated by JS -->
            </div>
        </div>
    </div>
    <!-- End Team Details Modal -->

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-6xl">

        <!-- Dashboard Screen (State 1 - Now Default) -->
        <div id="logged-in-screen" class="hidden bg-white p-8 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-6">NFL Teamz Week 6</h2>
            
            <!-- Pick Teams Button -->
            <button id="pick-teams-btn" onclick="goToPickScreen()"
                    class="bg-green-500 text-white py-2 px-8 rounded-lg font-bold hover:bg-green-600 transition duration-200 shadow-md mb-8">
                Pick my teams
            </button>

            <div id="user-table-container">
                <!-- Table will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- Pick Teams Screen (State 2) -->
        <div id="pick-teams-screen" class="hidden bg-white p-4 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <!-- Header Text -->
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Pick your 6 teams</h2>
            
            <!-- Notification Message (for max picks or budget exceeded) -->
            <div id="notification-message" class="text-red-600 bg-red-100 p-2 rounded-lg mb-4 hidden transition duration-300 text-sm font-semibold max-w-sm mx-auto">
                Maximum 6 teams picked. Please unpick a team first.
            </div>

            <!-- Fixtures Container (Content) - pb-32 adds space for the sticky bar -->
            <div id="fixtures-container" class="space-y-4 mt-6 pb-32">
                <!-- Fixtures will be rendered here by JavaScript -->
            </div>
            
            <!-- STICKY BOTTOM BAR CONTAINER -->
            <div id="picked-teams-bar" class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white py-3 px-2 shadow-2xl z-10 border-t-4 border-indigo-600">
                <!-- Content added via JS -->
            </div>

        </div>
        
        <!-- Summary Screen (State 3) -->
        <div id="summary-screen" class="hidden bg-white p-8 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Your picks</h2>
            
            <div class="text-lg font-bold text-red-600 bg-red-50 p-3 rounded-lg mb-8 max-w-sm mx-auto">
                Take a screenshot and send to Stu!
            </div>

            <div id="summary-container" class="mb-8">
                <!-- Pick summary will be rendered here -->
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="goToDashboardScreen()" id="summary-back-btn"
                        class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                    Back to Dashboard
                </button>
                <button onclick="window.location.reload()" 
                        class="bg-gray-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                    Reset Picks
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. User Database (CSV) - Simplified to just Name and Picks ---
        // Headers: name,Teamz1,Teamz2,Teamz3,Teamz4,Teamz5,Teamz6
        const CSV_DATA = 
            `name,Teamz1,Teamz2,Teamz3,Teamz4,Teamz5,Teamz6
Stu,true,true,true,true,true,true
Admin,true,true,true,true,true,true
Tester,true,true,true,true,true,true
Dave,true,true,true,true,true,true
Kat,true,true,true,true,true,true
Rich,true,true,true,true,true,true
Fernando,true,true,true,true,true,true`;

        // --- 2. Simulated Teams Database (CSV) ---
        // Dallas (5.5) and Miami (4.5) updated for decimal testing
        // Headers: team,abbr,opponent,points,record,image,rating,details
        // DETAILS format: Outcome=X;Touchdowns=Y;...
        const TEAMS_CSV_DATA = 
            `team,abbr,opponent,points,record,image,rating,details
Arizona Cardinals,ARI,San Francisco 49ers,18,3-6,images/ARI.png,2,Outcome=win;Touchdowns=3;Receiving=323 yards;Rushing=110 yards;Turnovers=1;Touchdowns conceded=2;FGs over 45y=1
Atlanta Falcons,ATL,Carolina Panthers,25,3-6,images/ATL.png,1.5,Outcome=loss;Touchdowns=2;Receiving=288 yards;Rushing=134 yards;Turnovers=2;Touchdowns conceded=3;FGs over 45y=0
Baltimore Ravens,BAL,Cleveland Browns,31,5-4,images/BAL.png,3,Outcome=win;Touchdowns=5;Receiving=350 yards;Rushing=150 yards;Turnovers=0;Touchdowns conceded=4;FGs over 45y=2
Buffalo Bills,BUF,Tampa Bay Buccaneers,22,6-3,images/BUF.png,4,Outcome=tie;Touchdowns=3;Receiving=305 yards;Rushing=100 yards;Turnovers=1;Touchdowns conceded=3;FGs over 45y=1
Carolina Panthers,CAR,Atlanta Falcons,10,6-3,images/CAR.png,1.5,Outcome=loss;Touchdowns=1;Receiving=200 yards;Rushing=80 yards;Turnovers=3;Touchdowns conceded=5;FGs over 45y=0
Chicago Bears,CHI,Minnesota Vikings,15,6-3,images/CHI.png,2.5,Outcome=win;Touchdowns=4;Receiving=260 yards;Rushing=120 yards;Turnovers=1;Touchdowns conceded=3;FGs over 45y=1
Cincinnati Bengals,CIN,Pittsburgh Steelers,24,3-6,images/CIN.png,0.5,Outcome=win;Touchdowns=4;Receiving=330 yards;Rushing=95 yards;Turnovers=0;Touchdowns conceded=3;FGs over 45y=2
Cleveland Browns,CLE,Baltimore Ravens,12,2-7,images/CLE.png,0.5,Outcome=win;Touchdowns=2;Receiving=210 yards;Rushing=145 yards;Turnovers=1;Touchdowns conceded=1;FGs over 45y=1
Dallas Cowboys,DAL,Las Vegas Raiders,30,3-5,images/DAL.png,2,Outcome=win;Touchdowns=5;Receiving=400 yards;Rushing=160 yards;Turnovers=0;Touchdowns conceded=1;FGs over 45y=1
Denver Broncos,DEN,Kansas City Chiefs,16,8-2,images/DEN.png,4,Outcome=loss;Touchdowns=1;Receiving=180 yards;Rushing=75 yards;Turnovers=2;Touchdowns conceded=3;FGs over 45y=0
Detroit Lions,DET,Philadelphia Eagles,28,6-3,images/DET.png,4.5,Outcome=win;Touchdowns=3;Receiving=315 yards;Rushing=130 yards;Turnovers=1;Touchdowns conceded=3;FGs over 45y=1
Green Bay Packers,GB,New York Giants,20,5-3,images/GB.png,3.5,Outcome=loss;Touchdowns=3;Receiving=290 yards;Rushing=115 yards;Turnovers=2;Touchdowns conceded=4;FGs over 45y=0
Houston Texans,HOU,Tennessee Titans,27,4-5,images/HOU.png,4,Outcome=win;Touchdowns=4;Receiving=340 yards;Rushing=105 yards;Turnovers=1;Touchdowns conceded=3;FGs over 45y=1
Jacksonville Jaguars,JAX,Los Angeles Chargers,21,5-4,images/JAC.png,2,Outcome=loss;Touchdowns=2;Receiving=275 yards;Rushing=85 yards;Turnovers=3;Touchdowns conceded=3;FGs over 45y=0
Kansas City Chiefs,KC,Denver Broncos,35,5-4,images/KC.png,4.5,Outcome=win;Touchdowns=5;Receiving=380 yards;Rushing=170 yards;Turnovers=0;Touchdowns conceded=2;FGs over 45y=1
Las Vegas Raiders,LV,Dallas Cowboys,14,2-7,images/LV.png,0.5,Outcome=win;Touchdowns=2;Receiving=245 yards;Rushing=125 yards;Turnovers=1;Touchdowns conceded=1;FGs over 45y=2
Los Angeles Chargers,LAC,Jacksonville Jaguars,23,7-3,images/LAC.png,3.5,Outcome=loss;Touchdowns=2;Receiving=310 yards;Rushing=90 yards;Turnovers=2;Touchdowns conceded=3;FGs over 45y=1
Los Angeles Rams,LAR,Seattle Seahawks,29,7-2,images/LAR.png,5,Outcome=win;Touchdowns=3;Receiving=300 yards;Rushing=115 yards;Turnovers=1;Touchdowns conceded=3;FGs over 45y=1
Miami Dolphins,MIA,Washington Commanders,33,3-7,images/MIA.png,1,Outcome=win;Touchdowns=6;Receiving=450 yards;Rushing=180 yards;Turnovers=0;Touchdowns conceded=2;FGs over 45y=0
Minnesota Vikings,MIN,Chicago Bears,17,4-5,images/MIN.png,2.5,Outcome=tie;Touchdowns=3;Receiving=290 yards;Rushing=100 yards;Turnovers=1;Touchdowns conceded=3;FGs over 45y=1
New England Patriots,NE,New York Jets,13,8-2,images/NE.png,4.5,Outcome=loss;Touchdowns=1;Receiving=150 yards;Rushing=60 yards;Turnovers=3;Touchdowns conceded=4;FGs over 45y=0
New York Giants,NYG,Green Bay Packers,11,2-8,images/NYG.png,1,Outcome=loss;Touchdowns=2;Receiving=220 yards;Rushing=70 yards;Turnovers=3;Touchdowns conceded=4;FGs over 45y=0
New York Jets,NYJ,New England Patriots,10,2-7,images/NYJ.png,1.5,Outcome=loss;Touchdowns=1;Receiving=205 yards;Rushing=95 yards;Turnovers=2;Touchdowns conceded=2;FGs over 45y=1
Philadelphia Eagles,PHI,Detroit Lions,34,7-2,images/PHI.png,3.5,Outcome=win;Touchdowns=4;Receiving=370 yards;Rushing=155 yards;Turnovers=0;Touchdowns conceded=4;FGs over 45y=1
Pittsburgh Steelers,PIT,Cincinnati Bengals,18,5-4,images/PIT.png,3,Outcome=win;Touchdowns=3;Receiving=255 yards;Rushing=135 yards;Turnovers=1;Touchdowns conceded=1;FGs over 45y=2
San Francisco 49ers,SF,Arizona Cardinals,32,6-4,images/SF.png,2.5,Outcome=win;Touchdowns=4;Receiving=360 yards;Rushing=140 yards;Turnovers=0;Touchdowns conceded=2;FGs over 45y=1
Seattle Seahawks,SEA,Los Angeles Rams,25,7-2,images/SEA.png,5,Outcome=win;Touchdowns=3;Receiving=270 yards;Rushing=120 yards;Turnovers=1;Touchdowns conceded=2;FGs over 45y=1
Tampa Bay Buccaneers,TB,Buffalo Bills,19,6-3,images/TB.png,3,Outcome=loss;Touchdowns=2;Receiving=295 yards;Rushing=80 yards;Turnovers=2;Touchdowns conceded=3;FGs over 45y=1
Tennessee Titans,TEN,Houston Texans,15,1-8,images/TEN.png,0.5,Outcome=loss;Touchdowns=2;Receiving=230 yards;Rushing=90 yards;Turnovers=2;Touchdowns conceded=2;FGs over 45y=0
Washington Commanders,WAS,Miami Dolphins,12,3-7,images/WAS.png,1,Outcome=loss;Touchdowns=3;Receiving=310 yards;Rushing=95 yards;Turnovers=3;Touchdowns conceded=5;FGs over 45y=0`;


        // --- 3. Configuration & State ---
        
        // These are the 6 NFL teams associated with Teamz1-Teamz6 keys on the dashboard
        const SELECTED_NFL_TEAMS = [
            "New England Patriots", "Dallas Cowboys", "Kansas City Chiefs", 
            "San Francisco 49ers", "Green Bay Packers", "Miami Dolphins"
        ];
        
        const GENERIC_TEAM_HEADERS = [
            "Team 1", "Team 2", "Team 3", "Team 4", "Team 5", "Team 6"
        ];
        
        const TEAM_KEYS = ["Teamz1", "Teamz2", "Teamz3", "Teamz4", "Teamz5", "Teamz6"];
        const MAX_PICKS = 6;
        const INITIAL_BUDGET = 20;

        let userDatabase = [];
        let teamsDatabase = {}; // Stores team data for quick lookup { 'Team Name': {team: '...', abbr: '...', ...}, ... }
        let currentUserPicks = []; // Stores abbreviations of teams picked by the current user
        let budgetRemaining = INITIAL_BUDGET; 

        // --- 4. DOM Elements ---
        const loggedInScreen = document.getElementById('logged-in-screen');
        const pickTeamsScreen = document.getElementById('pick-teams-screen');
        const summaryScreen = document.getElementById('summary-screen'); 
        const tableContainer = document.getElementById('user-table-container');
        const fixturesContainer = document.getElementById('fixtures-container');
        const notificationMessage = document.getElementById('notification-message'); 
        const summaryContainer = document.getElementById('summary-container');
        const pickedTeamsBar = document.getElementById('picked-teams-bar'); 
        // Modal elements
        const teamModal = document.getElementById('team-modal');
        const modalContent = document.getElementById('modal-content');


        // --- 5. Data Handling Functions ---

        /**
         * Helper function to format ratings/budget, limiting to one decimal place.
         */
        function formatRating(value) {
            if (typeof value === 'number') {
                // Returns a string representation, showing one decimal place only if necessary (e.g., 20.5, 20)
                return value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 });
            }
            return value; // Return as is if not a number
        }

        function csvToArray(csv) {
            const lines = csv.split('\n');
            if (lines.length <= 1) return [];

            const headers = lines[0].trim().split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].trim();
                if (!currentLine) continue;

                // Handle values including the new record column
                const values = currentLine.split(','); 
                const row = {};
                
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j].trim()] = values[j] ? values[j].trim() : '';
                }
                data.push(row);
            }
            return data;
        }

        function csvToMap(csv, keyField) {
            const arrayData = csvToArray(csv);
            const map = {};
            arrayData.forEach(item => {
                // Ensure points is stored as an integer
                if (item.points) {
                    item.points = parseInt(item.points, 10);
                }
                // Ensure rating is stored as a float (Update for decimal support)
                if (item.rating) {
                    item.rating = parseFloat(item.rating);
                }
                if (item[keyField]) {
                    map[item[keyField]] = item;
                }
            });
            return map;
        }

        function getTeamDataByAbbr(abbr) {
            for (const teamName in teamsDatabase) {
                if (teamsDatabase[teamName].abbr === abbr) {
                    return teamsDatabase[teamName];
                }
            }
            return null;
        }
        
        /**
         * Parses the match breakdown string into a usable object.
         * @param {string} matchDetailsString - The semicolon-separated string of match details.
         * @returns {Object} An object mapping stat keys to values.
         */
        function parseMatchDetails(matchDetailsString) {
            const breakdown = {};
            if (!matchDetailsString) return breakdown;

            matchDetailsString.split(';').forEach(item => {
                const [key, value] = item.split('=');
                if (key && value) {
                    breakdown[key.trim()] = value.trim();
                }
            });
            return breakdown;
        }


        // --- 6. Screen Transition Functions ---
        
        function hideAllScreens() {
            loggedInScreen.classList.add('hidden');
            pickTeamsScreen.classList.add('hidden');
            summaryScreen.classList.add('hidden'); 
            // Remove full width class if it exists
            document.getElementById('app-container').classList.remove('max-w-6xl');
            document.getElementById('app-container').classList.add('max-w-sm');
        }

        function showScreen(screenElement) {
            hideAllScreens();
            // Allow dashboard and picking screen to use wider container
            if (screenElement === loggedInScreen || screenElement === pickTeamsScreen || screenElement === summaryScreen) {
                document.getElementById('app-container').classList.remove('max-w-sm'); 
                document.getElementById('app-container').classList.add('max-w-6xl'); 
            }
            screenElement.classList.remove('hidden');
        }
        
        function goToDashboardScreen() {
            renderUserTable();
            showScreen(loggedInScreen);
        }

        function goToPickScreen() {
            // Recalculate budget based on current picks (simulate a fresh pick session)
            budgetRemaining = INITIAL_BUDGET;
            currentUserPicks.forEach(abbr => {
                const teamData = getTeamDataByAbbr(abbr);
                // budgetRemaining is updated using the float rating value
                if(teamData) budgetRemaining -= teamData.rating;
            });

            renderPickScreen();
            renderPickedTeamsBar();
            showScreen(pickTeamsScreen);
        }
        
        function goToSummaryScreen() {
            renderSummaryScreen();
            showScreen(summaryScreen);
        }


        // --- 7. Dashboard/Table Rendering ---

        function renderUserTable() {
            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                        <thead class="bg-indigo-600 text-white shadow-lg">
                            <tr>
                                <th class="sticky left-0 px-4 py-3 text-left text-sm font-bold uppercase tracking-wider bg-indigo-700 rounded-tl-lg">Name</th>
                                ${GENERIC_TEAM_HEADERS.map(h => `<th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider">${h}</th>`).join('')}
                                <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider bg-indigo-700 rounded-tr-lg">Total Points</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
            `;

            userDatabase.forEach((user, index) => {
                let totalPoints = 0; 
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tableHtml += `<tr class="hover:bg-indigo-100 transition duration-150 ${rowClass}">`;
                
                tableHtml += `<td class="sticky left-0 px-4 py-3 whitespace-nowrap font-medium text-gray-900 text-left bg-inherit">${user.name}</td>`;
                
                // Team Columns
                TEAM_KEYS.forEach((key, j) => {
                    const isMember = user[key].toLowerCase() === 'true'; 
                    let cellContent = `<span class="text-red-500 italic text-sm">N/A</span>`; // Default if not picked

                    if (isMember) {
                        const teamName = SELECTED_NFL_TEAMS[j]; 
                        const teamData = teamsDatabase[teamName];
                        
                        if (teamData) {
                            totalPoints += teamData.points;
                            const abbr = teamData.abbr;

                            // Make the team display clickable
                            cellContent = `
                                <button onclick="showTeamModal('${abbr}')" 
                                        class="group focus:outline-none p-1 rounded-lg transition duration-150 hover:bg-indigo-100">
                                    <div class="flex flex-col items-center">
                                        <img src="${teamData.image}" 
                                                alt="${teamData.team} logo" 
                                                class="w-8 h-8 rounded-full object-cover mb-1 border border-gray-200 group-hover:shadow-md"
                                                onerror="this.onerror=null; this.src='https://placehold.co/32x32/374151/ffffff?text=${teamData.abbr}';"
                                        >
                                        <span class="text-indigo-700 font-extrabold text-lg">${teamData.abbr}</span>
                                        <span class="text-xs text-gray-600 font-bold mt-0.5">${teamData.points} Pts</span>
                                    </div>
                                </button>
                            `;
                        }
                    } 
                    
                    tableHtml += `<td class="px-4 py-3 whitespace-nowrap text-center">${cellContent}</td>`;
                });
                
                // Total Points Column
                tableHtml += `
                    <td class="px-4 py-3 whitespace-nowrap text-center bg-indigo-50 font-extrabold text-lg">
                        <span class="text-green-600">${totalPoints}</span>
                    </td>
                `;

                tableHtml += `</tr>`;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContainer.innerHTML = tableHtml;
        }

        // --- 8. Pick Screen Logic and Rendering ---

        function getFixtures() {
            const fixtures = [];
            const processedMatchups = new Set(); 

            for (const teamName in teamsDatabase) {
                const homeTeamData = teamsDatabase[teamName];
                const opponentName = homeTeamData.opponent;

                const matchKey = [teamName, opponentName].sort().join(' vs ');

                if (!processedMatchups.has(matchKey)) {
                    const awayTeamData = teamsDatabase[opponentName];

                    if (awayTeamData) {
                        fixtures.push({
                            home: homeTeamData,
                            away: awayTeamData
                        });
                        processedMatchups.add(matchKey);
                    }
                }
            }
            return fixtures;
        }
        
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationMessage.classList.remove('hidden');
            setTimeout(() => {
                notificationMessage.classList.add('hidden');
            }, 3000);
        }

        function handlePick(teamAbbr, buttonElement) {
            const teamData = getTeamDataByAbbr(teamAbbr);
            if (!teamData) return;

            // cost is now a float
            const cost = teamData.rating; 
            const index = currentUserPicks.indexOf(teamAbbr);

            if (index > -1) {
                // Unpick
                currentUserPicks.splice(index, 1);
                // Uses floating point arithmetic
                budgetRemaining += cost;
                
                buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-inner');
                buttonElement.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                buttonElement.innerHTML = 'Pick';
            } else {
                // Attempt to pick
                if (currentUserPicks.length >= MAX_PICKS) {
                    showNotification("Maximum 6 teams picked. Please unpick a team first.");
                    return; 
                } else if (budgetRemaining < cost) {
                    // This block should ideally not be hit if the button is disabled, but serves as a final check
                    showNotification(`Insufficient budget. This team costs ⭐${formatRating(cost)}, but you only have ⭐${formatRating(budgetRemaining)} remaining.`);
                    return;
                }
                
                currentUserPicks.push(teamAbbr);
                // Uses floating point arithmetic
                budgetRemaining -= cost;
                
                buttonElement.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                buttonElement.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-inner');
                buttonElement.innerHTML = 'Picked &nbsp;&#10003;';
            }
            
            // Re-render the pick screen to update grayed-out states based on new budget
            renderPickScreen();
            renderPickedTeamsBar();
        }
        
        function renderPickedTeamsBar() {
            if (!pickedTeamsBar) return;

            const pickedTeamDetails = currentUserPicks.map(abbr => getTeamDataByAbbr(abbr)).filter(detail => detail !== null);
            
            const imageTiles = pickedTeamDetails.map(team => `
                <div class="relative group flex-shrink-0" title="${team.team} (${formatRating(team.rating)} Stars)">
                    <img src="${team.image}" 
                         alt="${team.abbr} logo" 
                         class="w-10 h-10 rounded-full object-cover border-2 border-white transition duration-200 group-hover:scale-105"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/f3f4f6/374151?text=${team.abbr}';"
                    >
                    <!-- Hover text for rating, using formatRating -->
                    <span class="absolute top-0 right-0 text-xs font-bold text-yellow-300 bg-gray-800 px-1 py-0.5 rounded-full opacity-0 group-hover:opacity-100 transition duration-150 transform -translate-y-1/2 translate-x-1/2">
                        ⭐${formatRating(team.rating)}
                    </span>
                </div>
            `).join('');

            const barContent = `
                <div class="flex items-center justify-between max-w-6xl mx-auto px-2">
                    
                    <!-- Left Side: Picked Teams -->
                    <div class="flex items-center space-x-2 flex-1 min-w-0"> 
                        <div id="picked-images-container" class="flex space-x-2 overflow-x-auto py-1 w-full flex-1">
                            ${imageTiles}
                            <!-- Placeholder to ensure minimum of 6 spots are visible -->
                            ${[...Array(MAX_PICKS - pickedTeamDetails.length)].map((_, i) => `
                                <div key=${i} class="w-10 h-10 rounded-full border-2 border-gray-700 bg-gray-800 flex items-center justify-center text-gray-500 text-xs font-semibold flex-shrink-0">
                                    ${i + pickedTeamDetails.length + 1}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Right Side: Budget and DONE Button -->
                    <div class="flex items-center space-x-3 flex-shrink-0 ml-3"> 
                        <!-- STACKED BUDGET DISPLAY, using formatRating -->
                        <div class="flex flex-col items-center">
                            <span class="text-xs font-medium text-gray-400 -mb-0.5">BUDGET</span>
                            <span class="text-lg font-bold text-yellow-400 leading-tight">⭐${formatRating(budgetRemaining)}</span>
                        </div>
                        
                        <button onclick="goToSummaryScreen()" 
                                class="bg-green-600 text-white py-2 px-3 rounded-lg font-bold text-sm hover:bg-green-700 transition duration-200 shadow-lg">
                            DONE
                        </button>
                    </div>
                </div>
            `;

            pickedTeamsBar.innerHTML = barContent;
        }

        function createTeamTile(teamData, isHomeTeam) {
            const abbr = teamData.abbr;
            const isPicked = currentUserPicks.includes(abbr);
            const cost = teamData.rating; // Cost is a float

            // Check if the team is affordable (Request 1)
            const isAffordable = cost <= budgetRemaining;
            
            // Define base classes
            let tileClasses = 'border-2 border-gray-300 bg-white shadow-lg flex-shrink-0 transition duration-200';
            let buttonClasses = 'w-full text-white py-1.5 rounded-lg font-semibold transition duration-150';
            let buttonText = '';
            let disabledAttribute = '';

            if (isPicked) {
                // Picked state (always allowed to unpick)
                buttonClasses += ' bg-green-600 hover:bg-green-700 shadow-inner';
                buttonText = 'Picked &nbsp;&#10003;';
                tileClasses += ' border-green-400';
            } else if (!isAffordable) {
                // Unaffordable state: Grey out and disable
                tileClasses += ' bg-gray-100 opacity-60 cursor-not-allowed';
                buttonClasses += ' bg-red-400 cursor-not-allowed';
                buttonText = 'Unaffordable';
                disabledAttribute = 'disabled';
            } else {
                // Available to pick state
                tileClasses += ' hover:bg-gray-50';
                buttonClasses += ' bg-indigo-600 hover:bg-indigo-700';
                buttonText = 'Pick';
            }
            
            // CORRECTED: Ensure all requested elements (Image, Abbr, Rating, Record) are displayed.
            return `
                <div class="flex-1 flex flex-col items-center p-3 rounded-xl ${tileClasses}">
                    <!-- Team Image -->
                    <img src="${teamData.image}" 
                         alt="${teamData.team} logo" 
                         class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-gray-100"
                         onerror="this.onerror=null; this.src='https://placehold.co/64x64/374151/ffffff?text=${abbr}';"
                    >
                    <!-- 2/3 letter abbreviation (Abbr) -->
                    <span class="text-3xl font-extrabold text-indigo-700 leading-none mb-1">${abbr}</span>
                    <!-- Star-value (Rating) -->
                    <span class="text-lg font-bold text-yellow-600">⭐${formatRating(teamData.rating)}</span>
                    <!-- Team's form/record (Record) -->
                    <span class="text-xs text-gray-500 mb-3">${teamData.record}</span>
                    <!-- Pick/Picked Button -->
                    <button onclick="handlePick('${abbr}', this)"
                            ${disabledAttribute}
                            class="${buttonClasses}">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function renderPickScreen() {
            const fixtures = getFixtures();
            let fixturesHtml = '';

            fixtures.forEach(fixture => {
                fixturesHtml += `
                    <div class="bg-white p-3 rounded-xl shadow-xl flex flex-row space-x-2 items-center justify-center border border-gray-200 w-full">
                        ${createTeamTile(fixture.home, true)}
                        <span class="text-xl font-bold text-gray-700 mx-2">vs</span>
                        ${createTeamTile(fixture.away, false)}
                    </div>
                `;
            });

            fixturesContainer.innerHTML = fixturesHtml;
        }
        
        // --- 9. Summary Screen Rendering ---
        
        function renderSummaryScreen() {
            const pickedTeamDetails = currentUserPicks.map(abbr => {
                for (const teamName in teamsDatabase) {
                    if (teamsDatabase[teamName].abbr === abbr) {
                        return teamsDatabase[teamName];
                    }
                }
                return null;
            }).filter(detail => detail !== null);
            
            if (pickedTeamDetails.length === 0) {
                summaryContainer.innerHTML = `<p class="text-xl text-gray-500">You haven't made any picks yet!</p>`;
                return;
            }
            
            let listHtml = pickedTeamDetails.map(team => `
                <li class="flex justify-between items-center space-x-4 py-3 px-4 bg-gray-100 rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <img src="${team.image}" 
                             alt="${team.team} logo" 
                             class="w-10 h-10 rounded-full object-cover border-2 border-white"
                             onerror="this.onerror=null; this.src='https://placehold.co/40x40/374151/ffffff?text=${team.abbr}';"
                        >
                        <span class="text-xl font-semibold text-gray-800">${team.team}</span>
                    </div>
                    <!-- Display rating using formatRating -->
                    <span class="text-xl font-bold text-yellow-600">⭐${formatRating(team.rating)}</span>
                </li>
            `).join('');

            summaryContainer.innerHTML = `
                <ul class="space-y-3 max-w-sm mx-auto mb-4">
                    ${listHtml}
                </ul>
            `;
        }
        
        // --- 10. Modal Functions (Updated to include Match Breakdown Table) ---
        
        function showTeamModal(abbr) {
            const teamData = getTeamDataByAbbr(abbr);
            if (!teamData) return;

            // --- 1. Get Opponent Data ---
            const opponentName = teamData.opponent;
            const opponentData = teamsDatabase[opponentName];
            
            let opponentHtml = '';
            if (opponentData) {
                // Request 2: Opponent name alongside image
                opponentHtml = `
                    <div class="flex items-center space-x-3">
                        <img src="${opponentData.image}" 
                             alt="${opponentData.team} logo" 
                             class="w-10 h-10 rounded-full object-cover border-2 border-gray-300"
                             onerror="this.onerror=null; this.src='https://placehold.co/40x40/d1d5db/374151?text=${opponentData.abbr}';"
                        >
                        <span class="text-lg font-medium text-gray-800">${opponentData.team}</span>
                    </div>
                `;
            }
            
            // --- 2. Parse Match Breakdown Data ---
            const breakdown = parseMatchDetails(teamData.details);

            const breakdownDataLabels = [
                { label: 'Outcome', key: 'Outcome' },
                { label: 'Touchdowns', key: 'Touchdowns' },
                { label: 'Receiving', key: 'Receiving' },
                { label: 'Rushing', key: 'Rushing' },
                { label: 'Turnovers', key: 'Turnovers' },
                { label: 'Touchdowns conceded', key: 'Touchdowns conceded' },
                { label: 'FGs over 45y', key: 'FGs over 45y' },
            ];
            
            // --- 3. Generate Match Breakdown Table HTML ---
            const breakdownTableHTML = `
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-3 text-left">Match Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg overflow-hidden border border-gray-100">
                            <tbody class="bg-white divide-y divide-gray-100 text-left">
                                ${breakdownDataLabels.map(item => `
                                    <tr class="hover:bg-indigo-50 transition duration-100">
                                        <!-- px-2 used instead of px-4 to reduce horizontal padding -->
                                        <td class="px-2 py-2.5 whitespace-nowrap text-sm font-medium text-gray-700">${item.label}</td>
                                        <td class="px-2 py-2.5 whitespace-nowrap text-sm text-gray-900 font-semibold">${breakdown[item.key] || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // --- 4. Record and Rating block ---
            const recordRatingHtml = `
                <div class="flex justify-center space-x-6 mb-6 text-base font-medium text-gray-500">
                    <div>Record: <span class="text-gray-800 font-semibold">${teamData.record}</span></div>
                    <!-- Display rating using formatRating -->
                    <div>Rating: <span class="text-yellow-600 font-semibold">⭐${formatRating(teamData.rating)}</span></div>
                </div>
            `;
            
            // --- 5. Opponent and Points block ---
            const summaryBoxesHtml = `
                <div class="flex flex-col space-y-3 mb-6">
                    <!-- Opponent Info -->
                    <div class="bg-gray-100 p-3 rounded-lg flex justify-between items-center border border-gray-200 shadow-sm">
                        <!-- Updated label (Request 2) -->
                        <label class="text-base font-semibold text-gray-600">Vs:</label> 
                        ${opponentHtml}
                    </div>
                    <!-- Total Points Field -->
                    <div class="bg-indigo-50 p-4 rounded-lg flex justify-between items-center border border-indigo-200 shadow-md">
                        <label class="text-lg font-semibold text-gray-700">Total points:</label>
                        <div class="text-2xl font-bold text-green-600">${teamData.points}</div>
                    </div>
                </div>
            `;


            // --- 6. Populate Modal Content ---
            modalContent.innerHTML = `
                <h3 class="text-2xl font-extrabold text-indigo-700 pt-2 mb-4">${teamData.team}</h3>
                
                <!-- Team Image -->
                <div class="mb-3 flex justify-center">
                    <img src="${teamData.image}" 
                         alt="${teamData.team} logo" 
                         class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 shadow-xl"
                         onerror="this.onerror=null; this.src='https://placehold.co/96x96/374151/ffffff?text=${teamData.abbr}';"
                    >
                </div>
                
                ${recordRatingHtml} 
                
                ${summaryBoxesHtml} 
                
                ${breakdownTableHTML} 
            `;

            // Display Modal
            teamModal.classList.remove('hidden');
            teamModal.classList.add('flex');
        }

        function closeTeamModal() {
            teamModal.classList.add('hidden');
            teamModal.classList.remove('flex');
        }


        // --- 11. Initialization ---

        window.onload = function() {
            // Populate the in-memory databases
            userDatabase = csvToArray(CSV_DATA);
            teamsDatabase = csvToMap(TEAMS_CSV_DATA, 'team');
            
            // Start directly on the dashboard screen
            goToDashboardScreen();
        };
    </script>
</body>
</html>