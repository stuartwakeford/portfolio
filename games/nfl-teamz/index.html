<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Account System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2">

    <!-- Team Details Modal (NEW) -->
    <div id="team-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm relative transform transition-all duration-300 scale-100 opacity-100">
            <!-- Close Button -->
            <button onclick="closeTeamModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 transition focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Modal Content -->
            <div id="modal-content" class="text-center space-y-4">
                <!-- Content will be populated by JS -->
            </div>
        </div>
    </div>
    <!-- End Team Details Modal -->

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-6xl">

        <!-- Login Screen (State 1) -->
        <div id="login-screen" class="max-w-sm mx-auto bg-white p-8 rounded-xl shadow-2xl transition-opacity duration-500">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-6 text-center">User Login</h1>
            
            <form id="login-form">
                
                <!-- Email Input -->
                <div class="mb-5">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="email" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                           placeholder="Enter email..." required>
                </div>

                <!-- Password Input -->
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                           placeholder="Enter password..." required>
                </div>

                <!-- Error Message Display -->
                <div id="error-message" class="text-red-600 bg-red-100 p-3 rounded-lg mb-4 hidden transition duration-300 text-sm font-semibold">
                    user details incorrect
                </div>

                <!-- Login Button -->
                <button type="submit" id="login-button"
                        class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Login
                </button>
            </form>
        </div>

        <!-- Dashboard Screen (State 2) -->
        <div id="logged-in-screen" class="hidden bg-white p-8 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-6">NFL Teamz Week 6</h2>
            
            <!-- Pick Teams Button -->
            <button id="pick-teams-btn" onclick="goToPickScreen()"
                    class="bg-green-500 text-white py-2 px-8 rounded-lg font-bold hover:bg-green-600 transition duration-200 shadow-md mb-8">
                Pick my teams
            </button>

            <div id="user-table-container">
                <!-- Table will be rendered here by JavaScript -->
            </div>
            <button onclick="window.location.reload()" 
                    class="mt-8 bg-gray-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                Logout
            </button>
        </div>

        <!-- Pick Teams Screen (State 3) -->
        <div id="pick-teams-screen" class="hidden bg-white p-4 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <!-- Header Text -->
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Pick your 6 teams</h2>
            
            <!-- Notification Message (for max picks or budget exceeded) -->
            <div id="notification-message" class="text-red-600 bg-red-100 p-2 rounded-lg mb-4 hidden transition duration-300 text-sm font-semibold max-w-sm mx-auto">
                Maximum 6 teams picked. Please unpick a team first.
            </div>

            <!-- Fixtures Container (Content) - pb-32 adds space for the sticky bar -->
            <div id="fixtures-container" class="space-y-4 mt-6 pb-32">
                <!-- Fixtures will be rendered here by JavaScript -->
            </div>
            
            <!-- STICKY BOTTOM BAR CONTAINER -->
            <div id="picked-teams-bar" class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-3 shadow-2xl z-10 border-t-4 border-indigo-600">
                <!-- Content added via JS -->
            </div>

        </div>
        
        <!-- Summary Screen (State 4) -->
        <div id="summary-screen" class="hidden bg-white p-8 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Your picks</h2>
            
            <div class="text-lg font-bold text-red-600 bg-red-50 p-3 rounded-lg mb-8 max-w-sm mx-auto">
                Take a screenshot and send to Stu!
            </div>

            <div id="summary-container" class="mb-8">
                <!-- Pick summary will be rendered here -->
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="goToDashboardScreen()" id="summary-back-btn"
                        class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                    Back to Dashboard
                </button>
                <button onclick="window.location.reload()" 
                        class="bg-gray-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                    Logout
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. Simulated User Database (CSV) ---
        // Headers: name,email,password,Teamz1,Teamz2,Teamz3,Teamz4,Teamz5,Teamz6
        const CSV_DATA = 
            `name,email,password,Teamz1,Teamz2,Teamz3,Teamz4,Teamz5,Teamz6
Stu,stu@email.com,1234,true,true,true,true,true,true
Admin,admin@example.com,password123,true,true,true,true,true,true
Tester,tester@test.com,test,true,true,true,true,true,true
Dave,dave@email.com,1234,true,true,true,true,true,true
Kat,kat@email.com,1234,true,true,true,true,true,true
Rich,rich@email.com,1234,true,true,true,true,true,true
Fernando,fernando@email.com,1234,true,true,true,true,true,true`;

        // --- 2. Simulated Teams Database (CSV) ---
        // Headers: team,abbr,opponent,points,record,image,rating (32 NFL teams with guaranteed reciprocal pairings)
        const TEAMS_CSV_DATA = 
            `team,abbr,opponent,points,record,image,rating
Arizona Cardinals,ARI,Los Angeles Rams,18,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
Atlanta Falcons,ATL,Houston Texans,25,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Baltimore Ravens,BAL,Kansas City Chiefs,31,2-4,https://stuartwakeford.com/images/sw-b+w.png,4
Buffalo Bills,BUF,Miami Dolphins,22,2-4,https://stuartwakeford.com/images/sw-b+w.png,4
Carolina Panthers,CAR,Tampa Bay Buccaneers,10,2-4,https://stuartwakeford.com/images/sw-b+w.png,1
Chicago Bears,CHI,Minnesota Vikings,15,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
Cincinnati Bengals,CIN,Cleveland Browns,24,2-4,https://stuartwakeford.com/images/SW-badge.svg,3
Cleveland Browns,CLE,Cincinnati Bengals,12,2-4,https://stuartwakeford.com/images/SW-badge.svg,2
Dallas Cowboys,DAL,Philadelphia Eagles,30,2-4,https://stuartwakeford.com/images/sw-b+w.png,5
Denver Broncos,DEN,New York Jets,16,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
Detroit Lions,DET,Green Bay Packers,28,2-4,https://stuartwakeford.com/images/sw-b+w.png,4
Green Bay Packers,GB,Detroit Lions,20,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Houston Texans,HOU,Atlanta Falcons,27,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Indianapolis Colts,IND,Jacksonville Jaguars,19,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Jacksonville Jaguars,JAX,Indianapolis Colts,21,2-4,https://stuartwakeford.com/images/sw-b+w.png,4
Kansas City Chiefs,KC,Baltimore Ravens,35,2-4,https://stuartwakeford.com/images/sw-b+w.png,5
Las Vegas Raiders,LV,Washington Commanders,14,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
Los Angeles Chargers,LAC,New England Patriots,23,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Los Angeles Rams,LAR,Arizona Cardinals,29,2-4,https://stuartwakeford.com/images/sw-b+w.png,4
Miami Dolphins,MIA,Buffalo Bills,33,2-4,https://stuartwakeford.com/images/sw-b+w.png,5
Minnesota Vikings,MIN,Chicago Bears,17,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
New England Patriots,NE,Los Angeles Chargers,13,2-4,https://stuartwakeford.com/images/sw-b+w.png,1
New Orleans Saints,NO,Pittsburgh Steelers,26,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
New York Giants,NYG,San Francisco 49ers,11,2-4,https://stuartwakeford.com/images/sw-b+w.png,1
New York Jets,NYJ,Denver Broncos,10,2-4,https://stuartwakeford.com/images/sw-b+w.png,1
Philadelphia Eagles,PHI,Dallas Cowboys,34,2-4,https://stuartwakeford.com/images/sw-b+w.png,5
Pittsburgh Steelers,PIT,New Orleans Saints,18,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
San Francisco 49ers,SF,New York Giants,32,2-4,https://stuartwakeford.com/images/sw-b+w.png,5
Seattle Seahawks,SEA,Tennessee Titans,25,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Tampa Bay Buccaneers,TB,Carolina Panthers,19,2-4,https://stuartwakeford.com/images/sw-b+w.png,3
Tennessee Titans,TEN,Seattle Seahawks,15,2-4,https://stuartwakeford.com/images/sw-b+w.png,2
Washington Commanders,WAS,Las Vegas Raiders,12,2-4,https://stuartwakeford.com/images/sw-b+w.png,1`;


        // --- 3. Configuration & State ---
        
        // These are the 6 NFL teams associated with Teamz1-Teamz6 keys on the dashboard
        const SELECTED_NFL_TEAMS = [
            "New England Patriots", "Dallas Cowboys", "Kansas City Chiefs", 
            "San Francisco 49ers", "Green Bay Packers", "Miami Dolphins"
        ];
        
        const GENERIC_TEAM_HEADERS = [
            "Team 1", "Team 2", "Team 3", "Team 4", "Team 5", "Team 6"
        ];
        
        const TEAM_KEYS = ["Teamz1", "Teamz2", "Teamz3", "Teamz4", "Teamz5", "Teamz6"];
        const MAX_PICKS = 6;
        const INITIAL_BUDGET = 20;

        let userDatabase = [];
        let teamsDatabase = {}; // Stores team data for quick lookup { 'Team Name': {team: '...', abbr: '...', ...}, ... }
        let currentUserPicks = []; // Stores abbreviations of teams picked by the current user
        let budgetRemaining = INITIAL_BUDGET; 

        // --- 4. DOM Elements ---
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const loginScreen = document.getElementById('login-screen');
        const loggedInScreen = document.getElementById('logged-in-screen');
        const pickTeamsScreen = document.getElementById('pick-teams-screen');
        const summaryScreen = document.getElementById('summary-screen'); 
        const tableContainer = document.getElementById('user-table-container');
        const fixturesContainer = document.getElementById('fixtures-container');
        const notificationMessage = document.getElementById('notification-message'); 
        const summaryContainer = document.getElementById('summary-container');
        const pickedTeamsBar = document.getElementById('picked-teams-bar'); 
        // Modal elements (NEW)
        const teamModal = document.getElementById('team-modal');
        const modalContent = document.getElementById('modal-content');


        // --- 5. Data Handling Functions ---

        function csvToArray(csv) {
            const lines = csv.split('\n');
            if (lines.length <= 1) return [];

            const headers = lines[0].trim().split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].trim();
                if (!currentLine) continue;

                // Handle values including the new record column
                const values = currentLine.split(','); 
                const row = {};
                
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j].trim()] = values[j] ? values[j].trim() : '';
                }
                data.push(row);
            }
            return data;
        }

        function csvToMap(csv, keyField) {
            const arrayData = csvToArray(csv);
            const map = {};
            arrayData.forEach(item => {
                // Ensure points is stored as an integer
                if (item.points) {
                    item.points = parseInt(item.points, 10);
                }
                // Ensure rating is stored as an integer
                if (item.rating) {
                    item.rating = parseInt(item.rating, 10);
                }
                if (item[keyField]) {
                    map[item[keyField]] = item;
                }
            });
            return map;
        }

        function getTeamDataByAbbr(abbr) {
            for (const teamName in teamsDatabase) {
                if (teamsDatabase[teamName].abbr === abbr) {
                    return teamsDatabase[teamName];
                }
            }
            return null;
        }

        // --- 6. Screen Transition Functions ---
        
        function hideAllScreens() {
            loginScreen.classList.add('hidden');
            loggedInScreen.classList.add('hidden');
            pickTeamsScreen.classList.add('hidden');
            summaryScreen.classList.add('hidden'); 
            // Remove full width class if it exists
            document.getElementById('app-container').classList.remove('max-w-6xl');
            document.getElementById('app-container').classList.add('max-w-sm');
        }

        function showScreen(screenElement) {
            hideAllScreens();
            // Allow dashboard and picking screen to use wider container
            if (screenElement === loggedInScreen || screenElement === pickTeamsScreen || screenElement === summaryScreen) {
                document.getElementById('app-container').classList.remove('max-w-sm'); 
                document.getElementById('app-container').classList.add('max-w-6xl'); 
            }
            screenElement.classList.remove('hidden');
        }
        
        function goToDashboardScreen() {
            renderUserTable();
            showScreen(loggedInScreen);
        }

        function goToPickScreen() {
            // Recalculate budget based on current picks (if they were loaded from storage, which is not implemented here)
            budgetRemaining = INITIAL_BUDGET;
            currentUserPicks.forEach(abbr => {
                const teamData = getTeamDataByAbbr(abbr);
                if(teamData) budgetRemaining -= teamData.rating;
            });

            renderPickScreen();
            renderPickedTeamsBar(); // NEW CALL to show the sticky bar immediately
            showScreen(pickTeamsScreen);
        }
        
        function goToSummaryScreen() {
            // Check if user has made at least one pick before moving to summary
            if (currentUserPicks.length === 0) {
                 // For now, allow empty picks, but in a real app, validation would happen here.
            }
            renderSummaryScreen();
            showScreen(summaryScreen);
        }


        // --- 7. Dashboard/Table Rendering ---

        function renderUserTable() {
            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                        <thead class="bg-indigo-600 text-white shadow-lg">
                            <tr>
                                <th class="sticky left-0 px-4 py-3 text-left text-sm font-bold uppercase tracking-wider bg-indigo-700 rounded-tl-lg">Name</th>
                                ${GENERIC_TEAM_HEADERS.map(h => `<th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider">${h}</th>`).join('')}
                                <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider bg-indigo-700 rounded-tr-lg">Total Points</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
            `;

            userDatabase.forEach((user, index) => {
                let totalPoints = 0; 
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tableHtml += `<tr class="hover:bg-indigo-100 transition duration-150 ${rowClass}">`;
                
                tableHtml += `<td class="sticky left-0 px-4 py-3 whitespace-nowrap font-medium text-gray-900 text-left bg-inherit">${user.name}</td>`;
                
                // Team Columns
                TEAM_KEYS.forEach((key, j) => {
                    const isMember = user[key].toLowerCase() === 'true'; 
                    let cellContent = `<span class="text-red-500 italic text-sm">Error</span>`; // Default error

                    if (isMember) {
                        const teamName = SELECTED_NFL_TEAMS[j]; 
                        const teamData = teamsDatabase[teamName];
                        const abbr = teamData.abbr; // Get abbreviation for modal function

                        if (teamData) {
                            totalPoints += teamData.points;
                            
                            // Make the team display clickable
                            cellContent = `
                                <button onclick="showTeamModal('${abbr}')" 
                                        class="group focus:outline-none p-1 rounded-lg transition duration-150 hover:bg-indigo-100">
                                    <div class="flex flex-col items-center">
                                        <img src="${teamData.image}" 
                                                alt="${teamData.team} logo" 
                                                class="w-8 h-8 rounded-full object-cover mb-1 border border-gray-200 group-hover:shadow-md"
                                                onerror="this.onerror=null; this.src='https://placehold.co/32x32/374151/ffffff?text=${teamData.abbr}';"
                                        >
                                        <span class="text-indigo-700 font-extrabold text-lg">${teamData.abbr}</span>
                                        <span class="text-xs text-gray-600 font-bold mt-0.5">${teamData.points} Pts</span>
                                    </div>
                                </button>
                            `;
                        }
                    } 
                    
                    tableHtml += `<td class="px-4 py-3 whitespace-nowrap text-center">${cellContent}</td>`;
                });
                
                // Total Points Column
                tableHtml += `
                    <td class="px-4 py-3 whitespace-nowrap text-center bg-indigo-50 font-extrabold text-lg">
                        <span class="text-green-600">${totalPoints}</span>
                    </td>
                `;

                tableHtml += `</tr>`;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContainer.innerHTML = tableHtml;
        }

        // --- 8. Pick Screen Logic and Rendering ---

        function getFixtures() {
            const fixtures = [];
            // Use a Set to track unique match-ups (e.g., ARI vs LAR is the same as LAR vs ARI)
            const processedMatchups = new Set(); 

            // Iterate over the teamsDatabase entries
            for (const teamName in teamsDatabase) {
                const homeTeamData = teamsDatabase[teamName];
                const opponentName = homeTeamData.opponent;

                // Create a canonical match key by sorting the names alphabetically
                const matchKey = [teamName, opponentName].sort().join(' vs ');

                if (!processedMatchups.has(matchKey)) {
                    // Get the opponent's full data
                    const awayTeamData = teamsDatabase[opponentName];

                    if (awayTeamData) {
                        // The team listed first in the canonical key doesn't matter, 
                        // but we need to ensure we consistently use the data provided by homeTeamData
                        // as the base for the matchup display.
                        fixtures.push({
                            home: homeTeamData,
                            away: awayTeamData
                        });
                        processedMatchups.add(matchKey);
                    }
                }
            }
            return fixtures; // Returns 16 unique fixtures
        }
        
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationMessage.classList.remove('hidden');
            setTimeout(() => {
                notificationMessage.classList.add('hidden');
            }, 3000);
        }

        function handlePick(teamAbbr, buttonElement) {
            const teamData = getTeamDataByAbbr(teamAbbr);
            if (!teamData) return;

            const cost = teamData.rating;
            const index = currentUserPicks.indexOf(teamAbbr);

            if (index > -1) {
                // Unpick (already picked)
                currentUserPicks.splice(index, 1);
                budgetRemaining += cost; // Add cost back
                
                // Reset button style
                buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-inner');
                buttonElement.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                buttonElement.innerHTML = 'Pick';
            } else {
                // Attempt to pick
                if (currentUserPicks.length >= MAX_PICKS) {
                    showNotification("Maximum 6 teams picked. Please unpick a team first.");
                    return; 
                } else if (budgetRemaining < cost) {
                    showNotification(`Insufficient budget. This team costs ⭐${cost}, but you only have ⭐${budgetRemaining} remaining.`);
                    return;
                }
                
                currentUserPicks.push(teamAbbr);
                budgetRemaining -= cost; // Deduct cost
                
                // Update button style
                buttonElement.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                buttonElement.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-inner');
                // Use Unicode checkmark
                buttonElement.innerHTML = 'Picked &nbsp;&#10003;';
            }
            
            renderPickedTeamsBar(); // Update sticky bar on every pick/unpick
        }
        
        function renderPickedTeamsBar() {
            if (!pickedTeamsBar) return;

            // 1. Get details for all picked teams
            const pickedTeamDetails = currentUserPicks.map(abbr => getTeamDataByAbbr(abbr)).filter(detail => detail !== null);
            
            // 2. Build the image display area
            const imageTiles = pickedTeamDetails.map(team => `
                <div class="relative group" title="${team.team} (${team.rating} Stars)">
                    <img src="${team.image}" 
                         alt="${team.abbr} logo" 
                         class="w-10 h-10 rounded-full object-cover border-2 border-white transition duration-200 group-hover:scale-105"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/f3f4f6/374151?text=${team.abbr}';"
                    >
                    <!-- Hover text for rating -->
                    <span class="absolute top-0 right-0 text-xs font-bold text-yellow-300 bg-gray-800 px-1 py-0.5 rounded-full opacity-0 group-hover:opacity-100 transition duration-150 transform -translate-y-1/2 translate-x-1/2">
                        ⭐${team.rating}
                    </span>
                </div>
            `).join('');

            // 3. Construct the full bar content
            const barContent = `
                <div class="flex items-center justify-between max-w-6xl mx-auto px-2 sm:px-4">
                    
                    <!-- Left Side: Picked Teams and Pick Count -->
                    <div class="flex items-center space-x-4 w-2/3">
                        <span class="text-sm font-semibold text-gray-400 hidden sm:inline flex-shrink-0">Picks (${currentUserPicks.length}/${MAX_PICKS}):</span>
                        <div id="picked-images-container" class="flex space-x-2 overflow-x-auto py-1 w-full">
                            ${imageTiles}
                        </div>
                    </div>

                    <!-- Right Side: Budget and DONE Button -->
                    <div class="flex items-center space-x-4 flex-shrink-0">
                        <span class="text-base sm:text-lg font-bold">
                            Budget: <span class="text-yellow-400">⭐${budgetRemaining}</span>
                        </span>
                        <button onclick="goToSummaryScreen()" 
                                class="bg-green-600 text-white py-2 px-4 sm:px-6 rounded-lg font-bold hover:bg-green-700 transition duration-200 shadow-lg">
                            DONE
                        </button>
                    </div>
                </div>
            `;

            pickedTeamsBar.innerHTML = barContent;
        }

        function createTeamTile(teamData, isHomeTeam) {
            const abbr = teamData.abbr;
            const isPicked = currentUserPicks.includes(abbr);
            
            // Neutral styling for both home and away teams
            const tileClasses = 'border-2 border-gray-300 bg-white hover:bg-gray-50'; 
            
            const buttonClasses = isPicked 
                ? 'bg-green-600 hover:bg-green-700 shadow-inner'
                : 'bg-indigo-600 hover:bg-indigo-700';
            const buttonText = isPicked 
                ? 'Picked &nbsp;&#10003;' 
                : 'Pick';
            
            // Added Star Rating and adjusted margin on record
            return `
                <div class="flex-1 flex flex-col items-center p-3 rounded-xl shadow-lg transition duration-200 ${tileClasses}">
                    <!-- Added Team Image -->
                    <img src="${teamData.image}" 
                         alt="${teamData.team} logo" 
                         class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-gray-100"
                         onerror="this.onerror=null; this.src='https://placehold.co/64x64/374151/ffffff?text=${abbr}';"
                    >
                    <span class="text-2xl font-extrabold text-gray-800">${abbr}</span>
                    <span class="text-sm font-semibold text-yellow-600">⭐${teamData.rating}</span>
                    <span class="text-xs text-gray-500 mb-2">${teamData.record}</span>
                    <button onclick="handlePick('${abbr}', this)"
                            class="w-full text-white py-1.5 rounded-lg font-semibold transition duration-150 ${buttonClasses}">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function renderPickScreen() {
            const fixtures = getFixtures();
            let fixturesHtml = '';

            fixtures.forEach(fixture => {
                // Changed flex-col and sm:flex-row to flex-row immediately on mobile.
                // Changed p-4 to p-3 and reduced space-x to 2.
                fixturesHtml += `
                    <div class="bg-white p-3 rounded-xl shadow-xl flex flex-row space-x-2 items-center justify-center border border-gray-200 w-full">
                        <!-- Home Team Tile - flex-1 forces equal width on mobile/desktop -->
                        ${createTeamTile(fixture.home, true)}

                        <span class="text-xl font-bold text-gray-700 mx-2">vs</span>
                        
                        <!-- Away Team Tile - flex-1 forces equal width on mobile/desktop -->
                        ${createTeamTile(fixture.away, false)}
                    </div>
                `;
            });

            fixturesContainer.innerHTML = fixturesHtml;
        }
        
        // --- 9. Summary Screen Rendering ---
        
        function renderSummaryScreen() {
            // Find details for all picked teams
            const pickedTeamDetails = currentUserPicks.map(abbr => {
                // Iterate through the teamsDatabase (map of full names to data)
                for (const teamName in teamsDatabase) {
                    if (teamsDatabase[teamName].abbr === abbr) {
                        return teamsDatabase[teamName];
                    }
                }
                return null;
            }).filter(detail => detail !== null);
            
            if (pickedTeamDetails.length === 0) {
                summaryContainer.innerHTML = `<p class="text-xl text-gray-500">You haven't made any picks yet!</p>`;
                return;
            }
            
            // Renders team name with image asset, now including rating
            let listHtml = pickedTeamDetails.map(team => `
                <li class="flex justify-between items-center space-x-4 py-3 px-4 bg-gray-100 rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <img src="${team.image}" 
                             alt="${team.team} logo" 
                             class="w-10 h-10 rounded-full object-cover border-2 border-white"
                             onerror="this.onerror=null; this.src='https://placehold.co/40x40/374151/ffffff?text=${team.abbr}';"
                        >
                        <span class="text-xl font-semibold text-gray-800">${team.team}</span>
                    </div>
                    <!-- STAR RATING -->
                    <span class="text-xl font-bold text-yellow-600">⭐${team.rating}</span>
                </li>
            `).join('');

            summaryContainer.innerHTML = `
                <ul class="space-y-3 max-w-sm mx-auto mb-4">
                    ${listHtml}
                </ul>
            `;
        }
        
        // --- 10. Modal Functions (NEW) ---
        
        function showTeamModal(abbr) {
            const teamData = getTeamDataByAbbr(abbr);
            if (!teamData) return;

            // --- Get Opponent Data ---
            const opponentName = teamData.opponent;
            const opponentData = teamsDatabase[opponentName];
            
            let opponentHtml = '';
            if (opponentData) {
                opponentHtml = `
                    <div class="flex flex-col items-center">
                        <img src="${opponentData.image}" 
                             alt="${opponentData.team} logo" 
                             class="w-12 h-12 rounded-full object-cover border-2 border-gray-200"
                             onerror="this.onerror=null; this.src='https://placehold.co/48x48/d1d5db/374151?text=${opponentData.abbr}';"
                        >
                        <span class="text-sm font-medium text-gray-700 mt-1">${opponentData.team}</span>
                    </div>
                `;
            }


            // Populate Modal Content
            modalContent.innerHTML = `
                <h3 class="text-2xl font-extrabold text-indigo-700 pt-2 mb-4">${teamData.team}</h3>
                
                <!-- Team Image -->
                <div class="mb-6 flex justify-center">
                    <img src="${teamData.image}" 
                         alt="${teamData.team} logo" 
                         class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 shadow-xl"
                         onerror="this.onerror=null; this.src='https://placehold.co/96x96/374151/ffffff?text=${teamData.abbr}';"
                    >
                </div>
                
                <!-- Opponent Info -->
                <div class="bg-gray-100 p-3 rounded-lg flex flex-col items-center mb-6 border border-gray-200">
                    <label class="text-sm font-semibold text-gray-600 mb-2">Played Against:</label>
                    ${opponentHtml}
                </div>
                
                <!-- Total Points Field -->
                <div class="bg-indigo-50 p-4 rounded-lg flex justify-between items-center border border-indigo-200">
                    <label class="text-lg font-semibold text-gray-700">Total points:</label>
                    <div class="text-2xl font-bold text-green-600">${teamData.points}</div>
                </div>
                
                <!-- Other Data -->
                <div class="pt-4 text-sm text-gray-500 font-medium">
                    Record: <span class="text-gray-800 font-semibold">${teamData.record}</span>
                    | Rating: <span class="text-yellow-600 font-semibold">⭐${teamData.rating}</span>
                </div>
            `;

            // Display Modal
            teamModal.classList.remove('hidden');
            teamModal.classList.add('flex');
        }

        function closeTeamModal() {
            teamModal.classList.add('hidden');
            teamModal.classList.remove('flex');
        }


        // --- 11. Initialization & Event Handlers ---

        function displayError() {
            errorMessage.classList.remove('hidden');
            emailInput.focus(); 
            
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 3000);
        }

        function handleLogin(event) {
            event.preventDefault();

            errorMessage.classList.add('hidden');

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                displayError();
                return;
            }

            const foundUser = userDatabase.find(user => 
                user.email === email && user.password === password
            );

            if (foundUser) {
                console.log('Login successful for:', email);
                // Clear any previous picks for the new login session (in a real app, these would be loaded)
                currentUserPicks = []; 
                goToDashboardScreen(); 
            } else {
                console.log('Login failed for:', email);
                displayError();
            }
        }

        window.onload = function() {
            // Populate the in-memory databases
            userDatabase = csvToArray(CSV_DATA);
            teamsDatabase = csvToMap(TEAMS_CSV_DATA, 'team');
            
            // Attach the event listener to the form
            loginForm.addEventListener('submit', handleLogin);
        };
    </script>
</body>
</html>