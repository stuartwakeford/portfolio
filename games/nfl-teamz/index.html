<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Teamz Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics on modals */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Slate-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Slate-400 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2">

    <!-- Team Details Modal -->
    <div id="team-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300"
        onclick="if(event.target.id === 'team-modal') closeTeamModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm relative transform transition-all duration-300 scale-100 opacity-100">
            <!-- Close Button -->
            <button onclick="closeTeamModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 transition focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Modal Content -->
            <div id="modal-content" class="text-center space-y-4 pt-4 custom-scrollbar max-h-[80vh] overflow-y-auto">
                <!-- Content will be populated by JS -->
            </div>
        </div>
    </div>
    <!-- End Team Details Modal -->

    <!-- Main Container -->
    <div id="app-container" class="w-full max-w-6xl">

        <!-- Dashboard Screen (State 1 - Now Default) -->
        <!-- REMOVED p-8 to allow table to bleed -->
        <div id="logged-in-screen" class="hidden bg-white rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <!-- Internal padding added for header and button -->
            <h2 class="text-3xl font-extrabold text-indigo-700 pt-8 px-8 mb-6">NFL Teamz Week 11</h2>
            
            <!-- Pick Teams Button - Added mx-8 and reduced mb for tighter fit -->
            <button id="pick-teams-btn" onclick="goToPickScreen()"
                    class="bg-green-500 text-white py-2 px-8 rounded-lg font-bold hover:bg-green-600 transition duration-200 shadow-md mx-8 mb-4">
                Pick my teams
            </button>

            <!-- Table Container - Full width, with bottom padding -->
            <div id="user-table-container" class="mt-4 pb-8">
                <!-- Table will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- Pick Teams Screen (State 2) -->
        <!-- Removed p-4 and text-center classes. Added flex-col to enable scrolling for content area only -->
        <div id="pick-teams-screen" class="hidden bg-white rounded-xl shadow-2xl transition-opacity duration-500">
            
            <!-- New Sticky Top Bar for Title and Budget -->
            <div id="picking-header-bar" class="sticky top-0 bg-white p-4 z-20 shadow-md border-b border-gray-200 flex justify-between items-center">
                <!-- Content will be injected by JS -->
            </div>
            
            <!-- Notification Message (for max picks or budget exceeded) -->
            <!-- Adjusted layout to scroll with content -->
            <div id="notification-message" class="text-red-600 bg-red-100 p-2 rounded-lg mt-4 mb-4 hidden transition duration-300 text-sm font-semibold max-w-sm mx-auto">
                Maximum 6 teams picked. Please unpick a team first.
            </div>

            <!-- Fixtures Container (Content) - Added p-4 padding here. pb-32 adds space for the bottom sticky bar -->
            <div id="fixtures-container" class="p-4 space-y-4 pb-32">
                <!-- Fixtures will be rendered here by JavaScript -->
            </div>
            
            <!-- STICKY BOTTOM BAR CONTAINER -->
            <div id="picked-teams-bar" class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white py-3 px-2 shadow-2xl z-10 border-t-4 border-indigo-600">
                <!-- Content added via JS -->
            </div>

        </div>
        
        <!-- Summary Screen (State 3) -->
        <div id="summary-screen" class="hidden bg-white p-8 rounded-xl shadow-2xl text-center transition-opacity duration-500">
            <h2 class="text-3xl font-extrabold text-indigo-700 mb-4">Your picks</h2>
            
            <div class="text-lg font-bold text-red-600 bg-red-50 p-3 rounded-lg mb-8 max-w-sm mx-auto">
                Take a screenshot and send to Stu!
            </div>

            <div id="summary-container" class="mb-8">
                <!-- Pick summary will be rendered here -->
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="goToDashboardScreen()" id="summary-back-btn"
                        class="bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
                    Back to Dashboard
                </button>
                <button onclick="window.location.reload()" 
                        class="bg-gray-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-600 transition duration-200 shadow-md">
                    Reset Picks
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. User Database (CSV) - SIMULATED UNIQUE SCORES BY VARYING PICKS ---
        // Scores are now calculated based on the team name in each column (team1, team2, etc.)
        const CSV_DATA = 
            `name,team1,team2,team3,team4,team5,team6
Stu,Baltimore Ravens,Dallas Cowboys,Los Angeles Chargers,Los Angeles Rams,New England Patriots,Carolina Panthers
Dave,Cincinnati Bengals,New England Patriots,Dallas Cowboys,Baltimore Ravens,Kansas City Chiefs,Buffalo Bills
Kat,1,2,3,4,5,6
Rich,Green Bay Packers,New England Patriots, Houston Texans,Dallas Cowboys,Pittsburgh Steelers,Baltimore Ravens,
`;

        // --- 2. Simulated Teams Database (CSV) ---
        // Headers: team,abbr,opponent,points,record,image,rating,details
        // DETAILS format: Outcome=X;Touchdowns=Y;...;match-points=Z (NEW)
        const TEAMS_CSV_DATA = 
            `team,abbr,opponent,points,record,image,rating,details
Arizona Cardinals,ARI,San Francisco 49ers,45,3-6,images/ARI.png,2,Outcome=loss;Touchdowns=3;Receiving=452;Rushing=36;Turnovers=3;Touchdowns conceded=5;match-points=22
Atlanta Falcons,ATL,Carolina Panthers,50,3-6,images/ATL.png,1.5,Outcome=loss;Touchdowns=3;Receiving=223;Rushing=125;Turnovers=1;Touchdowns conceded=3;match-points=27
Baltimore Ravens,BAL,Cleveland Browns,90,5-4,images/BAL.png,3,Outcome=win;Touchdowns=2;Receiving=167;Rushing=184;Turnovers=3;Touchdowns conceded=1;match-points=23
Buffalo Bills,BUF,Tampa Bay Buccaneers,115,6-3,images/BUF.png,4,Outcome=win;Touchdowns=6;Receiving=317;Rushing=97;Turnovers=3;Touchdowns conceded=4;match-points=44
Carolina Panthers,CAR,Atlanta Falcons,75,6-3,images/CAR.png,1.5,Outcome=win;Touchdowns=3;Receiving=419;Rushing=67;Turnovers=0;Touchdowns conceded=3;match-points=30
Chicago Bears,CHI,Minnesota Vikings,55,6-3,images/CHI.png,2.5,Outcome=win;Touchdowns=1;Receiving=180;Rushing=140;Turnovers=0;Touchdowns conceded=2;match-points=19
Cincinnati Bengals,CIN,Pittsburgh Steelers,25,3-6,images/CIN.png,0.5,Outcome=loss;Touchdowns=1;Receiving=192;Rushing=105;Turnovers=2;Touchdowns conceded=4;match-points=12
Cleveland Browns,CLE,Baltimore Ravens,20,2-7,images/CLE.png,0.5,Outcome=loss;Touchdowns=1;Receiving=81;Rushing=106;Turnovers=1;Touchdowns conceded=3;match-points=16
Dallas Cowboys,DAL,Las Vegas Raiders,0,3-5,images/DAL.png,2,Outcome=?;Touchdowns=0;Receiving=0;Rushing=0;Turnovers=0;Touchdowns conceded=0;match-points=0
Denver Broncos,DEN,Kansas City Chiefs,55,8-2,images/DEN.png,4,Outcome=win;Touchdowns=1;Receiving=283;Rushing=59;Turnovers=0;Touchdowns conceded=2;match-points=22
Detroit Lions,DET,Philadelphia Eagles,35,6-3,images/DET.png,4.5,Outcome=loss;Touchdowns=1;Receiving=243;Rushing=74;Turnovers=1;Touchdowns conceded=1;match-points=9
Green Bay Packers,GB,New York Giants,80,5-3,images/GB.png,3.5,Outcome=win;Touchdowns=4;Receiving=168;Rushing=128;Turnovers=0;Touchdowns conceded=3;match-points=27
Houston Texans,HOU,Tennessee Titans,60,4-5,images/HOU.png,4,Outcome=win;Touchdowns=1;Receiving=240;Rushing=75;Turnovers=0;Touchdowns conceded=1;match-points=16
Jacksonville Jaguars,JAX,Los Angeles Chargers,115,5-4,images/JAC.png,2,Outcome=win;Touchdowns=5;Receiving=153;Rushing=192;Turnovers=1;Touchdowns conceded=0;match-points=35
Kansas City Chiefs,KC,Denver Broncos,45,5-4,images/KC.png,4.5,Outcome=loss;Touchdowns=2;Receiving=249;Rushing=62;Turnovers=1;Touchdowns conceded=1;match-points=19
Las Vegas Raiders,LV,Dallas Cowboys,0,2-7,images/LV.png,0.5,Outcome=?;Touchdowns=0;Receiving=0;Rushing=0;Turnovers=0;Touchdowns conceded=0;match-points=0
Los Angeles Chargers,LAC,Jacksonville Jaguars,-10,7-3,images/LAC.png,3.5,Outcome=loss;Touchdowns=0;Receiving=93;Rushing=42;Turnovers=1;Touchdowns conceded=5;match-points=6
Los Angeles Rams,LAR,Seattle Seahawks,85,7-2,images/LAR.png,5,Outcome=win;Touchdowns=3;Receiving=130;Rushing=119;Turnovers=1;Touchdowns conceded=1;match-points=21
Miami Dolphins,MIA,Washington Commanders,65,3-7,images/MIA.png,1,Outcome=win;Touchdowns=1;Receiving=142;Rushing=169;Turnovers=0;Touchdowns conceded=1;match-points=16
Minnesota Vikings,MIN,Chicago Bears,50,4-5,images/MIN.png,2.5,Outcome=loss;Touchdowns=2;Receiving=150;Rushing=115;Turnovers=2;Touchdowns conceded=1;match-points=17
New England Patriots,NE,New York Jets,75,8-2,images/NE.png,4.5,Outcome=win;Touchdowns=3;Receiving=271;Rushing=65;Turnovers=0;Touchdowns conceded=2;match-points=27
New York Giants,NYG,Green Bay Packers,45,2-8,images/NYG.png,1,Outcome=loss;Touchdowns=3;Receiving=194;Rushing=142;Turnovers=2;Touchdowns conceded=4;match-points=20
New York Jets,NYJ,New England Patriots,35,2-7,images/NYJ.png,1.5,Outcome=loss;Touchdowns=2;Receiving=105;Rushing=140;Turnovers=1;Touchdowns conceded=3;match-points=14
Philadelphia Eagles,PHI,Detroit Lions,60,7-2,images/PHI.png,3.5,Outcome=win;Touchdowns=1;Receiving=124;Rushing=148;Turnovers=0;Touchdowns conceded=1;match-points=16
Pittsburgh Steelers,PIT,Cincinnati Bengals,95,5-4,images/PIT.png,3,Outcome=win;Touchdowns=4;Receiving=232;Rushing=111;Turnovers=0;Touchdowns conceded=1;match-points=34
San Francisco 49ers,SF,Arizona Cardinals,85,6-4,images/SF.png,2.5,Outcome=win;Touchdowns=5;Receiving=186;Rushing=95;Turnovers=0;Touchdowns conceded=3;match-points=41
Seattle Seahawks,SEA,Los Angeles Rams,45,7-2,images/SEA.png,5,Outcome=loss;Touchdowns=1;Receiving=279;Rushing=135;Turnovers=4;Touchdowns conceded=3;match-points=19
Tampa Bay Buccaneers,TB,Buffalo Bills,50,6-3,images/TB.png,3,Outcome=loss;Touchdowns=4;Receiving=165;Rushing=202;Turnovers=2;Touchdowns conceded=6;match-points=32
Tennessee Titans,TEN,Houston Texans,30,1-8,images/TEN.png,0.5,Outcome=loss;Touchdowns=1;Receiving=171;Rushing=58;Turnovers=1;Touchdowns conceded=1;match-points=13
Washington Commanders,WAS,Miami Dolphins,50,3-7,images/WAS.png,1,Outcome=loss;Touchdowns=1;Receiving=207;Rushing=172;Turnovers=2;Touchdowns conceded=1;match-points=13`;


        // --- 3. Configuration & State ---
        
        // This constant is no longer needed as picks are user-specific in the CSV.
        // const SELECTED_NFL_TEAMS = [
        //     "New England Patriots", "Dallas Cowboys", "Kansas City Chiefs", 
        //     "San Francisco 49ers", "Green Bay Packers", "Miami Dolphins"
        // ];
        
        const GENERIC_TEAM_HEADERS = [
            "Team 1", "Team 2", "Team 3", "Team 4", "Team 5", "Team 6"
        ];
        
        // Team keys now match the new CSV headers: team1, team2, etc.
        const TEAM_KEYS = ["team1", "team2", "team3", "team4", "team5", "team6"];
        const MAX_PICKS = 6;
        const INITIAL_BUDGET = 20;

        let userDatabase = [];
        let teamsDatabase = {}; // Stores team data for quick lookup { 'Team Name': {team: '...', abbr: '...', ...} }
        let currentUserPicks = []; // Stores abbreviations of teams picked by the current user
        let budgetRemaining = INITIAL_BUDGET; 

        // --- 4. DOM Elements ---
        const loggedInScreen = document.getElementById('logged-in-screen');
        const pickTeamsScreen = document.getElementById('pick-teams-screen');
        const summaryScreen = document.getElementById('summary-screen'); 
        const tableContainer = document.getElementById('user-table-container');
        const fixturesContainer = document.getElementById('fixtures-container');
        const notificationMessage = document.getElementById('notification-message'); 
        const summaryContainer = document.getElementById('summary-container');
        const pickedTeamsBar = document.getElementById('picked-teams-bar'); 
        // New element for the sticky header
        const pickingHeaderBar = document.getElementById('picking-header-bar');
        // Modal elements
        const teamModal = document.getElementById('team-modal');
        const modalContent = document.getElementById('modal-content');


        // --- 5. Data Handling Functions ---

        /**
         * Helper function to format ratings/budget, limiting to one decimal place.
         */
        function formatRating(value) {
            if (typeof value === 'number') {
                // Returns a string representation, showing one decimal place only if necessary (e.g., 20.5, 20)
                return value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 });
            }
            return value; // Return as is if not a number
        }

        function csvToArray(csv) {
            const lines = csv.split('\n');
            if (lines.length <= 1) return [];

            const headers = lines[0].trim().split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].trim();
                if (!currentLine) continue;

                // Handle values including the new record column
                const values = currentLine.split(','); 
                const row = {};
                
                for (let j = 0; j < headers.length; j++) {
                    row[headers[j].trim()] = values[j] ? values[j].trim() : '';
                }
                data.push(row);
            }
            return data;
        }

        function csvToMap(csv, keyField) {
            const arrayData = csvToArray(csv);
            const map = {};
            arrayData.forEach(item => {
                // Ensure points is stored as an integer
                if (item.points) {
                    item.points = parseInt(item.points, 10);
                }
                // Ensure rating is stored as a float (Update for decimal support)
                if (item.rating) {
                    item.rating = parseFloat(item.rating);
                }
                if (item[keyField]) {
                    map[item[keyField]] = item;
                }
            });
            return map;
        }

        function getTeamDataByAbbr(abbr) {
            for (const teamName in teamsDatabase) {
                if (teamsDatabase[teamName].abbr === abbr) {
                    return teamsDatabase[teamName];
                }
            }
            return null;
        }
        
        /**
         * Parses the match breakdown string into a usable object.
         * @param {string} matchDetailsString - The semicolon-separated string of match details.
         * @returns {Object} An object mapping stat keys to values.
         */
        function parseMatchDetails(matchDetailsString) {
            const breakdown = {};
            if (!matchDetailsString) return breakdown;

            matchDetailsString.split(';').forEach(item => {
                const [key, value] = item.split('=');
                if (key && value) {
                    breakdown[key.trim()] = value.trim();
                }
            });
            return breakdown;
        }


        // --- 6. Screen Transition Functions ---
        
        function hideAllScreens() {
            loggedInScreen.classList.add('hidden');
            pickTeamsScreen.classList.add('hidden');
            summaryScreen.classList.add('hidden'); 
            // Remove full width class if it exists
            document.getElementById('app-container').classList.remove('max-w-6xl');
            document.getElementById('app-container').classList.add('max-w-sm');
        }

        function showScreen(screenElement) {
            hideAllScreens();
            // Allow dashboard and picking screen to use wider container
            if (screenElement === loggedInScreen || screenElement === pickTeamsScreen || screenElement === summaryScreen) {
                document.getElementById('app-container').classList.remove('max-w-sm'); 
                document.getElementById('app-container').classList.add('max-w-6xl'); 
            }
            screenElement.classList.remove('hidden');
        }
        
        function goToDashboardScreen() {
            renderUserTable();
            showScreen(loggedInScreen);
        }

        function goToPickScreen() {
            // Recalculate budget based on current picks (simulate a fresh pick session)
            budgetRemaining = INITIAL_BUDGET;
            currentUserPicks.forEach(abbr => {
                const teamData = getTeamDataByAbbr(abbr);
                // budgetRemaining is updated using the float rating value
                if(teamData) budgetRemaining -= teamData.rating;
            });

            updatePickScreenUI(); // Use the new consolidated update function
            showScreen(pickTeamsScreen);
        }
        
        function goToSummaryScreen() {
            renderSummaryScreen();
            showScreen(summaryScreen);
        }


        // --- 7. Dashboard/Table Rendering ---

        function renderUserTable() {
            
            // 1. Calculate total points and prepare a sortable list of users
            const usersWithCalculatedPoints = userDatabase.map(user => {
                let totalPoints = 0;
                // Calculate points based on the user's specific team picks
                TEAM_KEYS.forEach((key) => {
                    // Get the team name directly from the user data (e.g., user.team1)
                    const teamName = user[key]; 
                    
                    // Check if a team name exists in the column (i.e., it was picked)
                    const isPicked = !!teamName && teamName.trim() !== ''; 
                    
                    if (isPicked) {
                        const teamData = teamsDatabase[teamName]; // Look up data by name
                        if (teamData) {
                            totalPoints += teamData.points;
                        }
                    }
                });
                return { ...user, totalPoints };
            });

            // 2. Sort the users based on totalPoints (highest score first)
            usersWithCalculatedPoints.sort((a, b) => b.totalPoints - a.totalPoints);
            
            let tableHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                        <thead class="bg-indigo-600 text-white shadow-lg">
                            <tr>
                                <th class="sticky left-0 px-4 py-3 text-left text-sm font-bold uppercase tracking-wider bg-indigo-700 rounded-tl-lg">Name</th>
                                ${GENERIC_TEAM_HEADERS.map(h => `<th class="px-3 py-3 text-center text-sm font-bold uppercase tracking-wider">
                                    ${h}
                                </th>`).join('')}
                                <th class="px-4 py-3 text-center text-sm font-bold uppercase tracking-wider bg-indigo-700 rounded-tr-lg">Total Points</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
            `;

            // 3. Iterate over the sorted list for rendering
            usersWithCalculatedPoints.forEach((user, index) => {
                const totalPoints = user.totalPoints; // Use the pre-calculated points
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tableHtml += `<tr class="hover:bg-indigo-100 transition duration-150 ${rowClass}">`;
                
                tableHtml += `<td class="sticky left-0 px-4 py-3 whitespace-nowrap font-medium text-gray-900 text-left bg-inherit">${user.name}</td>`;
                
                // Team Columns
                TEAM_KEYS.forEach((key) => {
                    // Get the team name specified in the user's data for this slot
                    const teamName = user[key];
                    const isPicked = !!teamName && teamName.trim() !== ''; 
                    let cellContent = `<span class="text-red-500 italic text-sm">–</span>`; // Default if not picked

                    if (isPicked) {
                        const teamData = teamsDatabase[teamName];
                        
                        if (teamData) {
                            const abbr = teamData.abbr;

                            // Make the team display clickable
                            cellContent = `
                                <button onclick="showTeamModal('${abbr}')" 
                                        class="group focus:outline-none p-1 rounded-lg transition duration-150 hover:bg-indigo-100">
                                    <div class="flex flex-col items-center">
                                        <img src="${teamData.image}" 
                                                alt="${teamData.team} logo" 
                                                class="w-8 h-8 rounded-full object-cover mb-1 border border-gray-200 group-hover:shadow-md"
                                                onerror="this.onerror=null; this.src='https://placehold.co/32x32/374151/ffffff?text=${teamData.abbr}';"
                                        >
                                        <span class="text-indigo-700 font-extrabold text-lg">${teamData.abbr}</span>
                                        <span class="text-xs text-gray-600 font-bold mt-0.5">${teamData.points} Pts</span>
                                    </div>
                                </button>
                            `;
                        }
                    } 
                    
                    // CHANGED px-4 to px-3 to reduce column margin
                    tableHtml += `<td class="px-3 py-3 whitespace-nowrap text-center">${cellContent}</td>`;
                });
                
                // Total Points Column (Kept px-4)
                tableHtml += `
                    <td class="px-4 py-3 whitespace-nowrap text-center bg-indigo-50 font-extrabold text-lg">
                        <span class="text-green-600">${totalPoints}</span>
                    </td>
                `;

                tableHtml += `</tr>`;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContainer.innerHTML = tableHtml;
        }

        // --- 8. Pick Screen Logic and Rendering ---
        
        // New function to render the sticky top bar
        function renderPickingHeader() {
            if (!pickingHeaderBar) return;

            // Structure to place title left and budget right, ensuring no wrap
            const headerContent = `
                <h2 class="text-xl font-extrabold text-indigo-700 whitespace-nowrap">Pick your 6 teams</h2>
                
                <!-- STACKED BUDGET DISPLAY -->
                <div class="flex flex-col items-center ml-4 flex-shrink-0">
                    <span class="text-xs font-medium text-gray-400 -mb-0.5">BUDGET REMAINING</span>
                    <span class="text-lg font-bold text-yellow-600 leading-tight">⭐${formatRating(budgetRemaining)}</span>
                </div>
            `;
            
            pickingHeaderBar.innerHTML = headerContent;
        }

        // Consolidated function to update all dynamic UI elements on the picking screen
        function updatePickScreenUI() {
            renderPickingHeader();
            renderPickScreen();
            renderPickedTeamsBar();
        }

        function getFixtures() {
            const fixtures = [];
            const processedMatchups = new Set(); 

            for (const teamName in teamsDatabase) {
                const homeTeamData = teamsDatabase[teamName];
                const opponentName = homeTeamData.opponent;

                const matchKey = [teamName, opponentName].sort().join(' vs ');

                if (!processedMatchups.has(matchKey)) {
                    const awayTeamData = teamsDatabase[opponentName];

                    if (awayTeamData) {
                        fixtures.push({
                            home: homeTeamData,
                            away: awayTeamData
                        });
                        processedMatchups.add(matchKey);
                    }
                }
            }
            return fixtures;
        }
        
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationMessage.classList.remove('hidden');
            setTimeout(() => {
                notificationMessage.classList.add('hidden');
            }, 3000);
        }

        function handlePick(teamAbbr, buttonElement) {
            const teamData = getTeamDataByAbbr(teamAbbr);
            if (!teamData) return;

            // cost is now a float
            const cost = teamData.rating; 
            const index = currentUserPicks.indexOf(teamAbbr);

            if (index > -1) {
                // Unpick
                currentUserPicks.splice(index, 1);
                // Uses floating point arithmetic
                budgetRemaining += cost;
                
                buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-inner');
                buttonElement.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                buttonElement.innerHTML = 'Pick';
            } else {
                // Attempt to pick
                if (currentUserPicks.length >= MAX_PICKS) {
                    showNotification("Maximum 6 teams picked. Please unpick a team first.");
                    return; 
                } else if (budgetRemaining < cost) {
                    // This block should ideally not be hit if the button is disabled, but serves as a final check
                    showNotification(`Insufficient budget. This team costs ⭐${formatRating(cost)}, but you only have ⭐${formatRating(budgetRemaining)} remaining.`);
                    return;
                }
                
                currentUserPicks.push(teamAbbr);
                // Uses floating point arithmetic
                budgetRemaining -= cost;
                
                buttonElement.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                buttonElement.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-inner');
                buttonElement.innerHTML = 'Picked &nbsp;&#10003;';
            }
            
            // Update all UI elements
            updatePickScreenUI();
        }
        
        function renderPickedTeamsBar() {
            if (!pickedTeamsBar) return;

            const pickedTeamDetails = currentUserPicks.map(abbr => getTeamDataByAbbr(abbr)).filter(detail => detail !== null);
            
            const imageTiles = pickedTeamDetails.map(team => `
                <div class="relative group flex-shrink-0" title="${team.team} (${formatRating(team.rating)} Stars)">
                    <img src="${team.image}" 
                         alt="${team.abbr} logo" 
                         class="w-10 h-10 rounded-full object-cover border-2 border-white transition duration-200 group-hover:scale-105"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/f3f4f6/374151?text=${team.abbr}';"
                    >
                    <!-- Hover text for rating, using formatRating -->
                    <span class="absolute top-0 right-0 text-xs font-bold text-yellow-300 bg-gray-800 px-1 py-0.5 rounded-full opacity-0 group-hover:opacity-100 transition duration-150 transform -translate-y-1/2 translate-x-1/2">
                        ⭐${formatRating(team.rating)}
                    </span>
                </div>
            `).join('');

            const barContent = `
                <div class="flex items-center justify-between max-w-6xl mx-auto px-2">
                    
                    <!-- Left Side: Picked Teams -->
                    <div class="flex items-center space-x-2 flex-1 min-w-0"> 
                        <div id="picked-images-container" class="flex space-x-2 overflow-x-auto py-1 w-full flex-1">
                            ${imageTiles}
                            <!-- Placeholder to ensure minimum of 6 spots are visible -->
                            ${[...Array(MAX_PICKS - pickedTeamDetails.length)].map((_, i) => `
                                <div key=${i} class="w-10 h-10 rounded-full border-2 border-gray-700 bg-gray-800 flex items-center justify-center text-gray-500 text-xs font-semibold flex-shrink-0">
                                    ${i + pickedTeamDetails.length + 1}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Right Side: DONE Button (Budget removed from here) -->
                    <div class="flex items-center space-x-3 flex-shrink-0 ml-3"> 
                        <button onclick="goToSummaryScreen()" 
                                class="bg-green-600 text-white py-2 px-3 rounded-lg font-bold text-sm hover:bg-green-700 transition duration-200 shadow-lg">
                            DONE
                        </button>
                    </div>
                </div>
            `;

            pickedTeamsBar.innerHTML = barContent;
        }

        function createTeamTile(teamData, isHomeTeam) {
            const abbr = teamData.abbr;
            const isPicked = currentUserPicks.includes(abbr);
            const cost = teamData.rating; // Cost is a float

            // Check if the team is affordable (Request 1)
            const isAffordable = cost <= budgetRemaining;
            
            // Define base classes
            // NOTE: Added 'relative' to the tileClasses for absolute positioning of the record
            let tileClasses = 'border-2 border-gray-300 bg-white shadow-lg flex-shrink-0 transition duration-200 relative';
            let buttonClasses = 'w-full text-white py-1.5 rounded-lg font-semibold transition duration-150';
            let buttonText = '';
            let disabledAttribute = '';

            if (isPicked) {
                // Picked state (always allowed to unpick)
                buttonClasses += ' bg-green-600 hover:bg-green-700 shadow-inner';
                buttonText = 'Picked &nbsp;&#10003;';
                tileClasses += ' border-green-400';
            } else if (!isAffordable) {
                // Unaffordable state: Grey out and disable
                tileClasses += ' bg-gray-100 opacity-60 cursor-not-allowed';
                buttonClasses += ' bg-red-400 cursor-not-allowed';
                buttonText = 'Unaffordable';
                disabledAttribute = 'disabled';
            } else {
                // Available to pick state
                tileClasses += ' hover:bg-gray-50';
                buttonClasses += ' bg-indigo-600 hover:bg-indigo-700';
                buttonText = 'Pick';
            }
            
            // CORRECTED: Ensure all requested elements (Image, Abbr, Rating, Record) are displayed.
            return `
                <div class="flex-1 flex flex-col items-center p-3 rounded-xl ${tileClasses}">
                    
                    <!-- Team's form/record (Record) - NEW ABSOLUTE POSITION TOP RIGHT -->
                    <span class="absolute top-3 right-3 text-xs text-gray-600 font-semibold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-200">
                        ${teamData.record}
                    </span>

                    <!-- Team Image -->
                    <img src="${teamData.image}" 
                         alt="${teamData.team} logo" 
                         class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-gray-100"
                         onerror="this.onerror=null; this.src='https://placehold.co/64x64/374151/ffffff?text=${abbr}';"
                    >
                    <!-- 2/3 letter abbreviation (Abbr) -->
                    <span class="text-3xl font-extrabold text-indigo-700 leading-none mb-1">${abbr}</span>
                    <!-- Star-value (Rating) - Added mb-3 for spacing above button -->
                    <span class="text-lg font-bold text-yellow-600 mb-3">⭐${formatRating(teamData.rating)}</span>
                    
                    <!-- Pick/Picked Button -->
                    <button onclick="handlePick('${abbr}', this)"
                            ${disabledAttribute}
                            class="${buttonClasses}">
                        ${buttonText}
                    </button>
                </div>
            `;
        }

        function renderPickScreen() {
            const fixtures = getFixtures();
            let fixturesHtml = '';

            fixtures.forEach(fixture => {
                fixturesHtml += `
                    <div class="bg-white p-3 rounded-xl shadow-xl flex flex-row space-x-2 items-center justify-center border border-gray-200 w-full">
                        ${createTeamTile(fixture.home, true)}
                        <span class="text-xl font-bold text-gray-700 mx-2">vs</span>
                        ${createTeamTile(fixture.away, false)}
                    </div>
                `;
            });

            fixturesContainer.innerHTML = fixturesHtml;
        }
        
        // --- 9. Summary Screen Rendering ---
        
        function renderSummaryScreen() {
            const pickedTeamDetails = currentUserPicks.map(abbr => {
                for (const teamName in teamsDatabase) {
                    if (teamsDatabase[teamName].abbr === abbr) {
                        return teamsDatabase[teamName];
                    }
                }
                return null;
            }).filter(detail => detail !== null);
            
            if (pickedTeamDetails.length === 0) {
                summaryContainer.innerHTML = `<p class="text-xl text-gray-500">You haven't made any picks yet!</p>`;
                return;
            }
            
            let listHtml = pickedTeamDetails.map(team => `
                <li class="flex justify-between items-center space-x-4 py-3 px-4 bg-gray-100 rounded-lg shadow-sm">
                    <div class="flex items-center space-x-4">
                        <img src="${team.image}" 
                             alt="${team.team} logo" 
                             class="w-10 h-10 rounded-full object-cover border-2 border-white"
                             onerror="this.onerror=null; this.src='https://placehold.co/40x40/374151/ffffff?text=${team.abbr}';"
                        >
                        <span class="text-xl font-semibold text-gray-800">${team.team}</span>
                    </div>
                    <!-- Display rating using formatRating -->
                    <span class="text-xl font-bold text-yellow-600">⭐${formatRating(team.rating)}</span>
                </li>
            `).join('');

            summaryContainer.innerHTML = `
                <ul class="space-y-3 max-w-sm mx-auto mb-4">
                    ${listHtml}
                </ul>
            `;
        }
        
        // --- 10. Modal Functions (Updated to include Match Breakdown Table) ---
        
        /**
         * Helper function to render the team image, abbreviation, and match points 
         * for the modal's matchup display (Columns 1 and 3).
         * @param {Object} data - Team data object.
         * @param {boolean} isClickedTeam - True if this is the team the user clicked on (align left).
         */
        const renderAbbrDisplay = (data, isClickedTeam) => {
            if (!data) return `<div class="text-center"><span class="text-gray-400">N/A</span></div>`;
            
            const borderColor = isClickedTeam ? 'border-indigo-500' : 'border-gray-400';
            
            // Outer container alignment: align the entire block left or right in the grid column
            const outerAlign = isClickedTeam ? 'items-start' : 'items-end';

            // Inner container structure: Image and text side-by-side
            const innerFlex = isClickedTeam ? 'flex-row' : 'flex-row-reverse';
            
            // Extract match-points from parsed details
            const breakdown = parseMatchDetails(data.details);
            // Use the new match-points key
            const matchPoints = breakdown['match-points'] || 0; 

            return `
                <div class="flex flex-col ${outerAlign} space-y-2">
                    
                    <!-- Row 1: Image and Abbreviation -->
                    <div class="flex items-center space-x-2 ${innerFlex} w-full">
                        <img src="${data.image}" 
                             alt="${data.abbr} logo" 
                             class="w-12 h-12 rounded-full object-cover border-2 ${borderColor} flex-shrink-0"
                             onerror="this.onerror=null; this.src='https://placehold.co/48x48/6366f1/ffffff?text=${data.abbr}';"
                        >
                        <span class="text-2xl font-extrabold text-gray-900 leading-none">${data.abbr}</span>
                    </div>

                    <!-- Row 2: Match Points (Updated styling) -->
                    <div class="text-sm font-normal text-gray-600">
                        <span class="text-lg font-normal text-gray-900">${matchPoints}</span>
                    </div>
                </div>
            `;
        };

        function showTeamModal(abbr) {
            const teamData = getTeamDataByAbbr(abbr);
            if (!teamData) return;

            // --- 1. Get Opponent Data ---
            const opponentName = teamData.opponent;
            const opponentData = teamsDatabase[opponentName];
            
            // --- 2. New 3-Column Matchup Display (Uses the updated renderAbbrDisplay) ---
            const matchupHtml = `
                <div class="grid grid-cols-[1fr,auto,1fr] items-center p-3 rounded-xl bg-indigo-100 border border-indigo-300 shadow-lg mb-3">
                    
                    <!-- Column 1: Clicked Team (Left, isClickedTeam=true) -->
                    ${renderAbbrDisplay(teamData, true)}

                    <!-- Column 2: VS (Center, smallest column) -->
                    <div class="text-2xl font-extrabold text-indigo-700 mx-2 text-center flex-shrink-0">
                        vs
                    </div>

                    <!-- Column 3: Opponent Team (Right, isClickedTeam=false) -->
                    ${renderAbbrDisplay(opponentData, false)}
                </div>
            `;


            // --- 3. Parse Match Breakdown Data ---
            const breakdown = parseMatchDetails(teamData.details);

            // Updated breakdown labels: removed 'Match points (Bonus)' row
            const breakdownDataLabels = [
                { label: 'Outcome', key: 'Outcome' },
                { label: 'Touchdowns', key: 'Touchdowns' },
                { label: 'Receiving', key: 'Receiving' },
                { label: 'Rushing', key: 'Rushing' },
                { label: 'Turnovers', key: 'Turnovers' },
                { label: 'Touchdowns conceded', key: 'Touchdowns conceded' },
            ];
            
            // --- 4. Generate Match Breakdown Table HTML ---
            const breakdownTableHTML = `
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <!-- Updated header to 'Match stats' -->
                    <h3 class="text-lg font-bold text-gray-800 mb-3 text-left">Match stats</h3> 
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg overflow-hidden border border-gray-100">
                            <tbody class="bg-white divide-y divide-gray-100 text-left">
                                ${breakdownDataLabels.map(item => `
                                    <tr class="hover:bg-indigo-50 transition duration-100">
                                        <!-- px-2 used instead of px-4 to reduce horizontal padding -->
                                        <td class="px-2 py-2.5 whitespace-nowrap text-sm font-medium text-gray-700">${item.label}</td>
                                        <td class="px-2 py-2.5 whitespace-nowrap text-sm text-gray-900 font-semibold">${breakdown[item.key] || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // --- 5. Record and Rating block ---
            const recordRatingHtml = `
                <div class="flex justify-center space-x-6 mb-6 text-base font-medium text-gray-500">
                    <div>Record: <span class="text-gray-800 font-semibold">${teamData.record}</span></div>
                    <!-- Display rating using formatRating -->
                    <div>Rating: <span class="text-yellow-600 font-semibold">⭐${formatRating(teamData.rating)}</span></div>
                </div>
            `;
            
            // --- 6. Opponent and Points block (using new matchupHtml) ---
            const summaryBoxesHtml = `
                <div class="flex flex-col space-y-3 mb-6">
                    <!-- New 3-Column Matchup Info -->
                    ${matchupHtml}

                    <!-- Total Points Field - Using a neutral background -->
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center border border-gray-200 shadow-md">
                        <label class="text-lg font-semibold text-gray-700">Total points scored:</label>
                        <div class="text-2xl font-bold text-green-600">${teamData.points}</div>
                    </div>
                </div>
            `;


            // --- 7. Populate Modal Content ---
            modalContent.innerHTML = `
                <h3 class="text-2xl font-extrabold text-indigo-700 pt-2 mb-4">${teamData.team}</h3>
                
                <!-- Team Image (Large) -->
                <div class="mb-3 flex justify-center">
                    <img src="${teamData.image}" 
                         alt="${teamData.team} logo" 
                         class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 shadow-xl"
                         onerror="this.onerror=null; this.src='https://placehold.co/96x96/374151/ffffff?text=${teamData.abbr}';"
                    >
                </div>
                
                ${recordRatingHtml} 
                
                ${summaryBoxesHtml} 
                
                ${breakdownTableHTML} 
            `;

            // Display Modal
            teamModal.classList.remove('hidden');
            teamModal.classList.add('flex');
        }

        function closeTeamModal() {
            teamModal.classList.add('hidden');
            teamModal.classList.remove('flex');
        }


        // --- 11. Initialization ---

        window.onload = function() {
            // Populate the in-memory databases
            userDatabase = csvToArray(CSV_DATA);
            teamsDatabase = csvToMap(TEAMS_CSV_DATA, 'team');
            
            // Start directly on the dashboard screen
            goToDashboardScreen();
        };
    </script>
</body>
</html>