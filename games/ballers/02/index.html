<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Stage Football Player Picker</title>
    <!-- Bootstrap 5 CSS CDN for responsive layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Google Font for better aesthetics -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- STYLES (Light Theme Restoration) --- */
        :root {
            /* Define primary colors */
            --def-color: #17A2B8; /* Defender color (Cyan/Info) */
            --mid-color: #6F42C1; /* Midfielder color (Indigo/Purple) */
            --att-color: #28A745; /* Attacker color (Success/Green) */
            --primary-color: #007bff; /* Standard Bootstrap Primary */
            --header-height: 65px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Light gray background */
            color: #333; /* Dark text color */
            padding-top: var(--header-height);
            padding-bottom: 20px;
        }
        
        /* Fixed Header Bar Styling */
        .app-header {
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        .header-title {
            font-size: 1.8rem; 
            font-weight: 900; 
            color: var(--primary-color);
            flex-shrink: 0;
            margin-right: 1rem;
        }
        .header-subtitle {
            font-size: 1rem; 
            font-weight: 700; 
            text-align: center;
            flex-grow: 1; 
            color: #6c757d; 
        }
        
        /* UPDATED: Header Section for Pick Screens (Flex layout) */
        .header-section {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .grid-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* UPDATED: Reduced Header Size for Pick Screens */
        .grid-category-header {
            color: var(--primary-color);
            font-size: 1.5rem; /* Reduced size from 1.8rem */
            letter-spacing: normal;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 0; /* Important for flex alignment */
        }
        .pick-limit-msg {
            color: #6c757d; /* Muted text */
            font-weight: 700;
            margin-bottom: 0; /* Important for flex alignment */
        }

        /* --- Tile Styling (Light Theme) --- */
        .player-tile {
            position: relative; /* CRITICAL: Allows absolute positioning of the badge */
            height: 200px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around; 
            margin-bottom: 20px;
            padding: 10px;
            background-color: #fff; /* White tile background */
            color: #333;
            border-radius: 8px;
            border: 1px solid #ddd; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            text-align: center;
            font-weight: 700;
            transition: all 0.3s ease;
            overflow: hidden;
            transform-style: preserve-3d;
            transform: perspective(1000px); 
        }
        
        /* Summary State (Visually identical to .revealed, but non-interactive) */
        .player-tile.is-summary {
            pointer-events: none; /* Disable interaction */
            border: 2px solid #ddd; /* Slightly bolder border */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); 
            transform: none; /* Reset 3D transforms */
            transition: none;
        }
        .player-tile.is-summary .player-info {
            opacity: 1;
        }
        .player-tile.is-summary .btn-tile-pick {
            display: none; /* Hide the button */
        }
        /* End Summary State */
        
        /* Picked State */
        .player-tile.is-picked {
            border-color: var(--att-color); 
            background-color: #E6F7ED; /* Light green tint */
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5); /* Subtle green shadow */
            transform: none;
        }
        
        /* --- PLAYER IMAGE STYLING --- */
        .player-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px; /* Space between image and name */
            border: 3px solid #ced4da; /* Light border */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* --- TEAM BADGE IMAGE STYLING (Top Right) --- */
        .team-badge-image {
            position: absolute;
            top: 8px; /* Offset from top */
            right: 8px; /* Offset from right */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff; /* White border for contrast */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        /* --- POSITION BADGE STYLING (Top Left) --- */
        .position-top-left-badge {
            position: absolute;
            top: 8px; /* Offset from top */
            left: 8px; /* Offset from left */
            font-size: 0.85rem;
            font-weight: 900;
            padding: .25em .5em;
            border-radius: .25rem;
            color: #fff;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* --- PLAYER INFO AND TEXT ALIGNMENT --- */
        .player-tile .player-info {
            opacity: 0;
            transition: opacity 0.5s; /* Only transition opacity */
            height: 140px; 
            display: flex;
            flex-direction: column;
            align-items: center; /* Ensures content is horizontally centered */
            justify-content: center;
            width: 100%;
        }
        .player-tile.revealed .player-info {
            opacity: 1;
        }
        /* UPDATED: Reduced Surname Font Size */
        .player-name-main {
            font-size: 1.2rem; /* Reduced size from 1.4rem */
            line-height: 1.1;
            margin-bottom: 5px;
            font-weight: 900;
            text-shadow: none;
            padding-right: 5px; 
            text-align: center; /* Explicitly ensure name is centered */
        }
        
        /* Opponent Text */
        .opponent-hint {
            font-size: 0.9rem;
            color: #888; 
            font-weight: 400;
            margin-bottom: 15px; 
            height: 18px;
        }
        /* Summary Points - Enforced black text */
        .summary-points {
            font-size: 1.8rem;
            font-weight: 900;
            line-height: 1;
            margin-top: 5px;
            color: #333; 
        }
        
        /* --- SPINNING EFFECT (X-Axis Flip) --- */
        .player-tile.spinning {
            background: #e9ecef; /* Light gray during spin */
            animation: card-flip-animation 0.1s infinite linear;
            border-color: #adb5bd;
            box-shadow: none;
        }
        .player-tile.spinning .player-info,
        .player-tile.spinning .opponent-hint,
        .player-tile.spinning .btn {
            opacity: 0;
            pointer-events: none;
        }
        .player-tile.spinning .team-badge-image { /* Hide the team badge during spin */
             opacity: 0;
        }
        .player-tile.spinning .position-top-left-badge { /* Hide new badge during spin */
             opacity: 0;
        }

        /* Keyframes for X-Axis Rotation */
        @keyframes card-flip-animation {
            from { transform: perspective(1000px) rotateX(0deg); }
            to { transform: perspective(1000px) rotateX(360deg); }
        }
        /* --- END SPINNING EFFECT --- */

        /* --- Button Styling --- */
        .btn-shuffle {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: none !important; /* REMOVED SHADOW */
            font-size: 1rem;
            padding: 8px 18px;
            border-radius: 50px;
        }
        /* Style for the regular weight spin count text inside the button */
        .btn-shuffle .fw-normal {
            font-weight: 400 !important;
        }

        .btn-tile-pick {
            width: 90%; 
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
            
            /* Standard Button Style */
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            box-shadow: none;
        }
        .btn-tile-pick:hover {
            background: var(--primary-color);
            color: white;
        }
        .btn-tile-pick.btn-success {
            /* Picked Button state */
            background-color: var(--att-color);
            border-color: var(--att-color);
            color: white;
        }

        /* Next Stage Button */
        .btn-next-stage, .btn-save-picks {
            width: 100%;
            margin-top: 30px;
            padding: 15px;
            font-size: 1.3rem;
            border-radius: 8px;
            font-weight: 700;
            background: var(--primary-color);
            border: none;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
            transition: all 0.3s;
        }
        .btn-next-stage:hover, .btn-save-picks:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.5);
        }
        .btn-next-stage:disabled, .btn-save-picks:disabled {
            background: #6c757d !important;
            box-shadow: none !important;
            transform: none !important;
            opacity: 0.7;
        }

        /* Summary View Styling */
        #summary-view {
            display: none;
        }
        
        /* --- POSITION BADGE COLORS --- */
        .badge-def {
            background-color: var(--def-color) !important;
        }
        .badge-mid {
            background-color: var(--mid-color) !important;
        }
        .badge-att {
            background-color: var(--att-color) !important;
        }
        /* End Position Badge Styling */

        .text-primary {
            color: var(--primary-color) !important;
        }
        .text-muted {
            color: #6c757d !important;
        }
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        /* Summary Header Styling */
        #summaryHeader {
            font-weight: 900;
            font-size: 2.5rem; /* Larger font size for emphasis */
        }
        
        /* Leaderboard Styling */
        .leaderboard-table th, .leaderboard-table td {
            font-size: 1.05rem;
            padding: 12px;
            vertical-align: middle;
        }
        .leaderboard-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
        }
        .leaderboard-table .table-info {
            background-color: #CCE5FF !important; /* Lighter blue for user row */
            color: var(--primary-color) !important;
            font-weight: 900 !important;
            border-top: 3px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Fixed Header Bar -->
    <header class="fixed-top bg-white shadow app-header px-3">
        <!-- Left: BALLERS -->
        <div class="header-title">BALLERS</div>
        
        <!-- Center: EPL week 2 -->
        <div class="header-subtitle text-muted">EPL week 2</div>

        <!-- Right: SPIN Button (Now powered by globalSpinsRemaining) -->
        <!-- Updated: Removed shadow class and added required structure for font weight control -->
        <button id="shuffleButton" class="btn btn-primary btn-shuffle" onclick="startShuffle(currentGameIndex)">
            <span id="buttonText">SPIN <span class="fw-normal">(3 left)</span></span>
        </button>
    </header>
    <!-- END Fixed Header Bar -->
    
    <div class="container grid-container">

        <!-- ==================================== -->
        <!-- SCREEN 1: DEFENDERS VIEW -->
        <!-- Updated: Added d-flex and justify-content-between to header-section -->
        <!-- ==================================== -->
        <div id="shuffler-container">
            
            <div id="game-0-view" class="game-view" data-game-index="0" style="display: none;">
                <!-- UPDATED LAYOUT -->
                <div class="header-section">
                    <h2 class="grid-category-header">DEFENDERS</h2>
                    <!-- Changed '0/3 players picked' to '0/3 picked' -->
                    <p id="pick-limit-0" class="pick-limit-msg text-primary">0 / 3 picked</p>
                </div>
                <div id="playerGrid-0" class="row mt-2">
                    <!-- Tiles for Game 1 (g0) -->
                    <div class="col-4"><div id="tile-g0-t0" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 0)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t1" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 1)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t2" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 2)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t3" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 3)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t4" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 4)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t5" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 5)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t6" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 6)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t7" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 7)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g0-t8" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(0, 8)">PICK</button></div></div>
                </div>
                <!-- Updated Button Text (Initial) -->
                <button id="nextButton-0" class="btn btn-next-stage btn-success shadow-lg" onclick="handleNextStage()">
                    Pick Midfielders... <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <!-- ==================================== -->
            <!-- SCREEN 2: MIDFIELDERS VIEW -->
            <!-- Updated: Added d-flex and justify-content-between to header-section -->
            <!-- ==================================== -->
            <div id="game-1-view" class="game-view" data-game-index="1" style="display: none;">
                <!-- UPDATED LAYOUT -->
                <div class="header-section">
                    <h2 class="grid-category-header">MIDFIELDERS</h2>
                    <!-- Changed '0/3 players picked' to '0/3 picked' -->
                    <p id="pick-limit-1" class="pick-limit-msg text-primary">0 / 3 picked</p>
                </div>
                <div id="playerGrid-1" class="row mt-2">
                    <!-- Tiles for Game 2 (g1) -->
                    <div class="col-4"><div id="tile-g1-t0" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 0)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t1" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 1)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t2" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 2)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t3" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 3)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t4" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 4)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t5" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 5)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t6" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 6)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t7" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 7)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g1-t8" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(1, 8)">PICK</button></div></div>
                </div>
                <!-- Updated Button Text (Initial) -->
                <button id="nextButton-1" class="btn btn-next-stage btn-success shadow-lg" onclick="handleNextStage()">
                    Pick Attackers <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            
            <!-- ==================================== -->
            <!-- SCREEN 3: ATTACKERS VIEW -->
            <!-- Updated: Added d-flex and justify-content-between to header-section -->
            <!-- ==================================== -->
            <div id="game-2-view" class="game-view" data-game-index="2" style="display: none;">
                <!-- UPDATED LAYOUT -->
                <div class="header-section">
                    <h2 class="grid-category-header">ATTACKERS</h2>
                    <!-- Changed '0/3 players picked' to '0/3 picked' -->
                    <p id="pick-limit-2" class="pick-limit-msg text-primary">0 / 3 picked</p>
                </div>
                <div id="playerGrid-2" class="row mt-2">
                    <!-- Tiles for Game 3 (g2) -->
                    <div class="col-4"><div id="tile-g2-t0" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 0)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t1" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 1)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t2" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 2)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t3" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 3)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t4" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 4)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t5" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 5)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t6" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 6)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t7" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 7)">PICK</button></div></div>
                    <div class="col-4"><div id="tile-g2-t8" class="player-tile"><span class="player-info"><img class="player-image" src="" alt="Player Image Placeholder"><span class="player-name-main"></span></span><span class="opponent-hint"></span><button class="btn btn-tile-pick btn-outline-primary" onclick="pickPlayer(2, 8)">PICK</button></div></div>
                </div>
                <!-- Updated Button Text (Initial) -->
                <button id="nextButton-2" class="btn btn-save-picks btn-success shadow-lg" onclick="handleNextStage()">
                    Save picks <i class="fas fa-arrow-right"></i>
                </button>
            </div>

        </div>

        <!-- ==================================== -->
        <!-- SCREEN 4: SUMMARY VIEW (UPDATED) -->
        <!-- ==================================== -->
        <div id="summary-view" class="mt-5">
            <!-- Header now dynamically updated to show Total Points -->
            <h2 id="summaryHeader" class="text-primary text-center mb-4">Team Selection Summary</h2> 

            <!-- Player Grid Container (Now centered and contains only tiles) -->
            <div id="summaryGrid" class="container row justify-content-center mx-auto">
                <!-- Grid content inserted by JS -->
            </div>
            
            <!-- Leaderboard Container -->
            <h3 class="text-center mt-5 mb-3 text-muted">Global Leaderboard</h3>
            <div id="leaderboard" class="container">
                <!-- Leaderboard inserted by JS -->
            </div>

            <div class="text-center mt-5">
                <button class="btn btn-secondary btn-lg" onclick="startNewGame()">
                    <i class="fas fa-undo"></i> Start New Team Selection
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TEAM_DATA = {
            "Man City": { abbr: "MCI", color: "#6CABDD" },
            "Newcastle": { abbr: "NEW", color: "#383838" },
            "Arsenal": { abbr: "ARS", color: "#EF0107" },
            "Liverpool": { abbr: "LIV", color: "#C8102E" },
            "Man United": { abbr: "MUN", color: "#DA291C" },
            "Tottenham": { abbr: "TOT", color: "#132257" },
            "Chelsea": { abbr: "CHE", color: "#034694" },
            "Aston Villa": { abbr: "AVL", color: "#490024" },
            "Notts Forest": { abbr: "FOR", color: "#DD0000" },
            "Crystal Palace": { abbr: "CRY", color: "#1B458F" },
            "Fulham": { abbr: "FUL", color: "#FFFFFF", border: true, text: "#000000" }, /* Added text color for white badges */
            "West Ham": { abbr: "WHU", color: "#7A263A" },
            "Brentford": { abbr: "BRE", color: "#E30613" },
            "Bournemouth": { abbr: "BOU", color: "#DA291C" },
            "Brighton": { abbr: "BHA", color: "#0057B8" },
            "default": { abbr: "N/A", color: "#6c757d" }
        };

        const EPL_OPPONENTS = [
            "Wolves", "Everton", "Fulham", "Palace", "Luton", 
            "West Ham", "Burnley", "Spurs", "Liverpool", "Brighton",
            "Villa", "Forest", "Cherries", "Seagulls"
        ];
        
        // Data refreshed from EAFC 26 ratings - ALL.csv.
        const csvContent = `PLAYER,RATING ,Position,Team
Erling Haaland,90,ATT,Man City
Alexander Isak,88,ATT,Liverpool
Bukayo Saka,88,ATT,Arsenal
Viktor Gyökeres,87,ATT,Arsenal
Bryan Mbeumo,85,ATT,Man United
Phil Foden,85,ATT,Man City
Ollie Watkins,84,ATT,Aston Villa
Omar Marmoush,84,ATT,Man City
Anthony Gordon,83,ATT,Newcastle
Hugo Ekitiké,83,ATT,Liverpool
Leandro Trossard,83,ATT,Arsenal
Kai Havertz,82,ATT,Arsenal
Jean-Philippe Mateta,82,ATT,Crystal Palace
Yoane Wissa,82,ATT,Newcastle
Savinho,82,ATT,Man City
Chris Wood,82,ATT,Notts Forest
Jacob Murphy,81,ATT,Newcastle
Gabriel Martinelli,81,ATT,Arsenal
Anthony Elanga,81,ATT,Newcastle
Randal Kolo Muani,81,ATT,Tottenham
Rayan Cherki,81,ATT,Man City
Mohammed Kudus,80,ATT,Tottenham
Noni Madueke,80,ATT,Arsenal
Jack Grealish,80,ATT,Everton
Benjamin Šeško,80,ATT,Man United
Gabriel Jesus,80,ATT,Man City
Harvey Barnes,80,ATT,Newcastle
Jérémy Doku,80,ATT,Man City
Dominic Solanke,80,ATT,Bournemouth
João Pedro,79,ATT,Brighton
Brennan Johnson,79,ATT,Tottenham
Richarlsson,78,ATT,Tottenham
Amine Adli,78,ATT,Liverpool
Danny Welbeck,78,ATT,Brighton
Liam Delap,78,ATT,Chelsea
Callum Wilson,78,ATT,Newcastle
Maxwel Cornet,77,ATT,West Ham
Darwin Núñez,77,ATT,Liverpool
Armando Broja,77,ATT,Fulham
Declan Rice,89,MID,Arsenal
Rodri,88,MID,Manchester City
Bruno Guimarães,86,MID,Newcastle United
Enzo Fernández,85,MID,Chelsea
Dominik Szoboszlai,84,MID,Liverpool
Alexis Mac Allister,84,MID,Liverpool
Ezequiel Palacios,84,MID,Tottenham
Pape Matar Sarr,83,MID,Tottenham Hotspur
Harvey Elliott,83,MID,Liverpool
Eberechi Eze,83,MID,Crystal Palace
Bruno Fernandes,83,MID,Manchester United
Conor Gallagher,83,MID,Chelsea
João Palhinha,83,MID,Fulham
Sandro Tonali,82,MID,Newcastle United
James Maddison,82,MID,Tottenham
Kobie Mainoo,82,MID,Manchester United
Lucas Paquetá,82,MID,West Ham United
Tyler Adams,82,MID,Bournemouth
Casemiro,81,MID,Manchester United
Mason Mount,81,MID,Manchester United
Moises Caicedo,81,MID,Chelsea
Héctor Herrera,81,MID,Arsenal
Martin Ødegaard,81,MID,Arsenal
Douglas Luiz,81,MID,Aston Villa
Moussa Diaby,81,MID,Aston Villa
Cole Palmer,80,MID,Chelsea
Cheick Doucouré,80,MID,Crystal Palace
André Onana,80,MID,Nottingham Forest
Jacob Ramsey,80,MID,Aston Villa
Christian Eriksen,80,MID,Manchester United
Matheus Nunes,80,MID,Manchester City
Manuel Akanji,80,MID,Manchester City
Morgan Gibbs-White,80,MID,Nottingham Forest
Diogo Jota,79,MID,Liverpool
Bernardo Silva,79,MID,Manchester City
Hamer Traoré,79,MID,Bournemouth
John McGinn,79,MID,Aston Villa
Kiernan Dewsbury-Hall,79,MID,Chelsea
Trent Alexander-Arnold,78,MID,Liverpool
Kevin De Bruyne,78,MID,Manchester City
Pervis Estupiñán,78,MID,Brighton
Youri Tielemans,78,MID,Aston Villa
Mohammed Salisu,78,MID,Fulham
Max Kilman,78,MID,West Ham United
João Cancelo,78,MID,Manchester City
Solly March,77,MID,Brighton
William Saliba,87,DEF,Arsenal
Rúben Dias,86,DEF,Manchester City
Ibrahima Konaté,86,DEF,Liverpool
Joško Gvardiol,84,DEF,Manchester City
Marc Cucurella,84,DEF,Chelsea
Jeremie Frimpong,83,DEF,Liverpool
Murillo,83,DEF,Nottingham Forest
Nathan Aké,83,DEF,Manchester City
Piero Hincapié,83,DEF,Arsenal
Benjamin White,83,DEF,Arsenal
Nikola Milenković,83,DEF,Nottingham Forest
Pedro Porro,82,DEF,Tottenham
Milos Kerkez,82,DEF,Liverpool
Andrew Robertson,82,DEF,Liverpool
Antonee Robinson,82,DEF,Fulham
Micky van de Ven,82,DEF,Tottenham Hotspur
Ezri Konsa,82,DEF,Aston Villa
Jurriën Timber,82,DEF,Arsenal
Fabian Schär,82,DEF,Newcastle United
John Stones,82,DEF,Manchester City
Matthijs de Ligt,82,DEF,Manchester United
Marc Guéhi,82,DEF,Crystal Palace
Cristian Romero,82,DEF,Tottenham
Sven Botman,82,DEF,Newcastle United
Reece James,81,DEF,Chelsea
Daniel Muñoz,81,DEF,Crystal Palace
Rayan Aït-Nouri,81,DEF,Manchester City
Lisandro Martínez,81,DEF,Manchester United
Aaron Wan-Bissaka,80,DEF,Manchester United
Alex Moreno,80,DEF,Aston Villa
Destiny Udogie,80,DEF,Tottenham Hotspur
Ben Chilwell,80,DEF,Chelsea
James Tarkowski,80,DEF,Everton
Levi Colwill,80,DEF,Chelsea
Virgil van Dijk,79,DEF,Liverpool
Tino Livramento,79,DEF,Newcastle United
Ben Mee,79,DEF,Brentford
Tosin Adarabioyo,79,DEF,Tottenham
Ethan Pinnock,79,DEF,Brentford
Lewis Dunk,79,DEF,Brighton
Tyrone Mings,78,DEF,Aston Villa
Joe Gomez,78,DEF,Liverpool
Issa Diop,78,DEF,Fulham
Lucas Digne,78,DEF,Aston Villa
José Sá,78,DEF,Wolves
Kostas Tsimikas,77,DEF,Liverpool
Luke Shaw,77,DEF,Manchester United
Joel Matip,77,DEF,Liverpool
Manuel Benson,77,DEF,Fulham
`;

        const GAME_TITLES = ["DEFENDERS", "MIDFIELDERS", "ATTACKERS"];
        const NEXT_BUTTON_TEXTS = [
            "Pick Midfielders", 
            "Pick Attackers",  
            "Save picks"       
        ];
        
        // Position mapping for summary display (used for colors)
        const POSITION_MAP = {
            "DEFENDERS": { abbr: "DEF", class: "badge-def" },
            "MIDFIELDERS": { abbr: "MID", class: "badge-mid" },
            "ATTACKERS": { abbr: "ATT", class: "badge-att" }
        };

        // Global state for spins
        let globalSpinsRemaining = 3; 

        let defendersPool = [];
        let midfieldersPool = [];
        let attackersPool = [];
        // Store pools indexed by position (0: DEF, 1: MID, 2: ATT)
        const PLAYER_POOLS = [defendersPool, midfieldersPool, attackersPool]; 
        
        const NUM_GAMES = 3;
        const NUM_TILES = 9;
        const MAX_PICKS_PER_GAME = 3;
        
        // UPDATED: Reduced spin duration by 30% (2500ms * 0.70 = 1750ms)
        const SPIN_DURATION_MS = 1750;

        // State management for all three games
        let gameData = [];
        let currentGameIndex = 0; // 0, 1, or 2

        // --- HELPER FUNCTIONS ---

        /**
         * Extracts the surname (last word) from a player's full name.
         */
        function getSurname(fullName) {
            if (!fullName) return '';
            const parts = fullName.split(' ').filter(p => p.trim() !== ''); // Filter out empty strings from multiple spaces
            return parts[parts.length - 1] || '';
        }

        /**
         * Normalizes team names from the CSV to match the simplified TEAM_DATA keys.
         */
        function normalizeTeamName(teamName) {
            if (!teamName) return 'default';
            const norm = teamName.toLowerCase().trim();
            if (norm.includes('manchester city')) return 'Man City';
            if (norm.includes('manchester united')) return 'Man United';
            if (norm.includes('newcastle united')) return 'Newcastle';
            if (norm.includes('nottingham forest')) return 'Notts Forest';
            if (norm.includes('tottenham hotspur') || norm.includes('tottenham')) return 'Tottenham';
            if (norm.includes('aston villa')) return 'Aston Villa';
            if (norm.includes('crystal palace')) return 'Crystal Palace';
            if (norm.includes('west ham united')) return 'West Ham';
            if (norm.includes('liverpool')) return 'Liverpool';
            if (norm.includes('arsenal')) return 'Arsenal';
            if (norm.includes('chelsea')) return 'Chelsea';
            if (norm.includes('fulham')) return 'Fulham';
            return teamName.trim(); 
        }

        /**
         * Parses the CSV content, filters players by position, and populates the position pools.
         */
        function parsePlayers(csv) {
            const lines = csv.split('\n');
            defendersPool = [];
            midfieldersPool = [];
            attackersPool = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const columns = line.split(',').map(col => col.trim());
                    if (columns.length >= 4) {
                        const name = columns[0];
                        const position = columns[2].toUpperCase().replace(/\s/g, ''); 
                        const rawTeamName = columns[3]; 
                        
                        const teamKey = normalizeTeamName(rawTeamName);
                        const team = TEAM_DATA[teamKey] || TEAM_DATA['default'];
                        
                        if (name && teamKey && position) {
                            const player = { name: name, teamName: teamKey, teamData: team, position: position, points: null };
                            
                            if (position === 'DEF') {
                                defendersPool.push(player);
                            } else if (position === 'MID') {
                                midfieldersPool.push(player);
                            } else if (position === 'ATT') {
                                attackersPool.push(player);
                            }
                        }
                    }
                }
            }
            PLAYER_POOLS[0] = defendersPool;
            PLAYER_POOLS[1] = midfieldersPool;
            PLAYER_POOLS[2] = attackersPool;

            console.log(`Pools loaded: DEF=${defendersPool.length}, MID=${midfieldersPool.length}, ATT=${attackersPool.length}`);
        }

        /**
         * Initializes the game state.
         */
        function initializeGameData() {
            gameData = [];
            for (let i = 0; i < NUM_GAMES; i++) {
                gameData.push({ 
                    tiles: Array(NUM_TILES).fill(null), 
                    picks: 0 
                });
            }
            globalSpinsRemaining = 3;
        }

        /**
         * Starts a new game/selection process.
         */
        function startNewGame() {
            initializeGameData();
            // Clear all tiles content and picks visually
            for(let g = 0; g < NUM_GAMES; g++) {
                for(let t = 0; t < NUM_TILES; t++) {
                    const tile = document.getElementById(`tile-g${g}-t${t}`);
                    if (tile) {
                         tile.classList.remove('is-picked', 'revealed', 'spinning'); 
                         const teamImg = tile.querySelector('.team-badge-image');
                         if (teamImg) teamImg.style.opacity = 0;
                         const button = tile.querySelector('.btn-tile-pick');
                         button.classList.remove('btn-success');
                         button.classList.add('btn-outline-primary');
                         button.innerHTML = 'PICK';
                    }
                }
            }
            showGame(0);
        }
        
        /**
         * Updates the text and disabled state of the shuffle button and next stage button.
         */
        function updateShuffleButton() {
            const currentData = gameData[currentGameIndex];
            const shuffleButton = document.getElementById('shuffleButton');
            const buttonTextSpan = document.getElementById('buttonText');
            const pickLimitMsg = document.getElementById(`pick-limit-${currentGameIndex}`);

            // UPDATED: Update Spin Button text structure for regular font weight
            buttonTextSpan.innerHTML = `SPIN <span class="fw-normal">(${globalSpinsRemaining} left)</span>`;
            shuffleButton.disabled = globalSpinsRemaining <= 0;

            // UPDATED: Update Pick Count Message (Simplified text)
            pickLimitMsg.textContent = `${currentData.picks} / ${MAX_PICKS_PER_GAME} picked`;
            
            // --- Update Next Stage Button ---
            const nextButton = document.getElementById(`nextButton-${currentGameIndex}`);
            if (nextButton) {
                if (currentData.picks < MAX_PICKS_PER_GAME) {
                    nextButton.disabled = true;
                    const remaining = MAX_PICKS_PER_GAME - currentData.picks;
                    nextButton.textContent = `Pick ${remaining} more to proceed...`;
                } else {
                    nextButton.disabled = false;
                    
                    let nextText = NEXT_BUTTON_TEXTS[currentGameIndex];
                    let icon = ''; 
                    
                    if (currentGameIndex < NUM_GAMES - 1) {
                        icon = ' <i class="fas fa-arrow-right"></i>';
                    } else {
                        icon = ''; 
                    }

                    nextButton.innerHTML = `${nextText} ${icon}`;
                }
            }
        }

        /**
         * Toggles the picked state of a player tile, enforcing the 3-pick limit.
         */
        function pickPlayer(gameId, tileId) {
            const tile = document.getElementById(`tile-g${gameId}-t${tileId}`);
            const button = tile.querySelector('.btn-tile-pick');
            const currentData = gameData[gameId];

            if (!currentData.tiles[tileId]) {
                console.warn("Attempted to pick an un-shuffled tile.");
                return;
            }

            if (tile.classList.contains('is-picked')) {
                // UNPICK
                tile.classList.remove('is-picked');
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
                button.innerHTML = 'PICK';
                
                currentData.picks--;
            } else {
                // PICK
                if (currentData.picks >= MAX_PICKS_PER_GAME) {
                    console.log(`Cannot pick more than ${MAX_PICKS_PER_GAME} players in this stage.`);
                    tile.style.transition = 'border-color 0.1s ease-in-out';
                    tile.style.borderColor = '#dc3545'; // Red flash
                    setTimeout(() => { 
                        tile.style.borderColor = '#ddd'; 
                    }, 300);
                    return; 
                }

                tile.classList.add('is-picked');
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-success');
                button.innerHTML = '<i class="fas fa-check"></i> PICKED';

                currentData.picks++;
            }
            updateShuffleButton(); 
        }

        /**
         * Selects random player objects from the pool specific to the gameId.
         */
        function getRandomPlayers(gameId, count, pickedPlayerNames) {
            const pool = PLAYER_POOLS[gameId]; 
            
            const allPickedNames = [];
            gameData.forEach(game => {
                game.tiles.forEach(tile => {
                    const tileElement = document.getElementById(`tile-g${gameData.indexOf(game)}-t${game.tiles.indexOf(tile)}`);
                    if (tile && tileElement && tileElement.classList.contains('is-picked') && allPickedNames.indexOf(tile.name) === -1) {
                        allPickedNames.push(tile.name);
                    }
                });
            });

            const availablePlayers = pool.filter(player => !allPickedNames.includes(player.name));
            
            if (availablePlayers.length < count) {
                console.warn(`Insufficient unique players in ${GAME_TITLES[gameId]} pool (${availablePlayers.length}). Recycling will occur.`);
                if(pool.length >= count) {
                    const shuffled = [...pool].sort(() => 0.5 - Math.random());
                    return shuffled.slice(0, count);
                } else {
                    return pool;
                }
            }

            const shuffled = [...availablePlayers].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        /**
         * Sets the player name, team badge, and opponent hint for a tile.
         */
        function setTileContent(tile, player, opponent) {
            const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const playerPlaceholderUrl = `https://placehold.co/50x50/007bff/ffffff?text=${initials}`; 
            
            const img = tile.querySelector('.player-image');
            img.src = playerPlaceholderUrl; 
            img.alt = `${player.name} image`;

            const surname = getSurname(player.name); 
            tile.querySelector('.player-name-main').textContent = surname;
            
            const teamAbbr = player.teamData.abbr;
            const textColor = (player.teamData.text || '#FFFFFF').replace('#', '');
            const teamColor = player.teamData.color.replace('#', '');
            const teamPlaceholderUrl = `https://placehold.co/20x20/${teamColor}/${textColor}?text=${teamAbbr}`;
            
            let teamImg = tile.querySelector('.team-badge-image');
            if (!teamImg) {
                teamImg = document.createElement('img');
                teamImg.className = 'team-badge-image';
                teamImg.alt = `${player.teamName} Badge`;
                tile.appendChild(teamImg); 
            }
            
            teamImg.src = teamPlaceholderUrl;

            tile.querySelector('.opponent-hint').textContent = `vs ${opponent}`;
            
            teamImg.style.opacity = 1;
        }

        /**
         * Gets a random opponent team from the list.
         */
        function getRandomOpponent() {
            const randomIndex = Math.floor(Math.random() * EPL_OPPONENTS.length);
            return EPL_OPPONENTS[randomIndex];
        }

        /**
         * Loads all 9 tiles with fresh player data for a new stage and reveals them with a spin animation.
         */
        function loadInitialTiles(gameId) {
            const currentData = gameData[gameId];
            const playerGrid = document.getElementById(`playerGrid-${gameId}`);
            
            const newRandomPlayers = getRandomPlayers(gameId, NUM_TILES, []);
            
            for (let i = 0; i < NUM_TILES; i++) {
                const tile = playerGrid.querySelector(`#tile-g${gameId}-t${i}`);
                const newPlayer = newRandomPlayers[i];
                newPlayer.opponent = getRandomOpponent();
                newPlayer.position = GAME_TITLES[gameId]; 
                currentData.tiles[i] = newPlayer;

                tile.classList.remove('is-picked', 'revealed'); 

                setTileContent(tile, newPlayer, newPlayer.opponent);
                
                tile.classList.add('spinning');
            }

            setTimeout(() => {
                for (let i = 0; i < NUM_TILES; i++) {
                    const tile = playerGrid.querySelector(`#tile-g${gameId}-t${i}`);
                    
                    setTimeout(() => {
                        tile.classList.remove('spinning');
                        tile.classList.add('revealed');
                    }, i * 100); 
                }
            }, 200); 
            
            updateShuffleButton();
        }

        /**
         * Initiates the shuffle and animation sequence for a specific game.
         */
        function startShuffle(gameId) {
            if (globalSpinsRemaining <= 0) {
                updateShuffleButton(); 
                return;
            }

            const currentData = gameData[gameId];
            const shuffleButton = document.getElementById('shuffleButton');
            const playerGrid = document.getElementById(`playerGrid-${gameId}`);
            
            globalSpinsRemaining--; 

            shuffleButton.disabled = true;

            const unpickedTiles = [];
            const pickedPlayerNames = [];

            for (let i = 0; i < NUM_TILES; i++) {
                const tile = playerGrid.querySelector(`#tile-g${gameId}-t${i}`);
                
                if (tile.classList.contains('is-picked')) {
                    const player = currentData.tiles[i];
                    if (player) pickedPlayerNames.push(player.name);
                    tile.classList.remove('spinning'); 
                } else {
                    unpickedTiles.push({ id: i, element: tile });
                    
                    setTileContent(tile, { name: '...', teamData: TEAM_DATA['default'] }, '...');
                    tile.classList.remove('revealed');
                    
                    tile.classList.add('spinning');
                }
            }

            const numToShuffle = unpickedTiles.length;
            if (numToShuffle === 0) {
                globalSpinsRemaining++;
                setTimeout(() => {
                    shuffleButton.disabled = false;
                }, 100); 
                updateShuffleButton();
                return;
            }
            
            const newRandomPlayers = getRandomPlayers(gameId, numToShuffle, pickedPlayerNames);
            const opponentList = Array(numToShuffle).fill(0).map(() => getRandomOpponent());
            
            unpickedTiles.forEach((tileData, index) => {
                const newPlayer = newRandomPlayers[index];
                newPlayer.opponent = opponentList[index];
                newPlayer.position = GAME_TITLES[gameId]; 
                newPlayer.points = null; 
                currentData.tiles[tileData.id] = newPlayer;
            });

            setTimeout(() => {
                unpickedTiles.forEach((tileData, index) => {
                    const tile = tileData.element;
                    const newPlayer = currentData.tiles[tileData.id];

                    tile.classList.remove('spinning');
                    
                    setTimeout(() => {
                        setTileContent(tile, newPlayer, newPlayer.opponent);
                        tile.classList.add('revealed');
                    }, index * 100); 
                });

                setTimeout(() => {
                    shuffleButton.disabled = globalSpinsRemaining <= 0;
                }, numToShuffle * 100 + 100); 
                
                updateShuffleButton();

            }, SPIN_DURATION_MS); 
        }

        /**
         * Logic for moving between stages (Game 1 -> 2 -> 3 -> Summary).
         */
        function handleNextStage() {
            const currentData = gameData[currentGameIndex];
            
            if (currentData.picks < MAX_PICKS_PER_GAME) {
                console.error(`Must pick ${MAX_PICKS_PER_GAME} players before proceeding.`);
                return;
            }

            currentGameIndex++;
            
            if (currentGameIndex < NUM_GAMES) {
                showGame(currentGameIndex);
            } else {
                showSummaryView();
            }
        }

        /**
         * Shows a specific game stage and hides others.
         */
        function showGame(gameId) {
            currentGameIndex = gameId;

            document.getElementById('shuffler-container').style.display = 'block';
            document.getElementById('summary-view').style.display = 'none';

            const gameViews = document.querySelectorAll('.game-view');
            gameViews.forEach((view, index) => {
                view.style.display = (index === gameId) ? 'block' : 'none';
            });
            
            document.querySelector(`#game-${gameId}-view .grid-category-header`).textContent = GAME_TITLES[gameId];

            if (!gameData[gameId].tiles[0]) {
                loadInitialTiles(gameId);
            } else {
                const playerGrid = document.getElementById(`playerGrid-${gameId}`);
                for (let i = 0; i < NUM_TILES; i++) {
                     const tile = playerGrid.querySelector(`#tile-g${gameId}-t${i}`);
                     tile.classList.add('revealed');
                     tile.classList.remove('spinning');
                     const teamImg = tile.querySelector('.team-badge-image');
                     if (teamImg) teamImg.style.opacity = 1;
                }
                updateShuffleButton();
            }

            const shuffleButton = document.getElementById('shuffleButton');
            shuffleButton.style.display = 'inline-block';
        }

        /**
         * Switches from the Shuffler view to the Summary view and populates the list/grid.
         */
        function showSummaryView() {
            document.getElementById('shuffler-container').style.display = 'none';
            document.getElementById('summary-view').style.display = 'block';
            document.getElementById('shuffleButton').style.display = 'none';
            
            const summaryHeader = document.getElementById('summaryHeader');
            const summaryGrid = document.getElementById('summaryGrid');
            const leaderboardContainer = document.getElementById('leaderboard');
            
            summaryGrid.innerHTML = '';
            leaderboardContainer.innerHTML = '';
            
            let allPickedPlayers = [];
            let totalPoints = 0;

            // 1. Collect all 9 picks and calculate/store points
            gameData.forEach((game, gameIndex) => {
                game.tiles.forEach((player, tileIndex) => {
                    const tile = document.getElementById(`tile-g${gameIndex}-t${tileIndex}`);
                    if (tile && tile.classList.contains('is-picked') && player) {
                        
                        let randomPoints = player.points;
                        if (!randomPoints) {
                            // Generate random points between 20 and 200 (inclusive)
                            randomPoints = Math.floor(Math.random() * (200 - 20 + 1)) + 20; 
                            player.points = randomPoints;
                        }
                        
                        totalPoints += randomPoints;

                        allPickedPlayers.push({ 
                            ...player, 
                            game: gameIndex + 1,
                            points: randomPoints 
                        });
                    }
                });
            });
            
            // 2. Check for incomplete team
            if (allPickedPlayers.length !== NUM_GAMES * MAX_PICKS_PER_GAME) {
                summaryHeader.textContent = 'Team Selection Summary'; 
                summaryGrid.innerHTML = `
                    <div class="alert alert-warning text-center" role="alert">
                        You have only picked ${allPickedPlayers.length} out of 9 players. Please complete your team selection.
                    </div>
                `;
                return;
            }

            // 3. Update the header with the total points
            summaryHeader.innerHTML = `Total Points: <span class="text-primary">${totalPoints}</span>`;
            
            // 4. Sort players by position (ATT, MID, DEF)
            const positionOrder = { "ATTACKERS": 0, "MIDFIELDERS": 1, "DEFENDERS": 2 };

            allPickedPlayers.sort((a, b) => {
                return positionOrder[a.position] - positionOrder[b.position];
            });

            // 5. Render the Grid (3x3)
            allPickedPlayers.forEach(player => {
                const colDiv = document.createElement('div');
                // UPDATED: Changed to col-4 to enforce 3 tiles per row on all screen sizes (including mobile)
                colDiv.className = 'col-4'; 

                const surname = getSurname(player.name);
                const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const playerPlaceholderUrl = `https://placehold.co/50x50/007bff/ffffff?text=${initials}`; 

                const teamAbbr = player.teamData.abbr;
                const textColor = (player.teamData.text || '#FFFFFF').replace('#', '');
                const teamColor = player.teamData.color.replace('#', '');
                const teamPlaceholderUrl = `https://placehold.co/20x20/${teamColor}/${textColor}?text=${teamAbbr}`;
                
                // Determine position abbreviation and class for top-left badge
                const positionAbbr = player.position.substring(0, 3).toUpperCase();
                const positionClass = positionAbbr === 'DEF' ? 'badge-def' : 
                                      positionAbbr === 'MID' ? 'badge-mid' : 
                                      'badge-att';

                // Use the player-tile structure, apply 'is-summary' and 'revealed' classes, and include points.
                colDiv.innerHTML = `
                    <div class="player-tile is-summary revealed">
                        <!-- Top Left Position Badge -->
                        <span class="position-top-left-badge ${positionClass}">
                            ${positionAbbr}
                        </span>

                        <span class="player-info w-100">
                            <img class="player-image" 
                                 src="${playerPlaceholderUrl}" 
                                 alt="${player.name} image">
                            
                            <img class="team-badge-image" 
                                 src="${teamPlaceholderUrl}"
                                 alt="${player.teamName} Badge"
                                 style="opacity: 1;"> 
                            
                            <span class="player-name-main">
                                ${surname}
                            </span>
                            
                            <span class="opponent-hint">vs ${player.opponent}</span>
                            
                            <span class="summary-points">
                                ${player.points} <span class="text-muted small">pts</span>
                            </span>
                        </span>
                        <!-- Button is hidden by .is-summary CSS -->
                        <button class="btn btn-tile-pick btn-outline-primary" style="display: none;">PICK</button>
                    </div>
                `;
                summaryGrid.appendChild(colDiv);
            });
            
            // 6. Render Leaderboard
            const leaderboardData = [
                { name: "Global Ballers", points: 650, rank: 0 },
                { name: "Fantasy King", points: 621, rank: 0 },
                { name: "Your Team", points: totalPoints, rank: -1 }, 
                { name: "Dynamo FC", points: 585, rank: 0 },
                { name: "The Predictors", points: 572, rank: 0 },
                { name: "Midfield Maestro", points: 550, rank: 0 },
                { name: "Dream Team 77", points: 531, rank: 0 },
                { name: "Gaffer's XI", points: 512, rank: 0 },
                { name: "Top Flight", points: 495, rank: 0 },
                { name: "Winger Wizards", points: 488, rank: 0 },
                { name: "The Scorers", points: 470, rank: 0 },
            ];

            // Sort all data points together
            leaderboardData.sort((a, b) => b.points - a.points);

            // Assign ranks and ensure only 10 rows are shown
            let finalLeaderboard = [];
            for (let i = 0; i < leaderboardData.length; i++) {
                if (finalLeaderboard.length >= 10) break;
                
                const entry = leaderboardData[i];
                entry.rank = i + 1; // Assign rank based on current sorted position
                finalLeaderboard.push(entry);
            }
            
            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover rounded overflow-hidden shadow leaderboard-table">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th scope="col" class="text-center">#</th>
                                <th scope="col">Team Name</th>
                                <th scope="col" class="text-end">Total Points</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            finalLeaderboard.forEach(entry => {
                const isUser = entry.name === "Your Team";
                const rowClass = isUser ? 'table-info fw-bold' : '';
                const name = isUser ? `Your Team <span class="badge bg-primary">YOU</span>` : entry.name;
                // No specific points class needed, relies on default dark text
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="text-center">${entry.rank}</td>
                        <td>${name}</td>
                        <td class="text-end">${entry.points}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            leaderboardContainer.innerHTML = tableHTML;
        }

        /**
         * Initialization function called when the page loads.
         */
        window.onload = function() {
            parsePlayers(csvContent);
            initializeGameData();
            
            document.querySelector('#game-0-view .grid-category-header').textContent = GAME_TITLES[0];
            document.querySelector('#game-1-view .grid-category-header').textContent = GAME_TITLES[1];
            document.querySelector('#game-2-view .grid-category-header').textContent = GAME_TITLES[2];

            showGame(0); 
        };

    </script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
