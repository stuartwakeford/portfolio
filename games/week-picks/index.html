<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week Picks - Football Game</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* General Body and Container Styling */
        body {
            font-family: 'Inter', Arial, sans-serif; /* Using Inter for a modern feel */
            margin: 0;
            padding: 0;
            background-color: #0B0446; /* Dark mode main page background */
            color: #C0C0C0; /* Light grey text for readability */
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 450px; /* More typical mobile width */
            margin: 20px auto;
            padding: 20px;
            background-color: #353066; /* Dark mode block container background */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* Softer, darker shadow */
        }

        h1, h2 {
            color: #E0E0E0; /* Light grey for titles */
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* Branding Bar */
        .branding-bar {
            background-color: #2A255C; /* Darker shade for branding bar */
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space out logo and home icon */
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .branding-bar .home-icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            transition: opacity 0.2s ease;
        }

        .branding-bar .home-icon-btn:hover {
            opacity: 0.8;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8em;
            font-weight: bold;
            flex-grow: 1; /* Allow logo to take available space */
            justify-content: center; /* Center the logo text */
        }

        .football-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 25px; /* Larger touch targets */
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, opacity 0.3s ease, transform 0.2s ease;
            border: none;
            text-align: center;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Consistent shadow */
            color: #333; /* Dark text on bright green buttons */
        }

        .btn:active {
            transform: translateY(1px); /* Simple press effect */
        }

        .primary-btn {
            background-color: #8EFA4C; /* Bright green for primary buttons */
            display: block;
            margin: 30px auto 0;
            width: fit-content;
        }

        .primary-btn:hover {
            background-color: #7ADF3B; /* Slightly darker green on hover */
        }

        .selection-btn {
            background-color: #7ADF3B; /* Non-selected button color */
            margin-top: 15px; /* More spacing */
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .selection-btn:hover {
            background-color: #60B030; /* Darker green on hover */
        }

        .select-item-btn {
            background-color: #7ADF3B; /* Non-selected button color */
            color: #333; /* Dark text on bright button */
            padding: 8px 15px; /* Adjusted padding */
            font-size: 0.95em;
            border-radius: 6px;
            display: flex; /* Use flex for icon and text */
            align-items: center;
            justify-content: center;
            gap: 5px; /* Space between icon and text */
        }

        .select-item-btn .material-icons {
            font-size: 1em; /* Icon size relative to text */
        }

        .select-item-btn:hover {
            background-color: #60B030; /* Darker green on hover */
        }

        .select-item-btn.selected {
            background-color: #0d6efd; /* Vibrant blue when selected */
            color: white; /* White text on blue */
            cursor: default;
        }

        .select-item-btn.selected:hover {
            background-color: #0d6efd; /* Keep same color when selected and hovered */
        }

        .select-item-btn.disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
            color: #666; /* Darker text on disabled */
        }

        .confirm-modal-btn {
            background-color: #8EFA4C;
            color: #333;
            margin-top: 25px; /* More spacing */
            width: 100%;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm-modal-btn.active {
            opacity: 1;
            cursor: pointer;
        }

        .confirm-modal-btn:hover.active {
            background-color: #7ADF3B;
        }

        .confirm-selections-main-btn {
            margin-top: 40px;
            background-color: #8EFA4C;
            width: 100%; /* Full width as requested */
            padding: 15px 25px; /* Bigger padding for larger size */
            font-size: 1.2em; /* Slightly larger font */
        }

        .confirm-selections-main-btn:hover {
            background-color: #7ADF3B;
        }

        .view-selections-btn {
            background: none;
            border: none; /* Ensure no default button border */
            color: #8EFA4C; /* Bright green for view buttons */
            padding: 5px;
            margin-left: auto;
            cursor: pointer;
        }

        .view-selections-btn .material-icons {
            font-size: 1.4em; /* Slightly larger icon */
        }

        .view-selections-btn:hover {
            color: #7ADF3B;
        }

        /* Screen Management */
        .screen {
            display: none;
            min-height: calc(100vh - 80px); /* Fill screen height minus header */
            padding-bottom: 30px; /* Ensure content doesn't get cut off at bottom */
        }

        .screen.active-screen {
            display: block;
        }

        /* Screen 2: Selections */
        .selection-block {
            background-color: #353066; /* Dark mode block background */
            border: 1px solid #403B70; /* Darker border */
            border-radius: 10px;
            padding: 18px; /* More padding */
            margin-bottom: 20px;
            text-align: center;
        }

        .selection-block h2 {
            color: #E0E0E0;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .selected-items {
            margin-top: 20px;
            padding: 12px;
            background-color: #403B70; /* Slightly lighter for selected items area */
            border: 1px dashed #504B80; /* Dashed border for visual distinction */
            border-radius: 8px;
            min-height: 50px; /* Taller for better visual */
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* More space between tags */
            align-items: center;
            justify-content: center;
            color: #C0C0C0;
            font-size: 0.95em;
            transition: all 0.3s ease-in-out; /* Smooth transition for empty state */
        }

        /* Style for empty selection display */
        .selected-items.empty-selection-display {
            border: none;
            background-color: transparent;
            min-height: 0; /* Collapse height */
            padding: 0;
            margin-top: 0;
        }

        .selected-item-tag {
            background-color: #4A457D; /* Lighter shade of block background for tags */
            color: #E0E0E0; /* Light text on tags */
            padding: 6px 12px;
            border-radius: 20px; /* More rounded */
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .team-circle {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em; /* Smaller font for abbr */
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .selected-item-tag .remove-btn {
            background: none;
            border: none;
            color: #8EFA4C; /* Bright green X */
            font-size: 1.4em; /* Larger X */
            cursor: pointer;
            line-height: 1;
            padding: 0 0 2px 5px;
            transition: color 0.2s;
        }

        .selected-item-tag .remove-btn:hover {
            color: #FF6347; /* Tomato red on hover */
        }


        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8); /* Darker overlay */
            padding-top: 40px; /* Less top padding */
        }

        .modal-content {
            background-color: #353066; /* Dark mode block container background */
            margin: 5% auto;
            padding: 25px;
            border: none; /* No border */
            width: 95%; /* Wider on mobile */
            max-width: 550px; /* Slightly larger max-width for modals */
            border-radius: 15px; /* More rounded */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); /* Stronger shadow */
            position: relative;
        }

        .close-button {
            color: #C0C0C0; /* Light grey close button */
            float: right;
            font-size: 36px; /* Larger close button */
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #E0E0E0;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #E0E0E0;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.6em;
        }

        .team-list, .player-list {
            max-height: 400px; /* Taller scrollable list */
            overflow-y: auto;
            border: 1px solid #504B80; /* Darker border */
            padding: 10px;
            border-radius: 8px;
            background-color: #403B70; /* Slightly lighter background for lists */
        }

        /* Fixture View Specific Styles */
        .fixture-group {
            margin-bottom: 15px;
            padding: 10px; /* Padding for the group container */
            border-radius: 8px;
            background-color: #403B70; /* Light grey background for the fixture block */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .fixture-group:last-child {
            margin-bottom: 0;
        }

        .fixture-team-selection-row { /* Container for individual team + button */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }
        .fixture-group .fixture-team-selection-row:not(:last-child) {
            border-bottom: 1px solid #504B80; /* Separator between home and away team in a fixture */
        }

        .team-name-with-position {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Make team names in modals white and bold */
        .team-name-with-position span {
            color: white;
            font-weight: bold;
        }


        .team-position {
            font-size: 0.85em;
            color: #C0C0C0;
            font-weight: normal;
            margin-left: 5px;
        }


        .team-item, .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #504B80; /* Darker border */
        }

        .team-item:last-child, .player-item:last-child {
            border-bottom: none;
        }

        .player-item-details { /* New class to group circle and name for player */
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            font-size: 1.1em;
            text-align: left;
        }
        .player-item-details .team-circle {
            flex-shrink: 0;
        }
        /* Make player names in modals white and bold */
        .player-item-details span {
            color: white;
            font-weight: bold;
        }

        /* Updated class for player position display */
        .player-position-name { /* This class is now removed from HTML, but keeping style for safety */
            font-size: 0.9em;
            color: #C0C0C0;
            margin-left: 10px; /* Space from player name */
            flex-shrink: 0;
            min-width: 80px; /* Give it some space */
            text-align: left;
        }

        .player-stat {
            font-size: 0.9em;
            color: #C0C0C0;
            margin-left: auto; /* Push stat to the right */
            font-weight: normal;
            min-width: 60px; /* Give it some space */
            text-align: right;
            margin-right: 15px; /* Added space between stat and button */
        }

        /* Player Position Tabs */
        .player-position-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            background-color: #403B70; /* Darker background for tabs */
            border-radius: 8px;
            overflow: hidden;
        }

        .player-position-tabs .tab-btn {
            flex: 1;
            padding: 10px 15px;
            background-color: transparent;
            border: none;
            color: #C0C0C0; /* Light text for inactive tabs */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 0.9em;
            border-radius: 0; /* No individual border radius */
        }

        .player-position-tabs .tab-btn.active {
            background-color: #8EFA4C; /* Bright green for active tab */
            color: #333; /* Dark text on active tab */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.4);
        }

        .player-position-tabs .tab-btn:hover:not(.active) {
            background-color: #504B80; /* Slightly lighter hover for inactive tabs */
        }

        /* Screen 3: In-play */
        .in-play-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background-color: #403B70; /* Darker background for tabs */
            border-radius: 8px;
            overflow: hidden;
        }

        .in-play-tabs .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            color: #C0C0C0;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 1em;
            border-radius: 0;
        }

        .in-play-tabs .tab-btn.active {
            background-color: #8EFA4C;
            color: #333;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.4);
        }

        .in-play-tabs .tab-btn:hover:not(.active) {
            background-color: #504B80;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active-tab-content {
            display: block;
        }

        /* Category grouping on In-Play and Leaderboard Modals */
        .selection-category-group {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #353066; /* Dark mode block container background */
            border-radius: 10px;
            border: 1px solid #403B70; /* Darker border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .selection-category-group h3 {
            color: #E0E0E0; /* Light grey for subheaders */
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .selection-status-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            /* Removed margin-bottom here as it's now on the group */
        }

        .selection-item {
            background-color: #403B70; /* Slightly lighter background for individual items */
            border: 1px solid #504B80; /* Darker border */
            border-radius: 10px;
            padding: 18px;
            display: flex;
            flex-direction: column; /* Stack details and fixture info */
            justify-content: space-between;
            align-items: flex-start; /* Align content to start */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .selection-main-details { /* New container for type, name, status, outcome */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 10px; /* Space between main details and fixture info */
        }

        .selection-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1;
        }

        .selection-details strong {
            color: #E0E0E0; /* Light grey for bold names */
            font-size: 1.1em;
            display: flex; /* Enable flex for name and crest */
            align-items: center;
            gap: 10px; /* Space between crest and name */
        }
        /* Style for the crest within selection-details strong */
        .selection-details strong .team-crest-small {
            width: 24px; /* Smaller crest size */
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em; /* Smaller font for abbr */
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }


        .status { /* This will be removed, but keeping styles for reference if needed */
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 5px;
            color: white;
            margin-top: 8px;
            width: fit-content;
            font-weight: 600;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status.finished {
            background-color: #606060; /* Darker grey for finished */
        }

        .status.in-play {
            background-color: #FFD700; /* Gold for in-play */
            color: #333;
        }

        .status.upcoming {
            background-color: #5A5A5A; /* Medium grey for upcoming */
        }

        /* Pulsating Circle Animation */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(142, 250, 76, 0.7); } /* Use new green color */
            70% { box-shadow: 0 0 0 10px rgba(142, 250, 76, 0); }
            100% { box-shadow: 0 0 0 0 rgba(142, 250, 76, 0); }
        }

        .status.in-play .live-indicator {
            width: 8px;
            height: 8px;
            background-color: #8EFA4C; /* Bright green */
            border-radius: 50%;
            animation: pulse-green 1.5s infinite;
            margin-right: 5px; /* Space between circle and text */
        }

        .outcome {
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .outcome.correct {
            color: #8EFA4C; /* Bright green for correct */
        }

        .outcome.incorrect {
            color: #FF6347; /* Tomato red for incorrect */
        }

        .outcome.pending {
            color: #C0C0C0; /* Light grey for pending */
        }

        .outcome-icon {
            font-size: 1.2em;
            vertical-align: middle;
        }
        .correct-icon { color: #8EFA4C; }
        .incorrect-icon { color: #FF6347; }


        .points {
            font-size: 1.6em; /* Larger points */
            font-weight: bold;
            color: #8EFA4C; /* Bright green for points */
            margin-left: 15px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .fixture-info { /* New style for fixture details on in-play screen */
            font-size: 0.9em;
            color: #C0C0C0; /* Light grey for fixture info */
            padding-top: 10px;
            border-top: 1px dashed #504B80; /* Darker dashed border */
            width: 100%;
            text-align: center;
        }

        .fixture-info strong {
            color: #E0E0E0; /* Lighter for bold teams in fixture info */
        }

        .total-points-bar {
            background-color: #8EFA4C; /* Bright green for total points bar */
            color: #333; /* Dark text on bright green */
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            margin-top: 0px; /* Removed margin-top, now controlled by placement */
            margin-bottom: 20px; /* Reduced margin-bottom */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .total-points-bar h2 {
            margin: 0;
            color: #333; /* Dark text on bright green */
            font-size: 1.8em;
        }

        .total-points-value {
            font-size: 1.8em; /* Smaller points font size as requested */
            font-weight: bold;
        }

        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .leaderboard-item {
            background-color: #403B70; /* Slightly lighter background for leaderboard items */
            border: 1px solid #504B80; /* Darker border */
            border-radius: 10px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .leaderboard-item .emoji {
            font-size: 1.8em; /* Larger emoji */
            margin-right: 15px;
            flex-shrink: 0;
        }

        .leaderboard-item .username {
            font-weight: bold;
            flex-grow: 1;
            font-size: 1.1em;
            color: #E0E0E0; /* Light grey for username */
        }

        .leaderboard-item .leaderboard-points {
            font-weight: bold;
            color: #8EFA4C; /* Bright green for leaderboard points */
            font-size: 1.3em;
            margin-right: 15px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <!-- Top Branding Bar -->
    <header class="branding-bar">
        <button class="home-icon-btn" id="home-icon-btn">
            <span class="material-icons">home</span>
        </button>
        <div class="logo">
            <span class="material-icons football-icon">sports_soccer</span>
            <span class="logo-text">Week Picks</span>
        </div>
        <!-- Empty div to balance flexbox spacing -->
        <div style="width: 24px;"></div>
    </header>

    <!-- Screen 1: Homescreen -->
    <section id="homescreen" class="screen active-screen">
        <div class="container">
            <h1>Premier League Week 38</h1>
            <a href="#selections" class="btn primary-btn" id="make-selections-btn">Make selections</a>
        </div>
    </section>

    <!-- Screen 2: Selections -->
    <section id="selections" class="screen">
        <div class="container">
            <h1>Make your selections</h1>

            <!-- Selection Block: Pick 3 teams to win -->
            <div class="selection-block">
                <h2>Pick 3 teams to win</h2>
                <button class="btn selection-btn" data-modal="modal-teams-win">Make selections</button>
                <div class="selected-items" id="selected-teams-win">
                    <!-- Content populated by JS -->
                </div>
            </div>

            <!-- Modal for Pick 3 teams to win -->
            <div id="modal-teams-win" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>Select 3 Teams to Win</h2>
                    <div class="team-list" id="teams-win-list">
                        <!-- Fixtures will be populated here by JS -->
                    </div>
                    <button class="btn confirm-modal-btn">Confirm Selections</button>
                </div>
            </div>

            <!-- Selection Block: Pick 3 players to score -->
            <div class="selection-block">
                <h2>Pick 3 players to score</h2>
                <button class="btn selection-btn" data-modal="modal-players-score">Make selections</button>
                <div class="selected-items" id="selected-players-score">
                    <!-- Content populated by JS -->
                </div>
            </div>

            <!-- Modal for Pick 3 players to score -->
            <div id="modal-players-score" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>Select 3 Players to Score</h2>
                    <div class="player-position-tabs">
                        <button class="tab-btn active" data-position="Forwards">Forwards</button>
                        <button class="tab-btn" data-position="Midfielders">Midfielders</button>
                        <button class="tab-btn" data-position="Defenders">Defenders</button>
                        <button class="tab-btn" data-position="Goalkeepers">Goalkeepers</button>
                    </div>
                    <div class="player-list" id="players-score-list">
                        <!-- Players will be populated here by JS -->
                    </div>
                    <button class="btn confirm-modal-btn">Confirm Selections</button>
                </div>
            </div>

            <!-- Selection Block: Pick 3 players to get an assist -->
            <div class="selection-block">
                <h2>Pick 3 players to get an assist</h2>
                <button class="btn selection-btn" data-modal="modal-players-assist">Make selections</button>
                <div class="selected-items" id="selected-players-assist">
                    <!-- Content populated by JS -->
                </div>
            </div>

            <!-- Modal for Pick 3 players to assist -->
            <div id="modal-players-assist" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>Select 3 Players to Assist</h2>
                    <div class="player-position-tabs">
                        <button class="tab-btn active" data-position="Forwards">Forwards</button>
                        <button class="tab-btn" data-position="Midfielders">Midfielders</button>
                        <button class="tab-btn" data-position="Defenders">Defenders</button>
                        <button class="tab-btn" data-position="Goalkeepers">Goalkeepers</button>
                    </div>
                    <div class="player-list" id="players-assist-list">
                        <!-- Players will be populated here by JS -->
                    </div>
                    <button class="btn confirm-modal-btn">Confirm Selections</button>
                </div>
            </div>

            <!-- Selection Block: Pick 3 players to get a card -->
            <div class="selection-block">
                <h2>Pick 3 players to get a card</h2>
                <button class="btn selection-btn" data-modal="modal-players-card">Make selections</button>
                <div class="selected-items" id="selected-players-card">
                    <!-- Content populated by JS -->
                </div>
            </div>

            <!-- Modal for Pick 3 players to get a card -->
            <div id="modal-players-card" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>Select 3 Players to Get a Card</h2>
                    <div class="player-position-tabs">
                        <button class="tab-btn active" data-position="Forwards">Forwards</button>
                        <button class="tab-btn" data-position="Midfielders">Midfielders</button>
                        <button class="tab-btn" data-position="Defenders">Defenders</button>
                        <button class="tab-btn" data-position="Goalkeepers">Goalkeepers</button>
                    </div>
                    <div class="player-list" id="players-card-list">
                        <!-- Players will be populated here by JS -->
                    </div>
                    <button class="btn confirm-modal-btn">Confirm Selections</button>
                </div>
            </div>

            <!-- Selection Block: Pick 3 teams to keep a clean sheet -->
            <div class="selection-block">
                <h2>Pick 3 teams to keep a clean sheet</h2>
                <button class="btn selection-btn" data-modal="modal-teams-cleansheet">Make selections</button>
                <div class="selected-items" id="selected-teams-cleansheet">
                    <!-- Content populated by JS -->
                </div>
            </div>

            <!-- Modal for Pick 3 teams to keep a clean sheet -->
            <div id="modal-teams-cleansheet" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>Select 3 Teams to Keep a Clean Sheet</h2>
                    <div class="team-list" id="teams-cleansheet-list">
                        <!-- Fixtures will be populated here by JS -->
                    </div>
                    <button class="btn confirm-modal-btn">Confirm Selections</button>
                </div>
            </div>

            <a href="#in-play" class="btn primary-btn confirm-selections-main-btn" id="confirm-all-selections-btn">Confirm Selections</a>
        </div>
    </section>

    <!-- Screen 3: In-play -->
    <section id="in-play" class="screen">
        <div class="container">
            <h1>Your Selections In-Play</h1>

            <div class="in-play-tabs">
                <button class="tab-btn active" data-tab="selections-tab">Selections</button>
                <button class="tab-btn" data-tab="leaderboard-tab">Leaderboard</button>
            </div>

            <div id="selections-tab" class="tab-content active-tab-content">
                <!-- Moved Total Points Bar to the top -->
                <div class="total-points-bar">
                    <h2>Total Points: <span class="total-points-value">0pts</span></h2>
                </div>
                <div id="user-in-play-selections">
                    <!-- User's actual selections will be populated here by JavaScript, grouped by category -->
                </div>
            </div>

            <div id="leaderboard-tab" class="tab-content">
                <h2>Leaderboard</h2>
                <div class="leaderboard">
                    <!-- Example Leaderboard Entries -->
                    <div class="leaderboard-item">
                        <span class="emoji">🐻</span>
                        <span class="username">Stu</span>
                        <span class="leaderboard-points">200pts</span>
                        <button class="btn view-selections-btn" data-user="stu">
                            <span class="material-icons">arrow_forward_ios</span>
                        </button>
                    </div>
                    <div class="leaderboard-item">
                        <span class="emoji">🦊</span>
                        <span class="username">Dave</span>
                        <span class="leaderboard-points">150pts</span>
                        <button class="btn view-selections-btn" data-user="dave">
                            <span class="material-icons">arrow_forward_ios</span>
                        </button>
                    </div>
                    <div class="leaderboard-item">
                        <span class="emoji">🦉</span>
                        <span class="username">Si</span>
                        <span class="leaderboard-points">100pts</span>
                        <button class="btn view-selections-btn" data-user="si">
                            <span class="material-icons">arrow_forward_ios</span>
                        </button>
                    </div>
                    <div class="leaderboard-item">
                        <span class="emoji">🐵</span>
                        <span class="username">Anj</span>
                        <span class="leaderboard-points">75pts</span>
                        <button class="btn view-selections-btn" data-user="anj">
                            <span class="material-icons">arrow_forward_ios</span>
                        </button>
                    </div>
                    <div class="leaderboard-item">
                        <span class="emoji">🦁</span>
                        <span class="username">Barry</span>
                        <span class="leaderboard-points">50pts</span>
                        <button class="btn view-selections-btn" data-user="barry">
                            <span class="material-icons">arrow_forward_ios</span>
                        </button>
                    </div>
                </div>
            </div>


            <!-- Modal for User Selections (Leaderboard) -->
            <div id="modal-user-selections" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2 id="modal-user-selections-title">Stu's Selections</h2>
                    <div id="modal-user-selections-content">
                        <!-- Content populated by JS -->
                    </div>
                    <div class="total-points-bar">
                        <h2>Total Points: <span class="total-points-value" id="modal-user-total-points">100pts</span></h2>
                    </div>
                </div>
            </div>

        </div>
    </section>
    <script>
        // Define allPlayers globally to ensure it's always available
        const allPlayers = [
            // Forwards (13 players)
            { id: "haaland", name: "Erling Haaland", team: "Man City", position: "Forwards", stats: { goals: 27 } },
            { id: "watkins", name: "Ollie Watkins", team: "Aston Villa", position: "Forwards", stats: { goals: 19 } },
            { id: "salah", name: "Mohamed Salah", team: "Liverpool", position: "Forwards", stats: { goals: 18 } },
            { id: "son", name: "Son Heung-min", team: "Tottenham", position: "Forwards", stats: { goals: 17 } },
            { id: "solanke", name: "Dominic Solanke", team: "Bournemouth", position: "Forwards", stats: { goals: 15 } },
            { id: "saka", name: "Bukayo Saka", team: "Arsenal", position: "Forwards", stats: { goals: 14 } },
            { id: "bowen", name: "Jarrod Bowen", team: "West Ham", position: "Forwards", stats: { goals: 13 } },
            { id: "foden", name: "Phil Foden", team: "Man City", position: "Forwards", stats: { goals: 12 } },
            { id: "isack", name: "Alexander Isak", team: "Newcastle", position: "Forwards", stats: { goals: 12 } },
            { id: "palmer", name: "Cole Palmer", team: "Chelsea", position: "Forwards", stats: { goals: 11 } },
            { id: "rashford", name: "Marcus Rashford", team: "Man Utd", position: "Forwards", stats: { goals: 10 } },
            { id: "nunez", name: "Darwin Núñez", team: "Liverpool", position: "Forwards", stats: { goals: 9 } },
            { id: "jesus", name: "Gabriel Jesus", team: "Arsenal", position: "Forwards", stats: { goals: 8 } },

            // Midfielders (12 players)
            { id: "kdb", name: "Kevin De Bruyne", team: "Man City", position: "Midfielders", stats: { assists: 15 } },
            { id: "fernandes", name: "Bruno Fernandes", team: "Man Utd", position: "Midfielders", stats: { assists: 12 } },
            { id: "saka-assist", name: "Bukayo Saka", team: "Arsenal", position: "Midfielders", stats: { assists: 10 } }, // Re-use Saka for assists
            { id: "gross", name: "Pascal Groß", team: "Brighton", position: "Midfielders", stats: { assists: 9 } },
            { id: "palmer-assist", name: "Cole Palmer", team: "Chelsea", position: "Midfielders", stats: { assists: 8 } }, // Re-use Palmer
            { id: "rodri", name: "Rodri", team: "Man City", position: "Midfielders", stats: { assists: 7 } },
            { id: "ode", name: "Martin Ødegaard", team: "Arsenal", position: "Midfielders", stats: { assists: 6 } },
            { id: "maddison", name: "James Maddison", team: "Tottenham", position: "Midfielders", stats: { assists: 6 } },
            { id: "grealish", name: "Jack Grealish", team: "Man City", position: "Midfielders", stats: { assists: 5 } },
            { id: "macallister", name: "Alexis Mac Allister", team: "Liverpool", position: "Midfielders", stats: { assists: 5 } },
            { id: "rice", name: "Declan Rice", team: "Arsenal", position: "Midfielders", stats: { assists: 4 } },
            { id: "silva", name: "Bernardo Silva", team: "Man City", position: "Midfielders", stats: { assists: 4 } },

            // Defenders (15 players)
            { id: "saliba", name: "William Saliba", team: "Arsenal", position: "Defenders", stats: { cleanSheets: 10, cards: 3 } },
            { id: "dias", name: "Rúben Dias", team: "Man City", position: "Defenders", stats: { cleanSheets: 12, cards: 2 } },
            { id: "taa", name: "Trent Alexander-Arnold", team: "Liverpool", position: "Defenders", stats: { cleanSheets: 8, assists: 7 } },
            { id: "chilwell", name: "Ben Chilwell", team: "Chelsea", position: "Defenders", stats: { cleanSheets: 6, cards: 4 } },
            { id: "shaw", name: "Luke Shaw", team: "Man Utd", position: "Defenders", stats: { cleanSheets: 7, cards: 3 } },
            { id: "romero", name: "Cristian Romero", team: "Tottenham", position: "Defenders", stats: { cleanSheets: 8, cards: 6 } },
            { id: "konsa", name: "Ezri Konsa", team: "Aston Villa", position: "Defenders", stats: { cleanSheets: 7, cards: 5 } },
            { id: "trippier", name: "Kieran Trippier", team: "Newcastle", position: "Defenders", stats: { cleanSheets: 9, assists: 5 } },
            { id: "dunk", name: "Lewis Dunk", team: "Brighton", position: "Defenders", stats: { cleanSheets: 6, cards: 7 } },
            { id: "zouma", name: "Kurt Zouma", team: "West Ham", position: "Defenders", stats: { cleanSheets: 5, cards: 6 } },
            { id: "mykolenko", name: "Vitaliy Mykolenko", team: "Everton", position: "Defenders", stats: { cleanSheets: 4, cards: 8 } },
            { id: "kilman", name: "Max Kilman", team: "Wolves", position: "Defenders", stats: { cleanSheets: 5, cards: 7 } },
            { id: "guehi", name: "Marc Guéhi", team: "Crystal Palace", position: "Defenders", stats: { cleanSheets: 6, cards: 4 } },
            { id: "reid", name: "Bobby De Cordova-Reid", team: "Fulham", position: "Defenders", stats: { cleanSheets: 5, cards: 5 } },
            { id: "pinnock", name: "Ethan Pinnock", team: "Brentford", position: "Defenders", stats: { cleanSheets: 5, cards: 6 } },

            // Goalkeepers (10 players)
            { id: "alisson", name: "Alisson Becker", team: "Liverpool", position: "Goalkeepers", stats: { cleanSheets: 18 } },
            { id: "ederson", name: "Ederson", team: "Man City", position: "Goalkeepers", stats: { cleanSheets: 16 } },
            { id: "raya", name: "David Raya", team: "Arsenal", position: "Goalkeepers", stats: { cleanSheets: 16 } },
            { id: "vicario", name: "Guglielmo Vicario", team: "Tottenham", position: "Goalkeepers", stats: { cleanSheets: 10 } },
            { id: "martinez", name: "Emiliano Martínez", team: "Aston Villa", position: "Goalkeepers", stats: { cleanSheets: 10 } },
            { id: "onana", name: "André Onana", team: "Man Utd", position: "Goalkeepers", stats: { cleanSheets: 9 } },
            { id: "pickford", name: "Jordan Pickford", team: "Everton", position: "Goalkeepers", stats: { cleanSheets: 8 } },
            { id: "areola", name: "Alphonse Areola", team: "West Ham", position: "Goalkeepers", stats: { cleanSheets: 7 } },
            { id: "neto", name: "Neto", team: "Bournemouth", position: "Goalkeepers", stats: { cleanSheets: 6 } },
            { id: "jose-sa", name: "José Sá", team: "Wolves", position: "Goalkeepers", stats: { cleanSheets: 6 } }
        ];

        // Team Data with Colors and Abbreviations and League Positions
        const teamData = {
            "Arsenal": { color: "#EF0107", abbr: "ARS", position: "1st" },
            "Man City": { color: "#6CABDD", abbr: "MCI", position: "2nd" },
            "Liverpool": { color: "#C80000", abbr: "LIV", position: "3rd" },
            "Chelsea": { color: "#034694", abbr: "CHE", position: "6th" },
            "Man Utd": { color: "#DA291C", abbr: "MUN", position: "8th" },
            "Tottenham": { color: "#132257", abbr: "TOT", position: "5th" },
            "Aston Villa": { color: "#410E2A", abbr: "AVL", position: "4th" },
            "Newcastle": { color: "#241F20", abbr: "NEW", position: "7th" },
            "Brighton": { color: "#0057B8", abbr: "BHA", position: "10th" },
            "West Ham": { color: "#7A263A", abbr: "WHU", position: "9th" },
            "Everton": { color: "#003399", abbr: "EVE", position: "15th" },
            "Wolves": { color: "#FDB913", abbr: "WOL", position: "12th" },
            "Crystal Palace": { color: "#1B458F", abbr: "CRY", position: "14th" },
            "Fulham": { color: "#000000", abbr: "FUL", position: "13th" },
            "Brentford": { color: "#E30613", abbr: "BRE", position: "16th" },
            "Bournemouth": { color: "#DA291C", abbr: "BOU", position: "11th" },
            "Nottm Forest": { color: "#E5323E", abbr: "NFO", position: "17th" },
            "Southampton": { color: "#D71920", abbr: "SOU", position: "18th" }, // Relegated, but here for fixture demo
            "Leicester City": { color: "#003090", abbr: "LEI", position: "19th" }, // Relegated
            "Ipswich Town": { color: "#003366", abbr: "IPS", position: "20th" } // Relegated
        };

        // Fictional Week 38 fixtures for 2024-25 season
        const week38Fixtures = [
            { id: "fix1", home: "Arsenal", away: "Wolves" },
            { id: "fix2", home: "Man City", away: "West Ham" },
            { id: "fix3", home: "Liverpool", away: "Brighton" },
            { id: "fix4", home: "Chelsea", away: "Aston Villa" },
            { id: "fix5", home: "Man Utd", away: "Tottenham" },
            { id: "fix6", home: "Newcastle", away: "Everton" },
            { id: "fix7", home: "Crystal Palace", away: "Fulham" },
            { id: "fix8", home: "Brentford", away: "Nottm Forest" },
            { id: "fix9", home: "Bournemouth", away: "Southampton" },
            { id: "fix10", home: "Leicester City", away: "Ipswich Town" }
        ];

        // Mock fixture results for demo purposes (Week 38, 2024-25 season - hardcoded)
        const mockResults = {
            'fix1': { home: "Arsenal", away: "Wolves", homeScore: 3, awayScore: 1, status: 'finished', won: 'Arsenal', cleanSheet: false },
            'fix2': { home: "Man City", away: "West Ham", homeScore: 2, awayScore: 0, status: 'finished', won: 'Man City', cleanSheet: true },
            'fix3': { home: "Liverpool", away: "Brighton", homeScore: 0, awayScore: 0, status: 'finished', won: 'draw', cleanSheet: true },
            'fix4': { home: "Chelsea", away: "Aston Villa", homeScore: 2, awayScore: 1, status: 'finished', won: 'Chelsea', cleanSheet: false },
            'fix5': { home: "Man Utd", away: "Tottenham", homeScore: 1, awayScore: 2, status: 'finished', won: 'Tottenham', cleanSheet: false },
            'fix6': { home: "Newcastle", away: "Everton", homeScore: 2, awayScore: 1, status: 'finished', won: 'Newcastle', cleanSheet: false },
            'fix7': { home: "Crystal Palace", away: "Fulham", homeScore: 1, awayScore: 0, status: 'finished', won: 'Crystal Palace', cleanSheet: true },
            'fix8': { home: "Brentford", away: "Nottm Forest", homeScore: 2, awayScore: 0, status: 'finished', won: 'Brentford', cleanSheet: true },
            'fix9': { home: "Bournemouth", away: "Southampton", homeScore: 1, awayScore: 0, status: 'finished', won: 'Bournemouth', cleanSheet: true },
            'fix10': { home: "Leicester City", away: "Ipswich Town", homeScore: 3, awayScore: 0, status: 'finished', won: 'Leicester City', cleanSheet: true },

            // Player specific outcomes (linked to fixture outcomes for simplicity)
            'haaland': { scored: true, fixtureId: 'fix2', liveMinute: 75, team: "Man City" }, // Use player ID
            'watkins': { scored: false, fixtureId: 'fix4', team: "Aston Villa" },
            'salah': { scored: false, fixtureId: 'fix3', team: "Liverpool" },
            'saka': { scored: true, fixtureId: 'fix1', team: "Arsenal" },
            'kdb': { assisted: true, fixtureId: 'fix2', liveMinute: 60, team: "Man City" },
            'fernandes': { assisted: false, fixtureId: 'fix5', team: "Man Utd" },
            'palhinha': { card: true, fixtureId: 'fix7', team: "Fulham" }, // Assuming a card was given in this match
            'douglas-luiz': { card: false, fixtureId: 'fix4', team: "Aston Villa" },
            // Dummy player outcomes for leaderboard users (if not already in allPlayers)
            'xhaka': { scored: false, fixtureId: 'fix1', team: "Arsenal" },
            'casemiro': { card: false, fixtureId: 'fix5', team: "Man Utd" },
            'fabinho': { card: false, fixtureId: 'fix3', team: "Liverpool" },
            'kane': { scored: true, fixtureId: 'fix5', team: "Tottenham" },
            'romero': { card: false, fixtureId: 'fix5', team: "Tottenham" },
            'mcginn': { card: false, fixtureId: 'fix4', team: "Aston Villa" }
        };


        document.addEventListener('DOMContentLoaded', () => {
            const screens = document.querySelectorAll('.screen');
            const homeIconBtn = document.getElementById('home-icon-btn');
            const makeSelectionsBtn = document.getElementById('make-selections-btn');
            const confirmAllSelectionsBtn = document.getElementById('confirm-all-selections-btn');

            const selectionBtns = document.querySelectorAll('.selection-btn');
            const closeButtons = document.querySelectorAll('.modal .close-button');
            const confirmModalBtns = document.querySelectorAll('.confirm-modal-btn');
            let selectItemBtns = document.querySelectorAll('.select-item-btn'); // Will be updated dynamically

            const leaderboardViewBtns = document.querySelectorAll('.view-selections-btn');
            const userSelectionsModal = document.getElementById('modal-user-selections');
            const userSelectionsModalTitle = document.getElementById('modal-user-selections-title');
            const userSelectionsModalContent = document.getElementById('modal-user-selections-content');
            const userSelectionsModalTotalPoints = document.getElementById('modal-user-total-points');

            // Store user selections globally
            const userSelections = {
                teamsToWin: [],
                playersToScore: [],
                playersToAssist: [],
                playersToCard: [],
                teamsToCleanSheet: []
            };

            // Hardcoded dummy selections for leaderboard users
            const leaderboardData = {
                stu: {
                    name: 'Stu',
                    points: 200,
                    selections: [
                        { type: 'Team to Win', name: 'Arsenal', id: 'ARS', team: 'Arsenal', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix1' },
                        { type: 'Player to Score', name: 'Bukayo Saka', id: 'saka', team: 'Arsenal', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix1' },
                        { type: 'Player to Assist', name: 'Martin Ødegaard', id: 'ode', team: 'Arsenal', status: 'in-play', outcome: 'pending', points: 0, fixtureId: 'fix1', liveMinute: 70 },
                        { type: 'Player to Get Card', name: 'Granit Xhaka', id: 'xhaka', team: 'Arsenal', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix1' },
                        { type: 'Clean Sheet', name: 'Chelsea', id: 'CHE', team: 'Chelsea', status: 'upcoming', outcome: 'pending', points: 0, fixtureId: 'fix4' }
                    ]
                },
                dave: {
                    name: 'Dave',
                    points: 150,
                    selections: [
                        { type: 'Team to Win', name: 'Man Utd', id: 'MUN', team: 'Man Utd', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix5' },
                        { type: 'Player to Score', name: 'Marcus Rashford', id: 'rashford', team: 'Man Utd', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix5' },
                        { type: 'Player to Assist', name: 'Bruno Fernandes', id: 'fernandes', team: 'Man Utd', status: 'in-play', outcome: 'correct', points: 50, fixtureId: 'fix5', liveMinute: 80 },
                        { type: 'Player to Get Card', name: 'Casemiro', id: 'casemiro', team: 'Man Utd', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix5' },
                        { type: 'Clean Sheet', name: 'Man City', id: 'MCI', team: 'Man City', status: 'upcoming', outcome: 'pending', points: 0, fixtureId: 'fix2' }
                    ]
                },
                si: {
                    name: 'Si',
                    points: 100,
                    selections: [
                        { type: 'Team to Win', name: 'Liverpool', id: 'LIV', team: 'Liverpool', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix3' },
                        { type: 'Player to Score', name: 'Darwin Núñez', id: 'nunez', team: 'Liverpool', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix3' },
                        { type: 'Player to Assist', name: 'Trent Alexander-Arnold', id: 'taa', team: 'Liverpool', status: 'in-play', outcome: 'correct', points: 50, fixtureId: 'fix3', liveMinute: 65 },
                        { type: 'Player to Get Card', name: 'Fabinho', id: 'fabinho', team: 'Liverpool', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix3' },
                        { type: 'Clean Sheet', name: 'Arsenal', id: 'ARS', team: 'Arsenal', status: 'upcoming', outcome: 'pending', points: 0, fixtureId: 'fix1' }
                    ]
                },
                anj: {
                    name: 'Anj',
                    points: 75,
                    selections: [
                        { type: 'Team to Win', name: 'Tottenham', id: 'TOT', team: 'Tottenham', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix5' },
                        { type: 'Player to Score', name: 'Harry Kane', id: 'kane', team: 'Tottenham', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix5' },
                        { type: 'Player to Assist', name: 'Son Heung-min', id: 'son', team: 'Tottenham', status: 'in-play', outcome: 'incorrect', points: 0, fixtureId: 'fix5', liveMinute: 55 },
                        { type: 'Player to Get Card', name: 'Cristian Romero', id: 'romero', team: 'Tottenham', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix5' },
                        { type: 'Clean Sheet', name: 'Man Utd', id: 'MUN', team: 'Man Utd', status: 'upcoming', outcome: 'pending', points: 0, fixtureId: 'fix5' }
                    ]
                },
                barry: {
                    name: 'Barry',
                    points: 50,
                    selections: [
                        { type: 'Team to Win', name: 'Aston Villa', id: 'AVL', team: 'Aston Villa', status: 'finished', outcome: 'correct', points: 50, fixtureId: 'fix4' },
                        { type: 'Player to Score', name: 'Ollie Watkins', id: 'watkins', team: 'Aston Villa', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix4' },
                        { type: 'Player to Assist', name: 'Douglas Luiz', id: 'douglas-luiz', team: 'Aston Villa', status: 'in-play', outcome: 'incorrect', points: 0, fixtureId: 'fix4', liveMinute: 40 },
                        { type: 'Player to Get Card', name: 'John McGinn', id: 'mcginn', team: 'Aston Villa', status: 'finished', outcome: 'incorrect', points: 0, fixtureId: 'fix4' },
                        { type: 'Clean Sheet', name: 'Liverpool', id: 'LIV', team: 'Liverpool', status: 'upcoming', outcome: 'pending', points: 0, fixtureId: 'fix3' }
                    ]
                }
            };


            // --- Screen Navigation ---
            function showScreen(screenId) {
                screens.forEach(screen => {
                    screen.classList.remove('active-screen');
                });
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.add('active-screen');
                    // Update URL hash without refreshing
                    window.history.pushState(null, '', `#${screenId}`);
                    // Scroll to top when navigating to a new screen
                    window.scrollTo(0, 0);
                } else {
                    console.error("Target screen not found:", screenId);
                }
            }

            // Handle initial screen load based on URL hash
            const initialHash = window.location.hash.substring(1);
            if (initialHash && document.getElementById(initialHash)) {
                showScreen(initialHash);
            } else {
                showScreen('homescreen'); // Default to homescreen
            }

            // Home icon button event listener
            if (homeIconBtn) {
                homeIconBtn.addEventListener('click', () => {
                    showScreen('homescreen');
                });
            }

            if (makeSelectionsBtn) {
                makeSelectionsBtn.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior
                    showScreen('selections');
                });
            }

            if (confirmAllSelectionsBtn) {
                confirmAllSelectionsBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    updateUserInPlaySelections(); // Populate user selections before showing in-play
                    showScreen('in-play');
                });
            }

            // --- Modal Logic ---
            selectionBtns.forEach(button => {
                button.addEventListener('click', () => {
                    const modalId = button.dataset.modal;
                    const modal = document.getElementById(modalId);

                    if (!modal) {
                        console.error("Modal not found for ID:", modalId);
                        return;
                    }

                    // Populate fixture list if it's a team selection modal
                    if (modalId === 'modal-teams-win' || modalId === 'modal-teams-cleansheet') {
                        // Pass the correct userSelections array based on modal type
                        const selectionArray = modalId === 'modal-teams-win' ? userSelections.teamsToWin : userSelections.teamsToCleanSheet;
                        populateTeamSelectionModal(modal, selectionArray);
                    } else if (modalId.startsWith('modal-players-')) {
                        // For player modals, populate based on the default active tab (Forwards)
                        // and set up tab listeners
                        const defaultPosition = 'Forwards';
                        populatePlayerListForPosition(modal, defaultPosition);
                        setupPlayerModalTabs(modal);
                    }

                    modal.style.display = 'block';

                    // Re-select selectItemBtns after dynamic content is potentially added
                    selectItemBtns = modal.querySelectorAll('.select-item-btn');

                    // Reset selected items and enable all select buttons in this modal
                    selectItemBtns.forEach(btn => {
                        btn.classList.remove('selected', 'disabled');
                        btn.textContent = 'Select'; // Reset to 'Select' text
                        // Remove icon if present
                        const icon = btn.querySelector('.material-icons');
                        if (icon) icon.remove();
                    });

                    // Set current selections in modal
                    // Determine the correct array based on modal ID for initial selection state
                    let currentSelectionsArray;
                    if (modalId === 'modal-teams-win') currentSelectionsArray = userSelections.teamsToWin;
                    else if (modalId === 'modal-players-score') currentSelectionsArray = userSelections.playersToScore;
                    else if (modalId === 'modal-players-assist') currentSelectionsArray = userSelections.playersToAssist;
                    else if (modalId === 'modal-players-card') currentSelectionsArray = userSelections.playersToCard;
                    else if (modalId === 'modal-teams-cleansheet') currentSelectionsArray = userSelections.teamsToCleanSheet;
                    else currentSelectionsArray = []; // Fallback to empty array

                    currentSelectionsArray.forEach(selectedItem => {
                        // Find the specific select button within the modal's list item
                        const itemElement = modal.querySelector(`[data-team-id="${selectedItem.id}"]`) || modal.querySelector(`[data-player-id="${selectedItem.id}"]`);
                        if (itemElement) {
                            const selectBtn = itemElement.querySelector('.select-item-btn');
                            if (selectBtn) {
                                selectBtn.classList.add('selected');
                                selectBtn.innerHTML = '<span class="material-icons">check</span> Selected'; // Add icon and text
                            }
                        }
                    });

                    // Update confirm button state on modal open
                    updateConfirmButtonState(modal);
                    // Re-attach event listeners for dynamically added select buttons
                    attachSelectItemListeners();
                });
            });

            closeButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const modal = event.target.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                        // Re-render the main selections screen to reflect changes
                        let targetSelectedItemsId;
                        let currentSelectionsArray;
                        let categoryForRender; // New variable for category string

                        // Correctly map modal ID to userSelections array
                        if (modal.id === 'modal-teams-win') {
                            targetSelectedItemsId = 'selected-teams-win';
                            currentSelectionsArray = userSelections.teamsToWin;
                            categoryForRender = 'teams-win';
                        } else if (modal.id === 'modal-players-score') {
                            targetSelectedItemsId = 'selected-players-score';
                            currentSelectionsArray = userSelections.playersToScore;
                            categoryForRender = 'players-score';
                        } else if (modal.id === 'modal-players-assist') {
                            targetSelectedItemsId = 'selected-players-assist';
                            currentSelectionsArray = userSelections.playersToAssist;
                            categoryForRender = 'players-assist';
                        } else if (modal.id === 'modal-players-card') {
                            targetSelectedItemsId = 'selected-players-card';
                            currentSelectionsArray = userSelections.playersToCard;
                            categoryForRender = 'players-card';
                        } else if (modal.id === 'modal-teams-cleansheet') {
                            targetSelectedItemsId = 'selected-teams-cleansheet';
                            currentSelectionsArray = userSelections.teamsToCleanSheet;
                            categoryForRender = 'teams-cleansheet';
                        } else {
                            console.error("Unknown modal ID for close button:", modal.id);
                            return;
                        }

                        const targetElementById = document.getElementById(targetSelectedItemsId);
                        // Only re-render if it's one of the selection modals
                        if (targetElementById) {
                            renderSelectedItems(currentSelectionsArray, targetElementById, categoryForRender);
                        }
                    }
                });
            });

            confirmModalBtns.forEach(button => {
                button.addEventListener('click', (event) => {
                    const modal = event.target.closest('.modal');
                    if (!modal) {
                        console.error("Modal not found for confirm button click.");
                        return;
                    }
                    modal.style.display = 'none';

                    let targetSelectedItemsId;
                    let currentSelectionsArray;
                    let categoryForRender; // New variable for category string

                    // Correctly map modal ID to userSelections array
                    if (modal.id === 'modal-teams-win') {
                        targetSelectedItemsId = 'selected-teams-win';
                        currentSelectionsArray = userSelections.teamsToWin;
                        categoryForRender = 'teams-win';
                    } else if (modal.id === 'modal-players-score') {
                        targetSelectedItemsId = 'selected-players-score';
                        currentSelectionsArray = userSelections.playersToScore;
                        categoryForRender = 'players-score';
                    } else if (modal.id === 'modal-players-assist') {
                        targetSelectedItemsId = 'selected-players-assist';
                        currentSelectionsArray = userSelections.playersToAssist;
                        categoryForRender = 'players-assist';
                    } else if (modal.id === 'modal-players-card') {
                        targetSelectedItemsId = 'selected-players-card';
                        currentSelectionsArray = userSelections.playersToCard;
                        categoryForRender = 'players-card';
                    } else if (modal.id === 'modal-teams-cleansheet') {
                        targetSelectedItemsId = 'selected-teams-cleansheet';
                        currentSelectionsArray = userSelections.teamsToCleanSheet;
                        categoryForRender = 'teams-cleansheet';
                    } else {
                        console.error("Unknown modal ID for confirm button:", modal.id);
                        return;
                    }
                    
                    const targetElementById = document.getElementById(targetSelectedItemsId);
                    renderSelectedItems(currentSelectionsArray, targetElementById, categoryForRender); // Re-render on confirm
                });
            });

            // Function to attach listeners to select item buttons (for dynamic content)
            function attachSelectItemListeners() {
                // Re-query all select item buttons to include newly added ones
                selectItemBtns = document.querySelectorAll('.select-item-btn');
                selectItemBtns.forEach(button => {
                    // Remove existing listener to prevent duplicates
                    button.removeEventListener('click', handleSelectItemClick);
                    // Add new listener
                    button.addEventListener('click', handleSelectItemClick);
                });
            }

            // Handler for select item buttons
            function handleSelectItemClick(event) {
                // Find the closest parent that holds the data- attributes for the item
                const itemElement = event.target.closest('.team-item') || event.target.closest('.player-item') || event.target.closest('.fixture-team-selection-row');
                const modal = event.target.closest('.modal');

                if (!modal) {
                    console.error("Modal not found for selection button click. Event target:", event.target);
                    return;
                }
                if (!itemElement) {
                    console.error("Item element not found for selection button click. Event target:", event.target);
                    return;
                }

                const selectBtn = event.target;

                let maxSelections = 3;

                let currentSelectionsArray = null; // Initialize to null
                // Use explicit modal IDs to map to userSelections arrays
                if (modal.id === 'modal-teams-win') currentSelectionsArray = userSelections.teamsToWin;
                else if (modal.id === 'modal-players-score') currentSelectionsArray = userSelections.playersToScore;
                else if (modal.id === 'modal-players-assist') currentSelectionsArray = userSelections.playersToAssist;
                else if (modal.id === 'modal-players-card') currentSelectionsArray = userSelections.playersToCard;
                else if (modal.id === 'modal-teams-cleansheet') currentSelectionsArray = userSelections.teamsToCleanSheet;
                else {
                    console.error("Unknown modal ID for handleSelectItemClick:", modal.id);
                    return; // Exit if modal ID is unknown
                }

                // Ensure currentSelectionsArray is an array before proceeding
                if (!Array.isArray(currentSelectionsArray)) {
                    console.error("currentSelectionsArray is not an array for modal ID:", modal.id);
                    return; // Exit the function to prevent further errors
                }


                let itemId, itemName, itemColor, itemAbbr, fixtureId, itemTeam;

                // Determine item details based on whether it's a team selection row or a player item
                if (itemElement.dataset.teamId) { // It's a team item
                    itemId = itemElement.dataset.teamId;
                    itemName = itemElement.dataset.teamName;
                    itemColor = teamData[itemName] ? teamData[itemName].color : '#888888'; // Ensure color is fetched from teamData
                    itemAbbr = teamData[itemName] ? teamData[itemName].abbr : 'N/A'; // Ensure abbr is fetched from teamData
                    itemTeam = itemName; // For teams, the team name is the itemTeam
                    // Find the fixture ID associated with this team
                    const fixture = week38Fixtures.find(f => f.home === itemName || f.away === itemName);
                    fixtureId = fixture ? fixture.id : null;
                } else if (itemElement.dataset.playerId) { // It's a player item
                    itemId = itemElement.dataset.playerId;
                    itemName = itemElement.dataset.playerName;
                    itemTeam = itemElement.dataset.playerTeam; // Get player's team name
                    
                    if (teamData[itemTeam]) {
                        itemColor = teamData[itemTeam].color;
                        itemAbbr = teamData[itemTeam].abbr;
                    } else {
                        itemColor = '#888888'; // Default grey if team data not found
                        itemAbbr = 'N/A';
                    }
                    // Find the fixture ID associated with this player's team
                    const playerTeamFixture = week38Fixtures.find(f => f.home === itemTeam || f.away === itemTeam);
                    fixtureId = playerTeamFixture ? playerTeamFixture.id : null;
                }

                const existingIndex = currentSelectionsArray.findIndex(item => item.id === itemId);

                if (existingIndex > -1) {
                    // Deselect item
                    currentSelectionsArray.splice(existingIndex, 1);
                    selectBtn.classList.remove('selected');
                    selectBtn.innerHTML = 'Select'; // Reset text
                    // Re-enable other disabled buttons if max selections was reached and this one was deselected
                    const disabledButtonsInModal = modal.querySelectorAll('.select-item-btn.disabled');
                    if (disabledButtonsInModal) {
                        disabledButtonsInModal.forEach(btn => {
                            btn.classList.remove('disabled');
                        });
                    }
                } else if (currentSelectionsArray.length < maxSelections) {
                    // Select item
                    currentSelectionsArray.push({ id: itemId, name: itemName, color: itemColor, abbr: itemAbbr, fixtureId: fixtureId, team: itemTeam });
                    selectBtn.classList.add('selected');
                    selectBtn.innerHTML = '<span class="material-icons">check</span> Selected'; // Add icon and text
                }

                updateModalButtonStates(modal, currentSelectionsArray.length, maxSelections);
                updateConfirmButtonState(modal);
            }


            function updateModalButtonStates(modal, currentCount, maxAllowed) {
                if (!modal) {
                    console.error("updateModalButtonStates: 'modal' argument is null or undefined.");
                    return;
                }
                const selectButtonsInModal = modal.querySelectorAll('.select-item-btn');
                selectButtonsInModal.forEach(btn => {
                    if (!btn.classList.contains('selected') && currentCount >= maxAllowed) {
                        btn.classList.add('disabled');
                    } else {
                        btn.classList.remove('disabled');
                    }
                });
            }

            function updateConfirmButtonState(modal) {
                const confirmButton = modal.querySelector('.confirm-modal-btn');
                if (!confirmButton) return;

                let currentSelectionsArray = null; // Initialize to null
                // Use explicit modal IDs to map to userSelections arrays
                if (modal.id === 'modal-teams-win') currentSelectionsArray = userSelections.teamsToWin;
                else if (modal.id === 'modal-players-score') currentSelectionsArray = userSelections.playersToScore;
                else if (modal.id === 'modal-players-assist') currentSelectionsArray = userSelections.playersToAssist;
                else if (modal.id === 'modal-players-card') currentSelectionsArray = userSelections.playersToCard;
                else if (modal.id === 'modal-teams-cleansheet') currentSelectionsArray = userSelections.teamsToCleanSheet;
                else {
                    console.error("Unknown modal ID for confirm button:", modal.id);
                    return;
                }

                // Ensure currentSelectionsArray is an array before proceeding
                if (!Array.isArray(currentSelectionsArray)) {
                    console.error("currentSelectionsArray is not an array for confirm button, modal ID:", modal.id);
                    return; // Exit the function to prevent further errors
                }

                if (currentSelectionsArray && currentSelectionsArray.length === 3) {
                    confirmButton.classList.add('active');
                } else {
                    confirmButton.classList.remove('active');
                }
            }

            function renderSelectedItems(itemsArray, targetElement, category) {
                if (!targetElement) {
                    console.error('Error: Target element is null for category:', category);
                    return;
                }
                targetElement.innerHTML = ''; // Clear existing

                if (itemsArray.length === 0) {
                    targetElement.classList.add('empty-selection-display');
                    return;
                } else {
                    targetElement.classList.remove('empty-selection-display');
                }


                itemsArray.forEach(item => {
                    const itemTag = document.createElement('span');
                    itemTag.classList.add('selected-item-tag');

                    // Always create team-circle for both teams and players
                    const teamCircle = document.createElement('div');
                    teamCircle.classList.add('team-circle');
                    teamCircle.style.backgroundColor = item.color || '#888888'; // Default grey if no color
                    teamCircle.textContent = item.abbr || 'N/A'; // Default N/A if no abbr
                    itemTag.appendChild(teamCircle);

                    const itemNameSpan = document.createElement('span');
                    itemNameSpan.textContent = item.name;
                    itemTag.appendChild(itemNameSpan);

                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('remove-btn');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = `Remove ${item.name}`;
                    removeBtn.addEventListener('click', () => {
                        const index = itemsArray.findIndex(selected => selected.id === item.id);
                        if (index > -1) {
                            itemsArray.splice(index, 1);
                        }
                        renderSelectedItems(itemsArray, targetElement, category); // Re-render on remove
                        // Also update modal state if it's currently open and corresponds to this category
                        const modalId = `modal-${category.toLowerCase().replace('teams-', 'teams-').replace('players-', 'players-')}`;
                        const openModal = document.getElementById(modalId);
                        if (openModal && openModal.style.display === 'block') {
                             // Find the corresponding select button in the modal and reset its state
                            const itemInModal = openModal.querySelector(`[data-team-id="${item.id}"]`) || openModal.querySelector(`[data-player-id="${item.id}"]`);
                            if (itemInModal) {
                                const selectBtnInModal = itemInModal.querySelector('.select-item-btn');
                                if (selectBtnInModal) {
                                    selectBtnInModal.classList.remove('selected');
                                    selectBtnInModal.innerHTML = 'Select'; // Reset text
                                }
                            }
                            updateModalButtonStates(openModal, itemsArray.length, 3);
                            updateConfirmButtonState(openModal);
                        }
                    });
                    itemTag.appendChild(removeBtn);

                    targetElement.appendChild(itemTag);
                });
            }

            // Function to populate team selection modals with fixture view
            function populateTeamSelectionModal(modal) {
                const teamListContainer = modal.querySelector('.team-list');
                if (!teamListContainer) return;

                teamListContainer.innerHTML = ''; // Clear existing content

                week38Fixtures.forEach((fixture) => {
                    const fixtureGroup = document.createElement('div');
                    fixtureGroup.classList.add('fixture-group');

                    // Home Team Selection Row
                    const homeTeamSelectionRow = document.createElement('div');
                    homeTeamSelectionRow.classList.add('fixture-team-selection-row', 'team-item');
                    homeTeamSelectionRow.dataset.teamId = teamData[fixture.home].abbr;
                    homeTeamSelectionRow.dataset.teamName = fixture.home;
                    homeTeamSelectionRow.dataset.teamColor = teamData[fixture.home].color;
                    homeTeamSelectionRow.dataset.teamAbbr = teamData[fixture.home].abbr;
                    homeTeamSelectionRow.innerHTML = `
                        <div class="team-name-with-position">
                            <div class="team-circle" style="background-color: ${teamData[fixture.home].color};">${teamData[fixture.home].abbr}</div>
                            <span>${fixture.home}</span>
                            <span class="team-position">(${teamData[fixture.home].position})</span>
                        </div>
                        <button class="btn select-item-btn">Select</button>
                    `;
                    fixtureGroup.appendChild(homeTeamSelectionRow);

                    // Away Team Selection Row
                    const awayTeamSelectionRow = document.createElement('div');
                    awayTeamSelectionRow.classList.add('fixture-team-selection-row', 'team-item');
                    awayTeamSelectionRow.dataset.teamId = teamData[fixture.away].abbr;
                    awayTeamSelectionRow.dataset.teamName = fixture.away;
                    awayTeamSelectionRow.dataset.teamColor = teamData[fixture.away].color;
                    awayTeamSelectionRow.dataset.teamAbbr = teamData[fixture.away].abbr;
                    awayTeamSelectionRow.innerHTML = `
                        <div class="team-name-with-position">
                            <div class="team-circle" style="background-color: ${teamData[fixture.away].color};">${teamData[fixture.away].abbr}</div>
                            <span>${fixture.away}</span>
                            <span class="team-position">(${teamData[fixture.away].position})</span>
                        </div>
                        <button class="btn select-item-btn">Select</button>
                    `;
                    fixtureGroup.appendChild(awayTeamSelectionRow);

                    teamListContainer.appendChild(fixtureGroup);
                });
            }

            // Function to populate player selection modals with stats and handle tabs
            function populatePlayerListForPosition(modal, position) {
                const playerListContainer = modal.querySelector('.player-list');
                if (!playerListContainer) return;

                playerListContainer.innerHTML = ''; // Clear existing content

                // Ensure allPlayers is an array before filtering
                const playersForPosition = Array.isArray(allPlayers) ? allPlayers.filter(player => player.position === position) : [];

                playersForPosition.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.classList.add('player-item');
                    playerItem.dataset.playerId = player.id;
                    playerItem.dataset.playerName = player.name;
                    playerItem.dataset.playerTeam = player.team; // Store team name for lookup

                    const teamCircleColor = teamData[player.team] ? teamData[player.team].color : '#888888';
                    const teamCircleAbbr = teamData[player.team] ? teamData[player.team].abbr : 'N/A';

                    let statText = '';
                    if (modal.id === 'modal-players-score') {
                        statText = `Goals: ${player.stats.goals || 0}`;
                    } else if (modal.id === 'modal-players-assist') {
                        statText = `Assists: ${player.stats.assists || 0}`;
                    } else if (modal.id === 'modal-players-card') {
                        statText = `Cards: ${player.stats.cards || 0}`;
                    }

                    playerItem.innerHTML = `
                        <div class="player-item-details">
                            <div class="team-circle" style="background-color: ${teamCircleColor};">${teamCircleAbbr}</div>
                            <span>${player.name}</span>
                            <!-- Removed player position column as requested -->
                        </div>
                        <span class="player-stat">${statText}</span>
                        <button class="btn select-item-btn">Select</button>
                    `;
                    playerListContainer.appendChild(playerItem);
                });

                // After populating, re-apply selected states and button states
                let currentSelectionsArray;
                if (modal.id === 'modal-players-score') currentSelectionsArray = userSelections.playersToScore;
                else if (modal.id === 'modal-players-assist') currentSelectionsArray = userSelections.playersToAssist;
                else if (modal.id === 'modal-players-card') currentSelectionsArray = userSelections.playersToCard;
                else currentSelectionsArray = []; // Ensure it's an array even if category doesn't match

                currentSelectionsArray.forEach(selectedItem => {
                    const itemElement = playerListContainer.querySelector(`[data-player-id="${selectedItem.id}"]`);
                    if (itemElement) {
                        const selectBtn = itemElement.querySelector('.select-item-btn');
                        if (selectBtn) {
                            selectBtn.classList.add('selected');
                            selectBtn.innerHTML = '<span class="material-icons">check</span> Selected';
                        }
                    }
                });
                updateModalButtonStates(modal, currentSelectionsArray.length, 3);
                attachSelectItemListeners(); // Re-attach listeners for newly created buttons
            }

            function setupPlayerModalTabs(modal) {
                const tabButtons = modal.querySelectorAll('.player-position-tabs .tab-btn');
                tabButtons.forEach(tabBtn => {
                    tabBtn.removeEventListener('click', handlePlayerTabClick); // Prevent duplicate listeners
                    tabBtn.addEventListener('click', handlePlayerTabClick);
                });

                // Set initial active tab
                const firstTab = tabButtons[0];
                if (firstTab && !firstTab.classList.contains('active')) {
                    firstTab.classList.add('active');
                }
                const playerList = modal.querySelector('.player-list');
                if (playerList) {
                    playerList.dataset.currentPosition = firstTab.dataset.position; // Set initial position
                }
            }

            function handlePlayerTabClick(event) {
                const clickedTab = event.target;
                const modal = clickedTab.closest('.modal');
                if (!modal) return;

                modal.querySelectorAll('.player-position-tabs .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                clickedTab.classList.add('active');

                const position = clickedTab.dataset.position;
                populatePlayerListForPosition(modal, position);
            }


            // Initialize all selected items displays on page load
            renderSelectedItems(userSelections.teamsToWin, document.getElementById('selected-teams-win'), 'teams-win');
            renderSelectedItems(userSelections.playersToScore, document.getElementById('selected-players-score'), 'players-score');
            renderSelectedItems(userSelections.playersToAssist, document.getElementById('selected-players-assist'), 'players-assist');
            renderSelectedItems(userSelections.playersToCard, document.getElementById('selected-players-card'), 'players-card');
            renderSelectedItems(userSelections.teamsToCleanSheet, document.getElementById('selected-teams-cleansheet'), 'teams-cleansheet');


            // --- Function to create an in-play/leaderboard item HTML ---
            const createInPlayItemHtml = (name, teamName, statusClass, outcome, points, fixtureInfoHtml) => {
                const outcomeIconHtml = outcome === 'correct' ? '<span class="material-icons outcome-icon correct-icon">check_circle</span>' :
                                        outcome === 'incorrect' ? '<span class="material-icons outcome-icon incorrect-icon">cancel</span>' : '';
                
                // Get team data for crest
                const teamCrestColor = teamData[teamName] ? teamData[teamName].color : '#888888';
                const teamCrestAbbr = teamData[teamName] ? teamData[teamName].abbr : 'N/A';
                const teamCrestHtml = `
                    <div class="team-crest-small" style="background-color: ${teamCrestColor};">
                        ${teamCrestAbbr}
                    </div>
                `;

                return `
                    <div class="selection-item">
                        <div class="selection-main-details">
                            <div class="selection-details">
                                <strong>${teamCrestHtml}${name}</strong>
                                <!-- Removed status tag as requested -->
                                <span class="outcome ${outcome}">${outcome === 'correct' ? 'Correct!' : (outcome === 'incorrect' ? 'Incorrect.' : 'Pending...')}${outcomeIconHtml}</span>
                            </div>
                            <span class="points">${points}pts</span>
                        </div>
                        <div class="fixture-info">
                            ${fixtureInfoHtml}
                        </div>
                    </div>
                `;
            };


            // --- In-Play Screen User Selections & Leaderboard Logic ---
            function updateUserInPlaySelections() {
                const inPlayContainer = document.getElementById('user-in-play-selections');
                if (!inPlayContainer) {
                    console.error("In-play container not found.");
                    return;
                }
                inPlayContainer.innerHTML = ''; // Clear existing dummy data

                let totalUserPoints = 0;

                const categories = [
                    { title: 'Teams to win', key: 'teamsToWin' },
                    { title: 'Players to score', key: 'playersToScore' },
                    { title: 'Players to assist', key: 'playersToAssist' },
                    { title: 'Players to get card', key: 'playersToCard' },
                    { title: 'Clean sheets', key: 'teamsToCleanSheet' }
                ];

                categories.forEach(category => {
                    const categoryGroup = document.createElement('div');
                    categoryGroup.classList.add('selection-category-group');
                    
                    const categoryTitle = document.createElement('h3');
                    categoryTitle.textContent = category.title;
                    categoryGroup.appendChild(categoryTitle);

                    const gridContainer = document.createElement('div');
                    gridContainer.classList.add('selection-status-grid');
                    categoryGroup.appendChild(gridContainer);

                    const selections = userSelections[category.key];

                    if (selections.length === 0) {
                        gridContainer.innerHTML = '<p style="text-align: center; color: #C0C0C0; margin-top: 10px;">No selections made.</p>';
                    } else {
                        selections.forEach(item => {
                            const fixtureResult = item.fixtureId ? mockResults[item.fixtureId] : null;
                            let statusClass = 'upcoming'; // Still need statusClass for internal logic, even if not displayed
                            let outcome = 'pending';
                            let points = 0;
                            let fixtureInfoHtml = 'Fixture details unavailable.';
                            let itemTeamName = item.team; // Get the team name for the crest

                            if (fixtureResult) {
                                if (fixtureResult.status === 'in-play') {
                                    statusClass = 'in-play';
                                    const liveMinute = (category.key.startsWith('players') && mockResults[item.id] && mockResults[item.id].liveMinute) ? mockResults[item.id].liveMinute : '?';
                                    fixtureInfoHtml = `<strong>${fixtureResult.home}</strong> vs <strong>${fixtureResult.away}</strong> (Live: ${liveMinute}')`;
                                } else if (fixtureResult.status === 'finished') {
                                    statusClass = 'finished';
                                    fixtureInfoHtml = `<strong>${fixtureResult.home}</strong> vs <strong>${fixtureResult.away}</strong> (Finished: ${fixtureResult.homeScore}-${fixtureResult.awayScore})`;
                                } else {
                                     fixtureInfoHtml = `<strong>${fixtureResult.home}</strong> vs <strong>${fixtureResult.away}</strong> (Upcoming)`;
                                }

                                if (fixtureResult.status === 'finished') {
                                    if (category.key === 'teamsToWin') {
                                        if (fixtureResult.won === item.name) {
                                            outcome = 'correct';
                                            points = 50;
                                        } else {
                                            outcome = 'incorrect';
                                        }
                                    } else if (category.key.startsWith('players')) {
                                        const playerOutcome = mockResults[item.id];
                                        if (playerOutcome) {
                                            if ((category.key === 'playersToScore' && playerOutcome.scored) ||
                                                (category.key === 'playersToAssist' && playerOutcome.assisted) ||
                                                (category.key === 'playersToCard' && playerOutcome.card)) {
                                                outcome = 'correct';
                                                points = 50;
                                            } else {
                                                outcome = 'incorrect';
                                            }
                                        } else {
                                            outcome = 'incorrect'; // No mock data for this player
                                        }
                                    } else if (category.key === 'teamsToCleanSheet') {
                                        const selectedTeamKeptCleanSheet = (fixtureResult.home === item.name && fixtureResult.awayScore === 0) ||
                                                                           (fixtureResult.away === item.name && fixtureResult.homeScore === 0);
                                        if (selectedTeamKeptCleanSheet) {
                                            outcome = 'correct';
                                            points = 50;
                                        } else {
                                            outcome = 'incorrect';
                                        }
                                    }
                                }
                            }
                            gridContainer.innerHTML += createInPlayItemHtml(item.name, itemTeamName, statusClass, outcome, points, fixtureInfoHtml);
                        });
                    }
                    inPlayContainer.appendChild(categoryGroup);
                });


                const totalPointsValueElement = document.querySelector('#selections-tab .total-points-value');
                if (totalPointsValueElement) {
                    totalPointsValueElement.textContent = `${totalUserPoints}pts`;
                }
            }


            // --- Leaderboard Modal Logic ---
            leaderboardViewBtns.forEach(button => {
                button.addEventListener('click', (event) => {
                    const userId = event.currentTarget.dataset.user;
                    const userData = leaderboardData[userId];

                    if (userData) {
                        userSelectionsModalTitle.textContent = `${userData.name}'s Selections`;
                        userSelectionsModalTotalPoints.textContent = `${userData.points}pts`;
                        userSelectionsModalContent.innerHTML = ''; // Clear previous content

                        const categories = [
                            { title: 'Teams to win', typePrefix: 'Team to Win' },
                            { title: 'Players to score', typePrefix: 'Player to Score' },
                            { title: 'Players to assist', typePrefix: 'Player to Assist' },
                            { title: 'Players to get card', typePrefix: 'Player to Get Card' },
                            { title: 'Clean sheets', typePrefix: 'Clean Sheet' }
                        ];

                        categories.forEach(categoryInfo => {
                            const categoryGroup = document.createElement('div');
                            categoryGroup.classList.add('selection-category-group');
                            
                            const categoryTitle = document.createElement('h3');
                            categoryTitle.textContent = categoryInfo.title;
                            categoryGroup.appendChild(categoryTitle);

                            const gridContainer = document.createElement('div');
                            gridContainer.classList.add('selection-status-grid');
                            categoryGroup.appendChild(gridContainer);

                            const selectionsForCategory = userData.selections.filter(s => s.type === categoryInfo.typePrefix);

                            if (selectionsForCategory.length === 0) {
                                gridContainer.innerHTML = '<p style="text-align: center; color: #C0C0C0; margin-top: 10px;">No selections made.</p>';
                            } else {
                                selectionsForCategory.forEach(selection => {
                                    const fixtureResult = selection.fixtureId ? mockResults[selection.fixtureId] : null;

                                    let statusClass = selection.status; // Keep original status class for internal logic
                                    let fixtureInfoHtml = 'Fixture details unavailable.';
                                    let itemTeamName = selection.team; // Get the team name for the crest

                                    if (fixtureResult) {
                                        if (fixtureResult.status === 'finished') {
                                            fixtureInfoHtml = `<strong>${fixtureResult.home}</strong> vs <strong>${fixtureResult.away}</strong> (Finished: ${fixtureResult.homeScore}-${fixtureResult.awayScore})`;
                                        } else if (fixtureResult.status === 'in-play') {
                                            fixtureInfoHtml = `<strong>${fixtureResult.home}</strong> vs <strong>${fixtureResult.away}</strong> (Live: ${selection.liveMinute || '?'}')`;
                                        } else {
                                            fixtureInfoHtml = `<strong>${fixtureResult.home}</strong> vs <strong>${fixtureResult.away}</strong> (Upcoming)`;
                                        }
                                    }
                                    // Reuse the shared createInPlayItemHtml function
                                    gridContainer.innerHTML += createInPlayItemHtml(selection.name, itemTeamName, statusClass, selection.outcome, selection.points, fixtureInfoHtml);
                                });
                            }
                            userSelectionsModalContent.appendChild(categoryGroup);
                        });
                        userSelectionsModal.style.display = 'block';
                    }
                });
            });

            if (userSelectionsModal.querySelector('.close-button')) {
                userSelectionsModal.querySelector('.close-button').addEventListener('click', () => {
                    userSelectionsModal.style.display = 'none';
                });
            }

            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                    // If a modal is closed by clicking outside, re-render the main selections screen
                    const modalId = event.target.id;
                    let targetSelectedItemsId;
                    let currentSelectionsArray;
                    let categoryForRender;

                    if (modalId === 'modal-teams-win') {
                        targetSelectedItemsId = 'selected-teams-win';
                        currentSelectionsArray = userSelections.teamsToWin;
                        categoryForRender = 'teams-win';
                    } else if (modalId === 'modal-players-score') {
                        targetSelectedItemsId = 'selected-players-score';
                        currentSelectionsArray = userSelections.playersToScore;
                        categoryForRender = 'players-score';
                    } else if (modalId === 'modal-players-assist') {
                        targetSelectedItemsId = 'selected-players-assist';
                        currentSelectionsArray = userSelections.playersToAssist;
                        categoryForRender = 'players-assist';
                    } else if (modalId === 'modal-players-card') {
                        targetSelectedItemsId = 'selected-players-card';
                        currentSelectionsArray = userSelections.playersToCard;
                        categoryForRender = 'players-card';
                    } else if (modalId === 'modal-teams-cleansheet') {
                        targetSelectedItemsId = 'selected-teams-cleansheet';
                        currentSelectionsArray = userSelections.teamsToCleanSheet;
                        categoryForRender = 'teams-cleansheet';
                    } else {
                        console.error("Unknown modal ID for window click close:", modalId);
                        return;
                    }
                    
                    const targetElementById = document.getElementById(targetSelectedItemsId);
                    // Only re-render if it's one of the selection modals
                    if (targetElementById) {
                        renderSelectedItems(currentSelectionsArray, targetElementById, categoryForRender);
                    }
                }
            });

            // --- In-Play Screen Tabs Logic ---
            const inPlayTabs = document.querySelectorAll('.in-play-tabs .tab-btn');
            const inPlayTabContents = document.querySelectorAll('.tab-content');

            inPlayTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    inPlayTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    inPlayTabContents.forEach(content => content.classList.remove('active-tab-content'));
                    document.getElementById(tab.dataset.tab).classList.add('active-tab-content');
                });
            });


            // Initial population of team selection modals (hidden by default, but ready)
            populateTeamSelectionModal(document.getElementById('modal-teams-win'));
            populateTeamSelectionModal(document.getElementById('modal-teams-cleansheet'));

            // Initial population of player selection modals (hidden by default, but ready)
            // Note: These will be populated with 'Forwards' by default when opened due to event listener logic
            // populatePlayerSelectionModal(document.getElementById('modal-players-score'));
            // populatePlayerSelectionModal(document.getElementById('modal-players-assist'));
            // populatePlayerSelectionModal(document.getElementById('modal-players-card'));


            // Attach listeners to newly created elements after initial population
            attachSelectItemListeners();
        });
    </script>
</body>
</html>
